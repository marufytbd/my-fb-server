<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CNC FB Home</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      background: #f0f2f5;
      font-family: 'Roboto', Arial, sans-serif;
      margin: 0;
      padding: 0;
      color: #050505;
    }
    .fb-topbar {
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 12px;
      height: 56px;
      border-bottom: 1px solid #e4e6eb;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .fb-topbar .logo {
      display: flex;
      align-items: center;
      font-size: 2rem;
      font-weight: bold;
      color: #1877f2;
      letter-spacing: -1px;
      font-family: 'Roboto', Arial, sans-serif;
    }
    .fb-topbar .logo img {
      width: 36px; height: 36px; margin-right: 6px;
      border-radius: 50%;
    }
    .fb-topbar .top-icons {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .fb-topbar .icon-btn {
      background: none;
      border-radius: 50%;
      width: 40px; height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      border: none;
      cursor: pointer;
      padding: 0;
      transition: background 0.15s;
    }
    .fb-topbar .icon-btn:hover svg {
      filter: brightness(0.7) drop-shadow(0 2px 6px rgba(24,119,242,0.10));
      transform: scale(1.08);
    }
    .fb-topbar .icon-btn svg {
      transition: filter 0.18s, transform 0.18s;
    }
    .fb-topbar .icon-btn .badge {
      position: absolute;
      top: 6px; right: 6px;
      background: #f02849;
      color: #fff;
      font-size: 11px;
      border-radius: 10px;
      padding: 0 5px;
      min-width: 18px;
      height: 18px;
      line-height: 18px;
      font-weight: bold;
      display: inline-block;
      box-shadow: 0 1px 2px rgba(0,0,0,0.08);
    }
    .fb-main {
      max-width: 500px;
      margin: 0 auto 70px auto;
      padding-bottom: 16px;
    }
    .fb-whats-mind {
      background: #fff;
      display: flex;
      align-items: center;
      padding: 12px 12px 12px 12px;
      border-bottom: 1px solid #e4e6eb;
    }
    .fb-whats-mind .profile-pic {
      width: 40px; height: 40px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 10px;
    }
    .fb-whats-mind .mind-input {
      flex: 1;
      background: #f0f2f5;
      border-radius: 20px;
      border: none;
      padding: 10px 16px;
      font-size: 16px;
      color: #65676b;
      outline: none;
      margin-right: 8px;
    }
    .fb-whats-mind .img-upload-btn {
      background: none;
      border: none;
      padding: 0;
      margin-left: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    .fb-whats-mind .img-upload-btn svg {
      width: 28px; height: 28px;
      color: #65676b;
    }
    .fb-stories {
      background: #fff;
      display: flex;
      align-items: flex-end;
      gap: 8px;
      padding: 12px 0 12px 12px;
      overflow-x: auto;
      border-bottom: 1px solid #e4e6eb;
    }
    .fb-story {
      width: 90px;
      min-width: 90px;
      height: 160px;
      background: #f0f2f5;
      border-radius: 16px;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
      overflow: hidden;
    }
    .fb-story .story-img {
      width: 100%; height: 100%; object-fit: cover;
      position: absolute; top: 0; left: 0;
      z-index: 1;
    }
    .fb-story .story-profile {
      width: 36px; height: 36px;
      border-radius: 50%;
      border: 3px solid #1877f2;
      object-fit: cover;
      position: absolute;
      top: 8px; left: 8px;
      z-index: 2;
      background: #fff;
    }
    .fb-story .story-add {
      width: 36px; height: 36px;
      border-radius: 50%;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      top: 8px; left: 8px;
      z-index: 2;
      border: 3px solid #1877f2;
    }
    .fb-story .story-add svg {
      color: #1877f2;
      width: 22px; height: 22px;
    }
    .fb-story .story-name {
      position: absolute;
      bottom: 8px; left: 8px; right: 8px;
      color: #fff;
      font-size: 14px;
      font-weight: 500;
      text-shadow: 0 1px 2px rgba(0,0,0,0.25);
      z-index: 2;
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .fb-story.create {
      background: #fff;
      border: 1.5px solid #e4e6eb;
      box-shadow: none;
      justify-content: flex-end;
    }
    .fb-story.create .story-add {
      background: #1877f2;
      border: 3px solid #fff;
      left: 50%;
      transform: translateX(-50%);
      top: 16px;
    }
    .fb-story.create .story-add svg {
      color: #fff;
    }
    .fb-story.create .story-name {
      color: #050505;
      font-weight: 500;
      text-shadow: none;
      left: 0; right: 0;
      text-align: center;
      bottom: 12px;
    }
    .fb-feed {
      margin-top: 8px;
    }
    .fb-post {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
      margin-bottom: 12px;
      padding: 12px 12px 0 12px;
    }
    .fb-post-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .fb-post-header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .fb-post-profile {
      width: 40px; height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
    .fb-post-info {
      display: flex;
      flex-direction: column;
    }
    .fb-post-name {
      font-weight: 500;
      font-size: 15px;
    }
    .fb-post-meta {
      font-size: 13px;
      color: #65676b;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .fb-post-header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .fb-post-header-right .icon-btn {
      background: none;
      border: none;
      padding: 4px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .fb-post-header-right .icon-btn:hover {
      background: #f0f2f5;
    }
    .fb-post-text {
      font-size: 16px;
      margin: 10px 0 8px 0;
      font-family: 'Roboto', Arial, 'Noto Sans Bengali', 'SolaimanLipi', 'Hind Siliguri', sans-serif;
    }
    .fb-post-reactions {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 15px;
      color: #65676b;
      margin-bottom: 4px;
    }
    .fb-post-reactions .emoji {
      font-size: 18px;
      margin-right: 2px;
    }
    .fb-post-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-top: 1px solid #e4e6eb;
      margin-top: 6px;
      padding: 2px 0 2px 0;
    }
    .fb-post-action {
      flex: 1;
      text-align: center;
      color: #65676b;
      font-size: 15px;
      background: none;
      border: none;
      padding: 8px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border-radius: 6px;
      cursor: pointer;
    }
    .fb-post-action:hover {
      background: #f0f2f5;
    }
    .fb-people-may-know {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
      margin-bottom: 12px;
      padding: 12px 12px 0 12px;
    }
    .fb-people-may-know-title {
      font-weight: 500;
      font-size: 16px;
      margin-bottom: 8px;
    }
    .fb-people-list {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 12px;
    }
    .fb-people-card {
      width: 120px;
      min-width: 120px;
      background: #f0f2f5;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px 0 8px 0;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    .fb-people-card img {
      width: 70px; height: 70px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 6px;
    }
    .fb-people-card .name {
      font-size: 15px;
      font-weight: 500;
      margin-bottom: 4px;
      text-align: center;
    }
    .fb-bottom-nav {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      height: 60px;
      background: #fff;
      border-top: 1px solid #dddfe2;
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 100;
    }
    .fb-bottom-nav .nav-item {
      flex: 1;
      text-align: center;
      color: #65676b;
      font-size: 12px;
      text-decoration: none;
      position: relative;
      padding-top: 4px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
    }
    .fb-bottom-nav .nav-item svg {
      display: block;
      margin: 0 auto 2px auto;
    }
    .fb-bottom-nav .nav-item.active svg path,
    .fb-bottom-nav .nav-item.active svg rect,
    .fb-bottom-nav .nav-item.active svg circle {
      fill: #1877f2 !important;
    }
    .fb-bottom-nav .nav-item.active span {
      color: #1877f2;
      font-weight: bold;
    }
    .fb-bottom-nav .nav-item.active {
      border-top: 3px solid #1877f2;
      color: #1877f2;
    }
    .fb-bottom-nav .nav-item .badge {
      position: absolute;
      top: 2px; right: 18px;
      background: #f02849;
      color: #fff;
      font-size: 10px;
      border-radius: 10px;
      padding: 0 5px;
      min-width: 18px;
      height: 18px;
      line-height: 18px;
      font-weight: bold;
      display: inline-block;
      box-shadow: 0 1px 2px rgba(0,0,0,0.08);
    }
    .fb-bottom-nav .menu-pic {
      width: 28px; height: 28px;
      border-radius: 50%;
      border: 2px solid #1877f2;
      object-fit: cover;
      margin-bottom: 2px;
    }
    .post-menu-btn {
      background: none; border: none; cursor: pointer; padding: 4px; border-radius: 50%;
      font-size: 22px; color: #65676b; position: relative;
    }
    .post-menu-btn:hover { background: #f0f2f5; }
    .post-menu-modal {
      position: fixed; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.18); z-index: 9999;
      display: flex; align-items: flex-end; justify-content: center;
    }
    .post-menu-sheet {
      background: #fff; width: 100%; max-width: 420px; border-radius: 18px 18px 0 0; box-shadow: 0 2px 16px rgba(0,0,0,0.10);
      padding: 16px 0 8px 0; margin-bottom: 0; animation: slideUp .2s;
    }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .post-menu-sheet button {
      width: 100%; background: none; border: none; text-align: left; font-size: 17px; padding: 12px 24px; display: flex; align-items: center; gap: 12px; color: #222; cursor: pointer;
    }
    .post-menu-sheet button:hover { background: #f0f2f5; }
    .post-menu-sheet .danger { color: #f02849; }
    .post-menu-sheet .icon { font-size: 20px; width: 24px; text-align: center; }
    .post-menu-sheet .sheet-divider { height: 1px; background: #eee; margin: 6px 0; }
    .post-menu-sheet .sheet-label { color: #888; font-size: 14px; padding: 0 24px 8px 24px; }
    .post-menu-sheet .sheet-bottom { padding: 8px 0 0 0; text-align: center; }
    @media (max-width: 600px) {
      .fb-main {
        max-width: 100vw;
      }
      .fb-bottom-nav {
        height: 56px;
      }
      .fb-bottom-nav .nav-item span {
        font-size: 11px;
      }
      .fb-bottom-nav .nav-item svg {
        width: 24px; height: 24px;
      }
      .fb-bottom-nav .menu-pic {
        width: 24px; height: 24px;
      }
    }
    ::-webkit-scrollbar {display:none;}
    #menu-profile-link { cursor:pointer; }
    #menu-profile-link img, #menu-profile-link span { cursor:pointer; }
  </style>
  <style>
    /* Search Modal Styles */
    .search-modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    
    .search-modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 0;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      position: relative;
    }
    
    .search-modal-header {
      padding: 15px 20px;
      border-bottom: 1px solid #e4e6ea;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fff;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .search-modal-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: #1c1e21;
    }
    
    .search-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #65676b;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .search-input-section {
      padding: 15px 20px;
      border-bottom: 1px solid #e4e6ea;
    }
    
    .search-input-container {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #f0f2f5;
      border-radius: 20px;
      padding: 8px 15px;
    }
    
    .search-input {
      flex: 1;
      border: none;
      background: transparent;
      padding: 8px 0;
      font-size: 16px;
      outline: none;
      color: #1c1e21;
    }
    
    .search-input::placeholder {
      color: #65676b;
    }
    
    .search-icon {
      color: #65676b;
      font-size: 18px;
    }
    
    .search-results {
      padding: 10px 20px;
    }
    
    .search-result-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid #f0f2f5;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .search-result-item:hover {
      background: #f0f2f5;
    }
    
    .search-result-item:last-child {
      border-bottom: none;
    }
    
    .search-result-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
    }
    
    .search-result-info {
      flex: 1;
    }
    
    .search-result-name {
      font-weight: 600;
      font-size: 15px;
      color: #1c1e21;
      margin-bottom: 2px;
    }
    
    .search-result-type {
      font-size: 13px;
      color: #65676b;
    }
    
    .search-result-preview {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      object-fit: cover;
      flex-shrink: 0;
    }
    
    .no-search-results {
      text-align: center;
      padding: 40px 20px;
      color: #65676b;
    }
    
    .no-search-results-icon {
      font-size: 48px;
      margin-bottom: 10px;
      opacity: 0.5;
    }
    
    .search-categories {
      display: flex;
      gap: 10px;
      padding: 15px 20px;
      border-bottom: 1px solid #e4e6ea;
      overflow-x: auto;
    }
    
    .search-category {
      background: #f0f2f5;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      color: #65676b;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }
    
    .search-category.active {
      background: #1877f2;
      color: #fff;
    }
    
    /* DXF Modal Styles */
    .dxf-modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    
    /* 3D Modal Styles */
    .td-modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    
    .td-modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 0;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      position: relative;
    }
    
    .td-modal-header {
      padding: 15px 20px;
      border-bottom: 1px solid #e4e6ea;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fff;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .td-modal-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: #1c1e21;
    }
    
    .td-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #65676b;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .td-upload-section {
      padding: 20px;
      text-align: center;
    }
    
    .td-upload-area {
      border: 2px dashed #e4e6ea;
      border-radius: 12px;
      padding: 40px 20px;
      margin: 20px 0;
      cursor: pointer;
      transition: all 0.3s;
      background: #f8f9fa;
    }
    
    .td-upload-area:hover {
      border-color: #1877f2;
      background: #f0f8ff;
    }
    
    .td-upload-area.dragover {
      border-color: #1877f2;
      background: #e3f2fd;
    }
    
    .td-upload-icon {
      font-size: 48px;
      margin-bottom: 15px;
      color: #65676b;
    }
    
    .td-upload-text {
      font-size: 16px;
      color: #1c1e21;
      margin-bottom: 8px;
    }
    
    .td-upload-subtext {
      font-size: 14px;
      color: #65676b;
    }
    
    .td-file-input {
      display: none;
    }
    
    .td-preview-section {
      padding: 20px;
      display: none;
    }
    
    .td-preview-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    
    .td-file-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .td-file-icon {
      font-size: 24px;
      color: #1877f2;
    }
    
    .td-file-details h4 {
      margin: 0;
      font-size: 16px;
      color: #1c1e21;
    }
    
    .td-file-details p {
      margin: 2px 0 0 0;
      font-size: 13px;
      color: #65676b;
    }
    
    .td-preview-canvas {
      width: 100%;
      height: 300px;
      border: 1px solid #e4e6ea;
      border-radius: 8px;
      background: #f8f9fa;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 15px;
    }
    
    .td-preview-placeholder {
      text-align: center;
      color: #65676b;
    }
    
    .td-preview-placeholder-icon {
      font-size: 48px;
      margin-bottom: 10px;
      opacity: 0.5;
    }
    
    .td-options-section {
      padding: 20px;
      border-top: 1px solid #e4e6ea;
    }
    
    .td-option-group {
      margin-bottom: 20px;
    }
    
    .td-option-label {
      font-weight: 600;
      font-size: 14px;
      color: #1c1e21;
      margin-bottom: 8px;
      display: block;
    }
    
    .td-option-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #e4e6ea;
      border-radius: 6px;
      font-size: 14px;
      outline: none;
    }
    
    .td-option-input:focus {
      border-color: #1877f2;
    }
    
    .td-option-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .td-option-row .td-option-input {
      flex: 1;
    }
    
    .td-option-select {
      width: 100%;
      padding: 10px;
      border: 1px solid #e4e6ea;
      border-radius: 6px;
      font-size: 14px;
      outline: none;
      background: #fff;
    }
    
    .td-option-select:focus {
      border-color: #1877f2;
    }
    
    .td-actions {
      padding: 20px;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    .td-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .td-btn-primary {
      background: #1877f2;
      color: #fff;
    }
    
    .td-btn-primary:hover {
      background: #166fe5;
    }
    
    .td-btn-secondary {
      background: #e4e6ea;
      color: #1c1e21;
    }
    
    .td-btn-secondary:hover {
      background: #d8dadf;
    }
    
    .td-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* JD Modal Styles */
    .jd-modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    
    .jd-modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 0;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      position: relative;
    }
    
    .jd-modal-header {
      padding: 15px 20px;
      border-bottom: 1px solid #e4e6ea;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fff;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .jd-modal-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: #1c1e21;
    }
    
    .jd-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #65676b;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .jd-upload-section {
      padding: 20px;
      text-align: center;
    }
    
    .jd-upload-area {
      border: 2px dashed #e4e6ea;
      border-radius: 12px;
      padding: 40px 20px;
      margin: 20px 0;
      cursor: pointer;
      transition: all 0.3s;
      background: #f8f9fa;
    }
    
    .jd-upload-area:hover {
      border-color: #1877f2;
      background: #f0f8ff;
    }
    
    .jd-upload-area.dragover {
      border-color: #1877f2;
      background: #e3f2fd;
    }
    
    .jd-upload-icon {
      font-size: 48px;
      margin-bottom: 15px;
      color: #65676b;
    }
    
    .jd-upload-text {
      font-size: 16px;
      color: #1c1e21;
      margin-bottom: 8px;
    }
    
    .jd-upload-subtext {
      font-size: 14px;
      color: #65676b;
    }
    
    .jd-file-input {
      display: none;
    }
    
    .jd-preview-section {
      padding: 20px;
      display: none;
    }
    
    .jd-preview-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    
    .jd-file-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .jd-file-icon {
      font-size: 24px;
      color: #1877f2;
    }
    
    .jd-file-details h4 {
      margin: 0;
      font-size: 16px;
      color: #1c1e21;
    }
    
    .jd-file-details p {
      margin: 2px 0 0 0;
      font-size: 13px;
      color: #65676b;
    }
    
    .jd-preview-canvas {
      width: 100%;
      height: 300px;
      border: 1px solid #e4e6ea;
      border-radius: 8px;
      background: #f8f9fa;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 15px;
    }
    
    .jd-preview-placeholder {
      text-align: center;
      color: #65676b;
    }
    
    .jd-preview-placeholder-icon {
      font-size: 48px;
      margin-bottom: 10px;
      opacity: 0.5;
    }
    
    .jd-options-section {
      padding: 20px;
      border-top: 1px solid #e4e6ea;
    }
    
    .jd-option-group {
      margin-bottom: 20px;
    }
    
    .jd-option-label {
      font-weight: 600;
      font-size: 14px;
      color: #1c1e21;
      margin-bottom: 8px;
      display: block;
    }
    
    .jd-option-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #e4e6ea;
      border-radius: 6px;
      font-size: 14px;
      outline: none;
    }
    
    .jd-option-input:focus {
      border-color: #1877f2;
    }
    
    .jd-option-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .jd-option-row .jd-option-input {
      flex: 1;
    }
    
    .jd-option-select {
      width: 100%;
      padding: 10px;
      border: 1px solid #e4e6ea;
      border-radius: 6px;
      font-size: 14px;
      outline: none;
      background: #fff;
    }
    
    .jd-option-select:focus {
      border-color: #1877f2;
    }
    
    .jd-actions {
      padding: 20px;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    .jd-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .jd-btn-primary {
      background: #1877f2;
      color: #fff;
    }
    
    .jd-btn-primary:hover {
      background: #166fe5;
    }
    
    .jd-btn-secondary {
      background: #e4e6ea;
      color: #1c1e21;
    }
    
    .jd-btn-secondary:hover {
      background: #d8dadf;
    }
    
    .jd-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Help Modal Styles */
    .help-modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.6);
      backdrop-filter: blur(5px);
    }
    
    .help-modal-content {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      margin: 5% auto;
      padding: 0;
      border-radius: 20px;
      width: 95%;
      max-width: 450px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      position: relative;
      border: 1px solid #e4e6ea;
    }
    
    .help-modal-header {
      background: linear-gradient(135deg, #1877f2 0%, #42a5f5 100%);
      color: white;
      padding: 25px 25px 20px 25px;
      text-align: center;
      border-radius: 20px 20px 0 0;
      position: relative;
    }
    
    .help-modal-header h3 {
      margin: 0;
      font-size: 22px;
      font-weight: 700;
      color: white;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .help-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255,255,255,0.2);
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: white;
      padding: 8px;
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }
    
    .help-close:hover {
      background: rgba(255,255,255,0.3);
      transform: scale(1.1);
    }
    
    .help-options {
      padding: 25px;
    }
    
    .help-option {
      display: flex;
      align-items: center;
      gap: 18px;
      padding: 20px;
      border-radius: 16px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .help-option:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      border-color: #1877f2;
    }
    
    .help-option-icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transition: all 0.3s ease;
    }
    
    .help-option:hover .help-option-icon {
      transform: scale(1.1);
    }
    
    .help-option-info {
      flex: 1;
    }
    
    .help-option-title {
      font-weight: 700;
      font-size: 17px;
      color: #1c1e21;
      margin-bottom: 6px;
      line-height: 1.3;
    }
    
    .help-option-desc {
      font-size: 14px;
      color: #65676b;
      line-height: 1.4;
    }
    
    .help-whatsapp {
      background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
      color: white;
    }
    
    .help-email {
      background: linear-gradient(135deg, #1877f2 0%, #42a5f5 100%);
      color: white;
    }
    
    .help-faq {
      background: linear-gradient(135deg, #fbc02d 0%, #f57c00 100%);
      color: white;
    }
    
    .help-feedback {
      background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%);
      color: white;
    }
    
    .help-phone {
      background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
      color: white;
    }
    
    .guide-step {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border: 2px solid #e4e6ea;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      transition: all 0.3s ease;
    }
    
    .guide-step:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      border-color: #1877f2;
    }
    
    .guide-step-number {
      background: linear-gradient(135deg, #1877f2 0%, #42a5f5 100%);
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
      margin-right: 15px;
      box-shadow: 0 4px 12px rgba(24,119,242,0.3);
    }
    
    .guide-step-content {
      display: flex;
      align-items: flex-start;
    }
    
    .guide-step-text {
      flex: 1;
    }
    
    .guide-step-title {
      font-weight: 700;
      font-size: 16px;
      color: #1c1e21;
      margin-bottom: 8px;
      line-height: 1.3;
    }
    
    .guide-step-desc {
      font-size: 14px;
      color: #65676b;
      line-height: 1.5;
    }
    
    .guide-note {
      background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
      border: 2px solid #fbc02d;
      border-radius: 12px;
      padding: 15px;
      margin-top: 15px;
      font-size: 13px;
      color: #856404;
      box-shadow: 0 2px 8px rgba(251,192,45,0.2);
    }
    
    .dxf-modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 0;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      position: relative;
    }
    
    .dxf-modal-header {
      padding: 15px 20px;
      border-bottom: 1px solid #e4e6ea;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fff;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .dxf-modal-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: #1c1e21;
    }
    
    .dxf-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #65676b;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* DXF Viewer Modal Special Styles */
    #dxfViewerModal .dxf-modal-content {
      max-width: 600px;
      text-align: center;
    }
    
    #dxfViewerModal .dxf-modal-header {
      background: linear-gradient(135deg, #1877f2, #42a5f5);
      color: white;
    }
    
    #dxfViewerModal .dxf-modal-header h3 {
      color: white;
    }
    
    #dxfViewerModal .dxf-close {
      color: white;
    }
    
    #dxfViewerModal .dxf-close:hover {
      background: rgba(255,255,255,0.1);
      border-radius: 50%;
    }
    
    .dxf-upload-section {
      padding: 20px;
      text-align: center;
    }
    
    .dxf-upload-area {
      border: 2px dashed #e4e6ea;
      border-radius: 12px;
      padding: 40px 20px;
      margin: 20px 0;
      cursor: pointer;
      transition: all 0.3s;
      background: #f8f9fa;
    }
    
    .dxf-upload-area:hover {
      border-color: #1877f2;
      background: #f0f8ff;
    }
    
    .dxf-upload-area.dragover {
      border-color: #1877f2;
      background: #e3f2fd;
    }
    
    .dxf-upload-icon {
      font-size: 48px;
      margin-bottom: 15px;
      color: #65676b;
    }
    
    .dxf-upload-text {
      font-size: 16px;
      color: #1c1e21;
      margin-bottom: 8px;
    }
    
    .dxf-upload-subtext {
      font-size: 14px;
      color: #65676b;
    }
    
    .dxf-file-input {
      display: none;
    }
    
    .dxf-preview-section {
      padding: 20px;
      display: none;
    }
    
    .dxf-preview-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    
    .dxf-file-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .dxf-file-icon {
      font-size: 24px;
      color: #1877f2;
    }
    
    .dxf-file-details h4 {
      margin: 0;
      font-size: 16px;
      color: #1c1e21;
    }
    
    .dxf-file-details p {
      margin: 2px 0 0 0;
      font-size: 13px;
      color: #65676b;
    }
    
    .dxf-preview-canvas {
      width: 100%;
      height: 300px;
      border: 1px solid #e4e6ea;
      border-radius: 8px;
      background: #f8f9fa;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 15px;
    }
    
    .dxf-preview-placeholder {
      text-align: center;
      color: #65676b;
    }
    
    .dxf-preview-placeholder-icon {
      font-size: 48px;
      margin-bottom: 10px;
      opacity: 0.5;
    }
    
    .dxf-options-section {
      padding: 20px;
      border-top: 1px solid #e4e6ea;
    }
    
    .dxf-option-group {
      margin-bottom: 20px;
    }
    
    .dxf-option-label {
      font-weight: 600;
      font-size: 14px;
      color: #1c1e21;
      margin-bottom: 8px;
      display: block;
    }
    
    .dxf-option-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #e4e6ea;
      border-radius: 6px;
      font-size: 14px;
      outline: none;
    }
    
    .dxf-option-input:focus {
      border-color: #1877f2;
    }
    
    .dxf-option-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .dxf-option-row .dxf-option-input {
      flex: 1;
    }
    
    .dxf-option-select {
      width: 100%;
      padding: 10px;
      border: 1px solid #e4e6ea;
      border-radius: 6px;
      font-size: 14px;
      outline: none;
      background: #fff;
    }
    
    .dxf-option-select:focus {
      border-color: #1877f2;
    }
    
    .dxf-actions {
      padding: 20px;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    .dxf-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .dxf-btn-primary {
      background: #1877f2;
      color: #fff;
    }
    
    .dxf-btn-primary:hover {
      background: #166fe5;
    }
    
    .dxf-btn-secondary {
      background: #e4e6ea;
      color: #1c1e21;
    }
    
    .dxf-btn-secondary:hover {
      background: #d8dadf;
    }
    
    .dxf-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Thumbnail Styles */
    .dxf-thumbnail-section {
      padding: 20px;
      border-top: 1px solid #e4e6ea;
    }
    
    .dxf-thumbnail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .dxf-thumbnail-actions {
      display: flex;
      gap: 8px;
    }
    
    .dxf-thumbnail-preview {
      width: 100%;
      height: 120px;
      border: 2px dashed #e4e6ea;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f8f9fa;
      cursor: pointer;
      transition: all 0.3s;
      overflow: hidden;
      position: relative;
    }
    
    .dxf-thumbnail-preview:hover {
      border-color: #1877f2;
      background: #f0f8ff;
    }
    
    .dxf-thumbnail-placeholder {
      text-align: center;
      color: #65676b;
    }
    
    .dxf-thumbnail-placeholder-icon {
      font-size: 32px;
      margin-bottom: 8px;
      opacity: 0.5;
    }
    
    .dxf-thumbnail-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
      object-position: center;
      border-radius: 6px;
      background: #f8f9fa;
    }
    
    .dxf-thumbnail-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .dxf-thumbnail-preview:hover .dxf-thumbnail-overlay {
      opacity: 1;
    }
    
    .dxf-thumbnail-overlay button {
      background: rgba(255,255,255,0.9);
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      margin: 0 4px;
    }
    
    /* 3D Thumbnail Styles */
    .td-thumbnail-preview {
      width: 100%;
      height: 120px;
      border: 2px dashed #e4e6ea;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f8f9fa;
      cursor: pointer;
      transition: all 0.3s;
      overflow: hidden;
      position: relative;
    }
    
    .td-thumbnail-preview:hover {
      border-color: #1877f2;
      background: #f0f8ff;
    }
    
    .td-thumbnail-placeholder {
      text-align: center;
      color: #65676b;
    }
    
    .td-thumbnail-placeholder-icon {
      font-size: 32px;
      margin-bottom: 8px;
      opacity: 0.5;
    }
    
    .td-thumbnail-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
      object-position: center;
      border-radius: 6px;
      background: #f8f9fa;
    }
    
    .td-thumbnail-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .td-thumbnail-preview:hover .td-thumbnail-overlay {
      opacity: 1;
    }
    
    .td-thumbnail-overlay button {
      background: rgba(255,255,255,0.9);
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      margin: 0 4px;
    }
    
    /* GD Thumbnail Styles */
    .jd-thumbnail-preview {
      width: 100%;
      height: 120px;
      border: 2px dashed #e4e6ea;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f8f9fa;
      cursor: pointer;
      transition: all 0.3s;
      overflow: hidden;
      position: relative;
    }
    
    .jd-thumbnail-preview:hover {
      border-color: #1877f2;
      background: #f0f8ff;
    }
    
    .jd-thumbnail-placeholder {
      text-align: center;
      color: #65676b;
    }
    
    .jd-thumbnail-placeholder-icon {
      font-size: 32px;
      margin-bottom: 8px;
      opacity: 0.5;
    }
    
    .jd-thumbnail-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
      object-position: center;
      border-radius: 6px;
      background: #f8f9fa;
    }
    
    .jd-thumbnail-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .jd-thumbnail-preview:hover .jd-thumbnail-overlay {
      opacity: 1;
    }
    
    .jd-thumbnail-overlay button {
      background: rgba(255,255,255,0.9);
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      margin: 0 4px;
    }
    
    /* Thumbnail Generator Modal */
    .thumbnail-generator-modal {
      display: none;
      position: fixed;
      z-index: 10001;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    
    .thumbnail-generator-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 0;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      position: relative;
    }
    
    .thumbnail-generator-header {
      padding: 15px 20px;
      border-bottom: 1px solid #e4e6ea;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .thumbnail-generator-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: #1c1e21;
    }
    
    .thumbnail-generator-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #65676b;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .thumbnail-generator-body {
      padding: 20px;
    }
    
    .thumbnail-canvas-container {
      width: 100%;
      height: 300px;
      border: 2px solid #e4e6ea;
      border-radius: 8px;
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
    }
    
    .thumbnail-canvas {
      width: 100%;
      height: 100%;
      background: #f8f9fa;
    }
    
    .thumbnail-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .thumbnail-control-group {
      display: flex;
      flex-direction: column;
    }
    
    .thumbnail-control-label {
      font-weight: 600;
      font-size: 14px;
      color: #1c1e21;
      margin-bottom: 8px;
    }
    
    .thumbnail-control-input {
      padding: 8px;
      border: 1px solid #e4e6ea;
      border-radius: 6px;
      font-size: 14px;
      outline: none;
    }
    
    .thumbnail-control-input:focus {
      border-color: #1877f2;
    }
    
    .thumbnail-color-picker {
      width: 100%;
      height: 40px;
      border: 1px solid #e4e6ea;
      border-radius: 6px;
      cursor: pointer;
    }
    
    .thumbnail-templates {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .thumbnail-template {
      width: 100%;
      height: 80px;
      border: 2px solid #e4e6ea;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      transition: all 0.2s;
    }
    
    .thumbnail-template:hover {
      border-color: #1877f2;
      background: #f0f8ff;
    }
    
    .thumbnail-template.active {
      border-color: #1877f2;
      background: #e3f2fd;
    }
    
    .plus-menu-popup {
      position: absolute;
      top: 48px;
      right: 0;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(24,119,242,0.06);
      min-width: 170px;
      z-index: 1001;
      padding: 10px 0;
      display: none;
      border: 1.5px solid #e4e6eb;
    }
    .plus-menu-popup .plus-menu-item {
      margin: 0 10px;
      padding: 13px 0;
      font-size: 16px;
      font-weight: 600;
      color: #222;
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      transition: background 0.13s, color 0.13s;
    }
    .plus-menu-popup .plus-menu-item:hover {
      background: #f0f6ff;
      color: #1877f2;
    }
  </style>
  <style>
    .story-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      width: 100%;
      position: absolute;
      top: 0; left: 0;
      background: rgba(255,255,255,0.7);
      z-index: 2;
      border-radius: 16px;
    }
    .story-loading .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #1877f2;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }
  </style>
  <style>
    /* Comment Modal Styles */
    /* Post Viewer Modal Styles */
    .post-viewer-modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.9);
      backdrop-filter: blur(5px);
    }
    
    .post-viewer-content {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    
    .post-viewer-header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px;
      background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, transparent 100%);
      color: white;
    }
    
    .post-viewer-user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .post-viewer-profile {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid rgba(255,255,255,0.3);
    }
    
    .post-viewer-user-details {
      display: flex;
      flex-direction: column;
    }
    
    .post-viewer-username {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 2px;
    }
    
    .post-viewer-time {
      font-size: 14px;
      opacity: 0.8;
    }
    
    .post-viewer-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .post-viewer-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.2s;
    }
    
    .post-viewer-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: scale(1.1);
    }
    
    .post-viewer-close {
      background: rgba(0,0,0,0.5);
      font-size: 24px;
      font-weight: bold;
    }
    
    .post-viewer-media {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 80px 20px 120px 20px;
    }
    
    .post-viewer-media img,
    .post-viewer-media video {
      max-width: 100%;
      max-height: 100%;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    
    .post-viewer-media video {
      background: #000;
    }
    
    .post-viewer-footer {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 10;
      background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, transparent 100%);
      padding: 20px;
      color: white;
    }
    
    .post-viewer-caption {
      font-size: 16px;
      line-height: 1.5;
      margin-bottom: 16px;
      max-height: 80px;
      overflow-y: auto;
    }
    
    .post-viewer-stats {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      font-size: 14px;
      opacity: 0.9;
    }
    
    .post-viewer-actions-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.2);
    }
    
    .post-viewer-action-btn {
      background: none;
      border: none;
      color: white;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 16px;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 8px;
      transition: background 0.2s;
    }
    
    .post-viewer-action-btn:hover {
      background: rgba(255,255,255,0.1);
    }
    
    .post-viewer-action-btn.liked {
      color: #1877f2;
    }
    
    .post-viewer-action-btn svg {
      width: 20px;
      height: 20px;
    }
    
    .post-viewer-comment-input {
      flex: 1;
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 20px;
      padding: 10px 16px;
      color: white;
      font-size: 14px;
      margin: 0 12px;
      outline: none;
    }
    
    .post-viewer-comment-input::placeholder {
      color: rgba(255,255,255,0.7);
    }
    
    .comment-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    
    .comment-modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 0;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      position: relative;
    }
    
    .comment-modal-header {
      padding: 15px 20px;
      border-bottom: 1px solid #e4e6ea;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fff;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .comment-modal-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
      color: #1c1e21;
    }
    
    .close-modal {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #65676b;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .comment-modal-body {
      padding: 20px;
    }
    
    .comment-post-content {
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #e4e6ea;
    }
    
    .comment-post-text {
      font-size: 16px;
      color: #1c1e21;
      margin-bottom: 10px;
    }
    
    .comment-post-media img {
      max-width: 100%;
      border-radius: 8px;
      margin-bottom: 10px;
      border: 1px solid #e4e6ea;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .comment-post-media video {
      max-width: 100%;
      border-radius: 8px;
      margin-bottom: 10px;
      border: 1px solid #e4e6ea;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .comments-section {
      margin-bottom: 20px;
    }
    
    .no-comments {
      text-align: center;
      padding: 30px 20px;
      color: #65676b;
    }
    
    .no-comments-icon {
      font-size: 48px;
      margin-bottom: 10px;
      opacity: 0.5;
    }
    
    .comment-item {
      display: flex;
      margin-bottom: 15px;
      align-items: flex-start;
    }
    
    .comment-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #1877f2;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-right: 10px;
      flex-shrink: 0;
    }
    
    .comment-content {
      background: #f0f2f5;
      padding: 8px 12px;
      border-radius: 18px;
      flex: 1;
    }
    
    .comment-author {
      font-weight: 600;
      font-size: 13px;
      color: #1c1e21;
      margin-bottom: 2px;
    }
    
    .comment-text {
      font-size: 14px;
      color: #1c1e21;
      line-height: 1.4;
    }
    
    .comment-input-section {
      border-top: 1px solid #e4e6ea;
      padding: 15px 20px;
      background: #fff;
      position: sticky;
      bottom: 0;
      z-index: 10;
    }
    
    .comment-input-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .comment-input {
      flex: 1;
      border: none;
      background: #f0f2f5;
      padding: 10px 15px;
      border-radius: 20px;
      font-size: 14px;
      outline: none;
      resize: none;
      min-height: 20px;
      max-height: 100px;
    }
    
    .comment-input:focus {
      background: #e4e6ea;
    }
    
    .comment-send-btn {
      background: #1877f2;
      color: white;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
      opacity: 0.5;
      transition: opacity 0.2s;
    }
    
    .comment-send-btn.active {
      opacity: 1;
    }
    
    .comment-actions {
      display: flex;
      gap: 15px;
      margin-top: 10px;
    }
    
    .comment-action-btn {
      background: none;
      border: none;
      color: #65676b;
      font-size: 20px;
      cursor: pointer;
      padding: 5px;
    }
  </style>
</head>
<body>
  <div class="fb-topbar">
    <div class="logo">
      <img src="cncfblogo.png" alt="CNC FB Logo" style="width:36px; height:36px;">
      CNC FB
    </div>
    <div class="top-icons" style="position:relative;">
      <button class="icon-btn" id="plus-menu-btn" title="Create">
        <!-- Plus SVG -->
        <svg viewBox="0 0 28 28" width="30" height="30">
          <circle cx="14" cy="14" r="14" fill="#fff"/>
          <path d="M14 8v12M8 14h12" stroke="#1877f2" stroke-width="2.8" stroke-linecap="round"/>
        </svg>
      </button>
      <div id="plus-menu-popup" class="plus-menu-popup">
        <div class="plus-menu-item plus-dxf">DXF</div>
        <div class="plus-menu-item plus-eng">3D</div>
        <div class="plus-menu-item plus-jd">JD</div>
      </div>
      <button class="icon-btn" title="Search" id="search-btn">
        <!-- Search SVG -->
        <svg viewBox="0 0 28 28" width="24" height="24">
          <circle cx="13" cy="13" r="8" stroke="#050505" stroke-width="2.2" fill="#fff"/>
          <path d="M20 20l4 4" stroke="#43a047" stroke-width="2.2" stroke-linecap="round"/>
        </svg>
      </button>
      <button class="icon-btn" title="Customer Support" style="display:flex;flex-direction:column;align-items:center;gap:2px;padding:4px;height:auto;" onclick="openHelpModal()">
        <!-- Customer Support logo -->
        <img src="messenger-logo.png" alt="Customer Support" style="width:20px;height:20px;border-radius:50%;object-fit:cover;display:block;" />
        <span style="font-size:10px;color:#65676b;font-weight:500;">Help</span>
      </button>
    </div>
  </div>
  <div class="fb-main">
    <div class="fb-whats-mind">
      <img src="default-profile.png" alt="Profile" class="profile-pic" id="mind-profile-pic" style="cursor:pointer;">
      <input class="mind-input" type="text" placeholder="What's on your mind?" disabled>
      <button class="img-upload-btn" id="open-create-post" title="Photo/Video" style="margin-left:4px;">
        <svg viewBox="0 0 24 24" width="28" height="28"><rect x="3" y="5" width="18" height="14" rx="3" fill="none" stroke="#65676b" stroke-width="2"/><circle cx="8" cy="12" r="2.5" fill="none" stroke="#65676b" stroke-width="2"/><path d="M21 19l-5.5-7-4.5 6-3-4-4 5" stroke="#65676b" stroke-width="2" fill="none"/></svg>
      </button>
      <input type="file" id="create-post-file" accept="image/*,video/*" style="display:none;">
    </div>
    <div class="fb-stories">
      <div class="fb-story create" id="create-story-box" style="background: linear-gradient(135deg, #1877f2 60%, #4e8cff 100%); color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 20px; box-shadow: 0 2px 8px rgba(24,119,242,0.10); border: none; position: relative; cursor:pointer;">
        <div style="margin-bottom: 18px;">
          <svg width="44" height="44" viewBox="0 0 44 44" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect width="44" height="44" rx="12" fill="none"/>
            <path d="M14 16C14 14.8954 14.8954 14 16 14H28C29.1046 14 30 14.8954 30 16V28C30 29.1046 29.1046 30 28 30H16C14.8954 30 14 29.1046 14 28V16Z" stroke="white" stroke-width="2.2" fill="none"/>
            <path d="M18 18H26V22H18V18Z" fill="white"/>
            <path d="M18 24H22V26H18V24Z" fill="white"/>
          </svg>
        </div>
        <div style="font-size: 1.25rem; font-weight: 600; text-align: center; line-height: 1.2;">Create<br>story</div>
        <input type="file" id="story-video-input" accept="video/*" style="display:none;">
      </div>
      <div class="fb-story" id="story-video-box"></div>
      <div class="fb-story"></div>
      <div class="fb-story"></div>
      <div class="fb-story"></div>
    </div>
    <!-- Story Fullscreen Viewer Modal -->
    <div id="story-viewer-modal" style="display:none;position:fixed;z-index:99999;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.92);align-items:center;justify-content:center;">
      <!-- Top bar -->
      <div id="story-viewer-topbar" style="position:absolute;top:0;left:0;width:100vw;display:flex;align-items:center;justify-content:space-between;padding:14px 16px 0 16px;z-index:3;pointer-events:none;">
        <div style="display:flex;align-items:center;gap:10px;pointer-events:auto;">
          <img id="story-viewer-profile" src="default-profile.png" style="width:38px;height:38px;border-radius:50%;object-fit:cover;border:2px solid #1877f2;">
          <div style="display:flex;flex-direction:column;">
            <span id="story-viewer-name" style="color:#fff;font-weight:600;font-size:1.1rem;line-height:1;">User Name</span>
            <span id="story-viewer-time" style="color:#ddd;font-size:0.95rem;">4h</span>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:10px;pointer-events:auto;">
          <button id="story-viewer-mute" style="background:rgba(0,0,0,0.4);border:none;color:#fff;font-size:1.5rem;border-radius:50%;width:38px;height:38px;cursor:pointer;display:flex;align-items:center;justify-content:center;">
            <span id="story-viewer-mute-icon"></span>
          </button>
          <button id="story-viewer-menu" style="background:rgba(0,0,0,0.4);border:none;color:#fff;font-size:1.7rem;border-radius:50%;width:38px;height:38px;cursor:pointer;display:flex;align-items:center;justify-content:center;">&#8942;</button>
          <button id="story-viewer-close" style="background:rgba(0,0,0,0.4);border:none;color:#fff;font-size:2.2rem;border-radius:50%;width:48px;height:48px;cursor:pointer;z-index:2;">&times;</button>
        </div>
        <!-- Three-dot menu popup -->
        <div id="story-viewer-menu-popup" style="display:none;position:absolute;top:60px;right:80px;z-index:10001;background:#fff;border-radius:14px;box-shadow:0 4px 24px rgba(24,119,242,0.13);min-width:170px;padding:8px 0;border:1.5px solid #e4e6eb;">
          <button class="story-menu-item" data-action="delete" style="width:100%;background:none;border:none;text-align:left;font-size:16px;padding:12px 24px;color:#e53935;cursor:pointer;">Delete</button>
          <button class="story-menu-item" data-action="save" style="width:100%;background:none;border:none;text-align:left;font-size:16px;padding:12px 24px;color:#222;cursor:pointer;">Save</button>
          <button class="story-menu-item" data-action="print" style="width:100%;background:none;border:none;text-align:left;font-size:16px;padding:12px 24px;color:#222;cursor:pointer;">Print</button>
          <button class="story-menu-item" data-action="hide" style="width:100%;background:none;border:none;text-align:left;font-size:16px;padding:12px 24px;color:#222;cursor:pointer;">Hide</button>
        </div>
      </div>
      <!-- Progress bar -->
      <div id="story-viewer-progress-container" style="position:absolute;top:0;left:0;width:100vw;height:6px;background:rgba(255,255,255,0.13);z-index:4;">
        <div id="story-viewer-progress" style="height:100%;width:0%;background:#fff;border-radius:3px;transition:width 0.1s;"></div>
      </div>
      <!-- Video -->
      <video id="story-viewer-video" controls style="max-width:96vw;max-height:90vh;border-radius:18px;box-shadow:0 2px 24px #000;"></video>
      <!-- Emoji reaction bar -->
      <div id="story-viewer-reactions" style="position:absolute;bottom:24px;left:50%;transform:translateX(-50%);display:flex;gap:16px;z-index:5;background:rgba(0,0,0,0.18);padding:10px 24px;border-radius:32px;">
        <span class="story-emoji" style="font-size:2rem;cursor:pointer;"></span>
        <span class="story-emoji" style="font-size:2rem;cursor:pointer;"></span>
        <span class="story-emoji" style="font-size:2rem;cursor:pointer;"></span>
        <span class="story-emoji" style="font-size:2rem;cursor:pointer;"></span>
        <span class="story-emoji" style="font-size:2rem;cursor:pointer;"></span>
        <span class="story-emoji" style="font-size:2rem;cursor:pointer;"></span>
      </div>
    </div>
    <div id="story-modal" style="display:none;position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);align-items:center;justify-content:center;">
      <div style="background:#fff;padding:24px 18px 18px 18px;border-radius:16px;box-shadow:0 2px 16px rgba(0,0,0,0.10);max-width:90vw;max-height:80vh;display:flex;flex-direction:column;align-items:center;">
        <video id="story-video-preview" controls style="max-width:320px;max-height:320px;border-radius:12px;"></video>
        <div style="margin-top:18px;display:flex;gap:12px;">
          <button id="story-next-btn" style="background:#1877f2;color:#fff;font-size:16px;font-weight:600;padding:8px 24px;border:none;border-radius:7px;cursor:pointer;">Next</button>
          <button id="story-cancel-btn" style="background:#e4e6eb;color:#050505;font-size:16px;font-weight:600;padding:8px 24px;border:none;border-radius:7px;cursor:pointer;">Cancel</button>
        </div>
      </div>
    </div>
    <div id="post-feed"></div>
    <!-- Saved Gallery Section -->
    <div id="saved-gallery-section" style="max-width:500px;margin:32px auto 0 auto;padding:16px;background:#fff;border-radius:16px;box-shadow:0 1px 4px rgba(0,0,0,0.06);">
      <div style="font-size:1.2rem;font-weight:600;margin-bottom:12px;">Saved Gallery</div>
      <div id="saved-gallery-list" style="display:flex;gap:12px;flex-wrap:wrap;"></div>
    </div>
    <div class="fb-people-may-know">
      <div class="fb-people-may-know-title">People you may know</div>
      <div class="fb-people-list">
        <div class="fb-people-card">
          <img src="profile2.jpg" alt="Profile">
          <div class="name">Sample User</div>
        </div>
      </div>
    </div>
  </div>
  <nav class="fb-bottom-nav">
    <a class="nav-item active" href="#">
      <!-- Home SVG -->
      <svg viewBox="0 0 28 28" width="28" height="28"><path d="M25.825 12.29l-10-9a1 1 0 0 0-1.35 0l-10 9A1 1 0 0 0 5 14h1v8a2 2 0 0 0 2 2h4v-6h4v6h4a2 2 0 0 0 2-2v-8h1a1 1 0 0 0 .825-1.71z" fill="#1877f2"/></svg>
      <span>Home</span>
    </a>
    <a class="nav-item" href="#">
      <!-- Reels SVG -->
      <svg viewBox="0 0 28 28" width="28" height="28"><rect x="4" y="6" width="20" height="16" rx="3" fill="#65676b"/><polygon points="13,11 19,14 13,17" fill="#fff"/></svg>
      <span>Reels</span>
    </a>
    <a class="nav-item" href="#">
      <!-- Friends SVG -->
      <svg viewBox="0 0 28 28" width="28" height="28"><circle cx="9" cy="11" r="4" fill="#65676b"/><circle cx="19" cy="11" r="4" fill="#65676b"/><rect x="4" y="18" width="20" height="4" rx="2" fill="#65676b"/></svg>
      <span>Friends</span>
      <span class="badge">9+</span>
    </a>
    <a class="nav-item" href="#">
      <!-- Scanner image icon -->
      <img src="scanner-icon.png" alt="Scanner" style="width:28px;height:28px;border-radius:50%;object-fit:cover;display:block;" />
      <span>Scanner</span>
    </a>
    <a class="nav-item" href="#" id="notifications-nav">
      <!-- Notifications SVG -->
      <svg viewBox="0 0 28 28" width="28" height="28"><path d="M14 25a3 3 0 0 0 3-3H11a3 3 0 0 0 3 3zm7-7V12a7 7 0 1 0-14 0v6l-2 2v1h18v-1l-2-2z" fill="#65676b"/></svg>
      <span>Notifications</span>
      <span class="badge" id="notification-badge" style="display:none;">0</span>
    </a>
    <a class="nav-item" href="#" id="menu-profile-link">
      <img id="menu-profile-pic" src="default-profile.png" alt="Menu" class="menu-pic"/>
      <span>Menu</span>
    </a>
  </nav>
  <!-- Facebook-style Menu Overlay -->
  <div id="fb-menu-overlay" style="display:none;position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);">
    <div id="fb-menu-sheet" style="position:absolute;top:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;height:100vh;background:#f7f8fa;overflow-y:auto;box-shadow:0 2px 16px rgba(0,0,0,0.10);">
      <div style="padding:18px 18px 0 18px;display:flex;align-items:center;justify-content:space-between;">
        <span style="font-size:2rem;font-weight:700;">Menu</span>
        <div>
          <button id="fb-menu-close" style="background:none;border:none;font-size:2rem;line-height:1;color:#65676b;cursor:pointer;">&times;</button>
        </div>
      </div>
      <div style="padding:12px 18px 0 18px;display:flex;align-items:center;justify-content:space-between;">
        <div style="display:flex;align-items:center;gap:12px;">
          <img id="fb-menu-user-pic" src="default-profile.png" style="width:48px;height:48px;border-radius:50%;object-fit:cover;background:#fff;border:2px solid #e4e6eb;">
          <div id="fb-menu-user-name" style="font-size:18px;font-weight:600;"></div>
        </div>
        <div style="display:flex;align-items:center;gap:10px;">
          <span style="position:relative;">
            <img src="default-profile.png" style="width:32px;height:32px;border-radius:50%;object-fit:cover;border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,0.10);">
            <span style="position:absolute;top:-6px;right:-6px;background:#f02849;color:#fff;font-size:12px;border-radius:10px;padding:0 6px;min-width:18px;height:18px;line-height:18px;font-weight:bold;">9+</span>
          </span>
          <button style="background:none;border:none;font-size:1.5rem;color:#65676b;cursor:pointer;"><svg width="22" height="22" viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" fill="#65676b"/></svg></button>
        </div>
      </div>
      <div style="padding:18px 10px 0 10px;display:grid;grid-template-columns:1fr 1fr;gap:14px;">
        <div class="fb-menu-tile tile-dashboard"><span class="fb-menu-icon"><svg width="36" height="36" viewBox="0 0 36 36"><g><rect x="6" y="12" width="24" height="12" rx="4" fill="#e4e6eb"/><rect x="10" y="16" width="4" height="8" rx="2" fill="#1877f2"/><rect x="17" y="13" width="4" height="11" rx="2" fill="#43a047"/><rect x="24" y="18" width="4" height="6" rx="2" fill="#fbc02d"/></g></svg></span><span>Professional dashboard</span></div>
        <div class="fb-menu-tile tile-feeds"><span class="fb-menu-icon"><svg width="36" height="36" viewBox="0 0 36 36"><g><rect x="7" y="10" width="22" height="16" rx="4" fill="#e4e6eb"/><rect x="12" y="15" width="12" height="3" rx="1.5" fill="#1877f2"/><rect x="12" y="20" width="8" height="3" rx="1.5" fill="#43a047"/></g></svg></span><span>Feeds</span></div>
        <div class="fb-menu-tile tile-groups"><span class="fb-menu-icon"><svg width="36" height="36" viewBox="0 0 36 36"><g><circle cx="14" cy="18" r="6" fill="#1877f2"/><circle cx="24" cy="18" r="6" fill="#43a047"/><rect x="8" y="26" width="20" height="6" rx="3" fill="#e4e6eb"/></g></svg></span><span>Groups</span></div>
        <div class="fb-menu-tile tile-explore"><span class="fb-menu-icon"><svg width="36" height="36" viewBox="0 0 36 36"><g><circle cx="18" cy="18" r="12" fill="#e4e6eb"/><circle cx="18" cy="18" r="7" fill="#fbc02d"/><rect x="26" y="26" width="8" height="3" rx="1.5" transform="rotate(45 26 26)" fill="#1877f2"/></g></svg></span><span>Explore people</span></div>
        <div class="fb-menu-tile tile-memories"><span class="fb-menu-icon"><svg width="36" height="36" viewBox="0 0 36 36"><g><circle cx="18" cy="18" r="14" fill="#e4e6eb"/><path d="M18 10v9l6 3" stroke="#8e24aa" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/></g></svg></span><span>Memories</span></div>
        <div class="fb-menu-tile tile-reels"><span class="fb-menu-icon"><svg width="36" height="36" viewBox="0 0 36 36"><g><rect x="7" y="10" width="22" height="16" rx="4" fill="#e4e6eb"/><rect x="13" y="15" width="10" height="6" rx="3" fill="#e53935"/><rect x="13" y="15" width="10" height="6" rx="3" fill="#e53935" opacity=".3"/><polygon points="18,16 24,19 18,22" fill="#e53935"/></g></svg></span><span>Reels</span></div>
        <div class="fb-menu-tile tile-support"><span class="fb-menu-icon"><svg width="36" height="36" viewBox="0 0 36 36"><g><circle cx="18" cy="18" r="16" fill="#e4e6eb"/><path d="M18 12a8 8 0 1 1 0 16a8 8 0 0 1 0-16z" fill="#1976d2"/></g></svg></span><span>Support</span></div>
        <div class="fb-menu-tile tile-saved"><span class="fb-menu-icon"><svg width="36" height="36" viewBox="0 0 36 36"><g><rect x="10" y="9" width="16" height="18" rx="4" fill="#e4e6eb"/><polygon points="18,17 24,23 12,23" fill="#8d6e63"/></g></svg></span><span>Saved</span></div>
        <div class="fb-menu-tile tile-pages"><span class="fb-menu-icon"><svg width="36" height="36" viewBox="0 0 36 36"><g><rect x="9" y="10" width="18" height="16" rx="4" fill="#e4e6eb"/><rect x="14" y="16" width="8" height="3" rx="1.5" fill="#3949ab"/></g></svg></span><span>Pages</span></div>
        <div class="fb-menu-tile tile-adcentre"><span class="fb-menu-icon"><svg width="36" height="36" viewBox="0 0 36 36"><g><rect x="7" y="10" width="22" height="16" rx="4" fill="#e4e6eb"/><polygon points="14,16 26,19 14,22" fill="#d84315"/></g></svg></span><span>Ad Centre</span></div>
        <div class="fb-menu-tile tile-finds"><span class="fb-menu-icon"><svg width="36" height="36" viewBox="0 0 36 36"><g><rect x="10" y="10" width="16" height="16" rx="4" fill="#e4e6eb"/><circle cx="18" cy="18" r="6" fill="#c2185b"/></g></svg></span><span>Finds</span></div>
        <div class="fb-menu-tile tile-events"><span class="fb-menu-icon"><svg width="36" height="36" viewBox="0 0 36 36"><g><rect x="9" y="10" width="18" height="16" rx="4" fill="#e4e6eb"/><rect x="14" y="20" width="8" height="3" rx="1.5" fill="#00897b"/><rect x="14" y="14" width="8" height="3" rx="1.5" fill="#e53935"/></g></svg></span><span>Events</span></div>
        <div class="fb-menu-tile tile-avatars"><span class="fb-menu-icon"><svg width="36" height="36" viewBox="0 0 36 36"><g><circle cx="18" cy="16" r="8" fill="#039be5"/><rect x="12" y="26" width="12" height="6" rx="3" fill="#e4e6eb"/></g></svg></span><span>Avatars</span></div>
      </div>
      <div style="margin:18px 0 0 0;padding:0 18px;">
        <div class="fb-menu-section" style="border-top:1px solid #e4e6eb;padding-top:14px;">
          <div class="fb-menu-expand" data-menu="help" style="display:flex;align-items:center;gap:10px;font-size:17px;font-weight:500;cursor:pointer;padding:10px 0;">
            <span style="font-size:22px;"></span> Help & Support
          </div>
          <div class="fb-menu-expand" data-menu="settings" style="display:flex;align-items:center;gap:10px;font-size:17px;font-weight:500;cursor:pointer;padding:10px 0;">
            <span style="font-size:22px;"></span> Settings & Privacy
          </div>
          <div class="fb-menu-expand" data-menu="meta" style="display:flex;align-items:center;gap:10px;font-size:17px;font-weight:500;cursor:pointer;padding:10px 0;">
            <span style="font-size:22px;">#</span> Also from Meta
          </div>
          <div class="fb-menu-meta" style="display:none;padding-left:30px;">
            <div class="fb-menu-meta-link">Threads</div>
            <div class="fb-menu-meta-link">Instagram</div>
            <div class="fb-menu-meta-link">Meta Business Suite</div>
            <div class="fb-menu-meta-link">WhatsApp</div>
          </div>
        </div>
        <button id="fb-menu-logout" style="width:100%;margin:28px 0 18px 0;padding:12px 0;background:#fff;border:1.5px solid #e4e6eb;border-radius:8px;font-size:17px;font-weight:600;color:#e53935;cursor:pointer;">Log out</button>
      </div>
    </div>
  </div>
  <style>
    .fb-menu-tile {
      background:#fff;
      border-radius:18px;
      box-shadow:0 1px 2px rgba(0,0,0,0.04);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:22px 0 16px 0;
      font-size:16px;
      font-weight:500;
      color:#222;
      cursor:pointer;
      transition:box-shadow 0.15s,background 0.18s;
      border:1.5px solid #e4e6eb;
    }
    .fb-menu-tile:hover {
      box-shadow:0 2px 8px rgba(24,119,242,0.10);
      background:#f4f8ff;
      border-color:#bcdcff;
    }
    .fb-menu-icon {
      font-size:0;
      width:36px;
      height:36px;
      display:flex;
      align-items:center;
      justify-content:center;
      margin-bottom:2px;
    }
    .fb-menu-section { margin-top:18px; }
    .fb-menu-expand { border-bottom:1px solid #f0f2f5; }
    .fb-menu-meta { margin-top:8px; }
    .fb-menu-meta-link {
      background:#fff;
      border-radius:8px;
      margin-bottom:8px;
      padding:10px 14px;
      font-size:15px;
      color:#222;
      box-shadow:0 1px 2px rgba(0,0,0,0.03);
      cursor:pointer;
    }
    #fb-menu-overlay { animation:fadeIn 0.18s; }
    @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
    @media (max-width:600px) {
      #fb-menu-sheet { max-width:100vw; }
      .fb-menu-tile { font-size:14px; padding:14px 0 10px 0; }
      .fb-menu-icon { font-size:22px; }
    }
  </style>
<!-- Add html5-qrcode library -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<!-- Scanner Modal -->
<div id="scanner-modal" style="display:none;position:fixed;z-index:99999;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.32);align-items:center;justify-content:center;">
  <div style="background:#fff;border-radius:18px;max-width:340px;width:96vw;padding:18px 10px 10px 10px;box-shadow:0 4px 24px rgba(24,119,242,0.13);position:relative;">
    <button id="scanner-close" style="position:absolute;top:8px;right:12px;background:none;border:none;font-size:2rem;color:#65676b;cursor:pointer;">&times;</button>
    <div style="font-size:19px;font-weight:700;text-align:center;margin-bottom:8px;">Scan QR/Barcode</div>
    <div id="qr-reader" style="width:300px;max-width:90vw;margin:0 auto;"></div>
    <div id="qr-result" style="margin-top:10px;text-align:center;font-size:15px;color:#1877f2;font-weight:600;"></div>
  </div>
</div>
<!-- Post Preview Modal (Facebook-style) -->
<div id="post-preview-modal" style="display:none;position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);align-items:center;justify-content:center;">
  <div style="background:#fff;padding:0 0 18px 0;border-radius:18px;box-shadow:0 2px 16px rgba(0,0,0,0.10);max-width:98vw;max-height:96vh;display:flex;flex-direction:column;align-items:center;min-width:320px;width:98vw;">
    <!-- Topbar -->
    <div style="width:100%;display:flex;align-items:center;justify-content:space-between;padding:14px 18px 0 18px;">
      <button id="post-cancel-btn" style="background:none;border:none;font-size:2rem;color:#65676b;cursor:pointer;">&times;</button>
      <span style="font-size:1.18rem;font-weight:600;">Create post</span>
      <button id="post-next-btn" style="background:none;border:none;font-size:1.1rem;color:#1877f2;font-weight:600;cursor:pointer;">Next</button>
    </div>
    <!-- Profile & Options -->
    <div style="width:100%;display:flex;align-items:center;gap:10px;padding:10px 18px 0 18px;">
      <img id="post-modal-profile-pic" src="default-profile.png" style="width:44px;height:44px;border-radius:50%;object-fit:cover;">
      <div style="display:flex;flex-direction:column;">
        <span id="post-modal-profile-name" style="font-weight:600;font-size:1.08rem;">User Name</span>
        <div style="display:flex;gap:6px;margin-top:2px;flex-wrap:wrap;">
          <button class="post-modal-opt" id="post-privacy-btn" style="background:#f0f2f5;border:none;border-radius:7px;padding:2px 10px;font-size:0.98rem;display:flex;align-items:center;gap:4px;cursor:pointer;"> Public</button>
          <button class="post-modal-opt" id="post-album-btn" style="background:#f0f2f5;border:none;border-radius:7px;padding:2px 10px;font-size:0.98rem;display:flex;align-items:center;gap:4px;cursor:pointer;">+ Album</button>
          <button class="post-modal-opt" id="post-instagram-btn" style="background:#f0f2f5;border:none;border-radius:7px;padding:2px 10px;font-size:0.98rem;display:flex;align-items:center;gap:4px;cursor:pointer;"> Off</button>
          <button class="post-modal-opt" id="post-ai-btn" style="background:#f0f2f5;border:none;border-radius:7px;padding:2px 10px;font-size:0.98rem;display:flex;align-items:center;gap:4px;cursor:pointer;">+ AI label off</button>
        </div>
      </div>
    </div>
    <!-- Caption -->
    <textarea id="post-caption-input" placeholder="Say something about this photo..." style="width:92%;margin:14px 0 0 0;font-size:17px;padding:10px 12px;border-radius:8px;border:1.5px solid #e4e6eb;resize:none;min-height:48px;"></textarea>
    <!-- Media Preview -->
    <div style="width:100%;display:flex;justify-content:center;margin:10px 0 0 0;">
      <img id="post-preview-img" style="max-width:98vw;max-height:340px;border-radius:12px;display:none;object-fit:contain;background:#f0f2f5;">
      <video id="post-preview-video" controls style="max-width:98vw;max-height:340px;border-radius:12px;display:none;background:#f0f2f5;"></video>
    </div>
    <!-- (Optional: Add Edit, Add music, Make 3D, etc. buttons here) -->
    <div style="width:100%;display:flex;gap:8px;justify-content:flex-start;padding:10px 0 0 18px;">
      <button style="background:#222;color:#fff;font-size:1rem;padding:6px 14px;border:none;border-radius:7px;cursor:pointer;">Edit</button>
      <button style="background:#fff;color:#222;font-size:1rem;padding:6px 14px;border:1.5px solid #e4e6eb;border-radius:7px;cursor:pointer;display:flex;align-items:center;gap:4px;"><span style="font-size:1.2em;"></span> Add music</button>
      <button style="background:#fff;color:#222;font-size:1rem;padding:6px 14px;border:1.5px solid #e4e6eb;border-radius:7px;cursor:pointer;display:flex;align-items:center;gap:4px;"><span style="font-size:1.2em;">3D</span> Make 3D</button>
    </div>
  </div>
</div>
<script>
const BASE_URL = "https://my-fb-server-2.onrender.com";

// Make these global for all handlers
let selectedPostFile = null;
let selectedPostType = null;

  function getProfileImage() {
    return localStorage.getItem('profileImage') || 'default-profile.png';
  }
  // Advanced Post System
  let currentUserFeed = [];
  let allPosts = [];
  let userPreferences = {};
  let viralPosts = [];
  
  // Initialize user preferences
  function initializeUserPreferences() {
    const userId = localStorage.getItem('userId') || generateUserId();
    localStorage.setItem('userId', userId);
    
    userPreferences = JSON.parse(localStorage.getItem('userPreferences') || '{}');
    if (!userPreferences[userId]) {
      userPreferences[userId] = {
        lastSeenPost: 0,
        viewedPosts: [],
        followedUsers: [],
        interests: [],
        feedPosition: 0,
        notifications: []
      };
      localStorage.setItem('userPreferences', JSON.stringify(userPreferences));
    }
  }
  
  function generateUserId() {
    return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  }
  
  // Calculate post score for viral ranking
  function calculatePostScore(post) {
    const now = Date.now();
    const timeDiff = (now - post.time) / (1000 * 60 * 60); // hours
    const engagement = (post.likes || 0) + (post.comments || 0) * 2 + (post.shares || 0) * 3;
    const viralScore = engagement / Math.pow(timeDiff + 2, 1.5); // Reddit's hot algorithm
    return viralScore;
  }
  
  // Get personalized feed for current user
  function getPersonalizedFeed() {
    const userId = localStorage.getItem('userId');
    const userPrefs = userPreferences[userId] || {};
    const followedUsers = userPrefs.followedUsers || [];
    
    // Get all posts
    allPosts = JSON.parse(localStorage.getItem('posts') || '[]');
    
    // Calculate viral scores
    viralPosts = allPosts.map(post => ({
      ...post,
      viralScore: calculatePostScore(post)
    })).sort((a, b) => b.viralScore - a.viralScore);
    
    // Create personalized feed
    let feed = [];
    
    // 1. Add viral posts first (top 20%)
    const viralCount = Math.min(3, Math.floor(viralPosts.length * 0.2));
    feed.push(...viralPosts.slice(0, viralCount));
    
    // 2. Add posts from followed users
    const followedPosts = allPosts.filter(post => 
      followedUsers.includes(post.userId) && 
      !feed.find(f => f.id === post.id)
    );
    feed.push(...followedPosts.slice(0, 5));
    
    // 3. Add recent posts from all users
    const recentPosts = allPosts
      .filter(post => !feed.find(f => f.id === post.id))
      .sort((a, b) => b.time - a.time)
      .slice(0, 10);
    feed.push(...recentPosts);
    
    // 4. Add some older posts for variety
    const olderPosts = allPosts
      .filter(post => !feed.find(f => f.id === post.id))
      .sort((a, b) => Math.random() - 0.5)
      .slice(0, 5);
    feed.push(...olderPosts);
    
    // Shuffle feed slightly for variety
    feed = shuffleArray(feed);
    
    return feed;
  }
  
  function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
  }
  
  // Render post feed from localStorage
  function timeAgo(ts) {
    const now = Date.now();
    const diff = Math.floor((now - ts) / 1000);
    if(diff < 60) return 'Just now';
    if(diff < 3600) return Math.floor(diff/60) + 'm';
    if(diff < 86400) return Math.floor(diff/3600) + 'h';
    if(diff < 604800) return Math.floor(diff/86400) + 'd';
    const d = new Date(ts);
    return d.toLocaleDateString();
  }
  // Helper: get current user name
  function getCurrentUserName() {
    return localStorage.getItem('profileName') || 'User Name';
  }
  // Modal state
  let postMenuModal = null;
  let editingPostIndex = null;
  // --- EMOJI REACTION BAR CONFIG ---
  const EMOJI_LIST = ['','','','','',''];
  // --- END EMOJI CONFIG ---

  function renderPosts() {
    var feed = document.getElementById('post-feed');
    if(!feed) return;
    
    // Initialize user preferences if not done
    if (!localStorage.getItem('userId')) {
      initializeUserPreferences();
    }
    
    // Get personalized feed
    currentUserFeed = getPersonalizedFeed();
    
    if(currentUserFeed.length === 0) {
      feed.innerHTML = '<div style="text-align:center;color:#888;margin:32px 0;">No posts yet.</div>';
      return;
    }
    const currentUser = getCurrentUserName();
    feed.innerHTML = currentUserFeed.map(function(post, i) {
      var postId = 'post-' + post.time;
      // Reaction logic
      let reactions = post.reactions || [];
      let userReaction = reactions.find(r => r.user === currentUser);
      // Count each emoji
      let emojiCount = {};
      reactions.forEach(r => { emojiCount[r.emoji] = (emojiCount[r.emoji]||0)+1; });
      // Sort emojis: user's first, then by count desc, then by emoji order
      let sortedEmojis = Object.keys(emojiCount).sort((a,b)=>{
        if(userReaction && userReaction.emoji===a) return -1;
        if(userReaction && userReaction.emoji===b) return 1;
        if(emojiCount[b]!==emojiCount[a]) return emojiCount[b]-emojiCount[a];
        return EMOJI_LIST.indexOf(a)-EMOJI_LIST.indexOf(b);
      });
      if(sortedEmojis.length>3) sortedEmojis = sortedEmojis.slice(0,3);
      // Total reactions
      let totalReactions = reactions.length;
      // Media rendering
      var media = '';
      let type = post.type;
      let url = post.url;
      if (url && type) {
        if(type.startsWith('image/')) {
          media = '<div style="position:relative;"><img src="'+url+'" alt="Post" style="width:100%;max-width:100%;border-radius:10px;margin-top:8px;cursor:pointer;" onerror="this.parentElement.style.display=\'none\';" onclick="openPostViewer('+i+')"></div>';
        } else if(type.startsWith('video/')) {
          media = '<div style="position:relative;"><video src="'+url+'" controls style="width:100%;max-width:100%;border-radius:10px;margin-top:8px;"></video></div>';
        } else if(type === 'dxf') {
          const projectName = post.caption.split('\n')[0].replace(' ', '');
          const thumbnail = post.thumbnail || null;
          
          media = `
            <div style="background:#f8f9fa;border:2px solid #e4e6ea;border-radius:10px;padding:15px;margin-top:8px;cursor:pointer;position:relative;" onclick="openPostViewer(${i})">
              ${thumbnail ? `
                <div style="margin-bottom:15px;">
                  <img src="${thumbnail}" alt="Thumbnail" style="width:100%;height:120px;object-fit:contain;object-position:center;border-radius:8px;border:1px solid #e4e6ea;background:#f8f9fa;">
                </div>
              ` : ''}
              <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                <div style="font-size:24px;"></div>
                <div>
                  <div style="font-weight:600;color:#1c1e21;">${projectName}</div>
                  <div style="font-size:13px;color:#65676b;">DXF </div>
                </div>
              </div>
              <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
                ${post.category ? `<span style=\"background:#1877f2;color:#fff;padding:4px 8px;border-radius:12px;font-size:12px;\">${post.category}</span>` : ''}
                ${post.tags ? post.tags.split(',').map(tag => `<span style=\"background:#f0f2f5;color:#65676b;padding:4px 8px;border-radius:12px;font-size:12px;\">${tag.trim()}</span>`).join('') : ''}
              </div>
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
                <button onclick="event.stopPropagation();downloadDXFFile('${url}', '${projectName}', ${post.price || 0}, '${post.name || post.user}')" style="background:#1877f2;color:#fff;border:none;padding:8px 16px;border-radius:6px;font-size:14px;cursor:pointer;"> </button>
                <div style="flex:1;text-align:center;">
                  ${post.price ? `<span style='color:#e53935;font-weight:700;font-size:18px;'>${post.price} </span>` : ''}
                </div>
                <button onclick="event.stopPropagation();viewDXFFile('${url}', '${projectName}', '${post.thumbnail || ''}')" style="background:#43a047;color:#fff;border:none;padding:8px 16px;border-radius:6px;font-size:14px;cursor:pointer;"></button>
              </div>
            </div>
          `;
        } else if(type === '3d') {
          const projectName = post.caption.split('\n')[0].replace(' ', '');
          const thumbnail = post.thumbnail || null;
          
          media = `
            <div style="background:#f8f9fa;border:2px solid #e4e6ea;border-radius:10px;padding:15px;margin-top:8px;cursor:pointer;position:relative;" onclick="openPostViewer(${i})">
              ${thumbnail ? `
                <div style="margin-bottom:15px;">
                  <img src="${thumbnail}" alt="Thumbnail" style="width:100%;height:120px;object-fit:contain;object-position:center;border-radius:8px;border:1px solid #e4e6ea;background:#f8f9fa;">
                </div>
              ` : ''}
              <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                <div style="font-size:24px;"></div>
                <div>
                  <div style="font-weight:600;color:#1c1e21;">${projectName}</div>
                  <div style="font-size:13px;color:#65676b;">3D </div>
                </div>
              </div>
              <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
                ${post.category ? `<span style=\"background:#1877f2;color:#fff;padding:4px 8px;border-radius:12px;font-size:12px;\">${post.category}</span>` : ''}
                ${post.tags ? post.tags.split(',').map(tag => `<span style=\"background:#f0f2f5;color:#65676b;padding:4px 8px;border-radius:12px;font-size:12px;\">${tag.trim()}</span>`).join('') : ''}
              </div>
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
                <button onclick="event.stopPropagation();downloadTDFile('${url}', '${projectName}', ${post.price || 0}, '${post.name || post.user}')" style="background:#1877f2;color:#fff;border:none;padding:8px 16px;border-radius:6px;font-size:14px;cursor:pointer;"> </button>
                <div style="flex:1;text-align:center;">
                  ${post.price ? `<span style='color:#e53935;font-weight:700;font-size:18px;'>${post.price} </span>` : ''}
                </div>
                <button onclick="event.stopPropagation();viewTDFile('${url}', '${projectName}', '${post.thumbnail || ''}')" style="background:#43a047;color:#fff;border:none;padding:8px 16px;border-radius:6px;font-size:14px;cursor:pointer;"></button>
              </div>
            </div>
          `;
        } else if(type === 'jd') {
          const projectName = post.caption.split('\n')[0].replace(' ', '');
          const thumbnail = post.thumbnail || null;
          
          media = `
            <div style="background:#f8f9fa;border:2px solid #e4e6ea;border-radius:10px;padding:15px;margin-top:8px;cursor:pointer;position:relative;" onclick="openPostViewer(${i})">
              ${thumbnail ? `
                <div style="margin-bottom:15px;">
                  <img src="${thumbnail}" alt="Thumbnail" style="width:100%;height:120px;object-fit:contain;object-position:center;border-radius:8px;border:1px solid #e4e6ea;background:#f8f9fa;">
                </div>
              ` : ''}
              <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                <div style="font-size:24px;"></div>
                <div>
                  <div style="font-weight:600;color:#1c1e21;">${projectName}</div>
                  <div style="font-size:13px;color:#65676b;">GD </div>
                </div>
              </div>
              <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
                ${post.category ? `<span style=\"background:#1877f2;color:#fff;padding:4px 8px;border-radius:12px;font-size:12px;\">${post.category}</span>` : ''}
                ${post.tags ? post.tags.split(',').map(tag => `<span style=\"background:#f0f2f5;color:#65676b;padding:4px 8px;border-radius:12px;font-size:12px;\">${tag.trim()}</span>`).join('') : ''}
              </div>
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
                <button onclick="event.stopPropagation();downloadJDFile('${url}', '${projectName}', ${post.price || 0}, '${post.name || post.user}')" style="background:#1877f2;color:#fff;border:none;padding:8px 16px;border-radius:6px;font-size:14px;cursor:pointer;"> </button>
                <div style="flex:1;text-align:center;">
                  ${post.price ? `<span style='color:#e53935;font-weight:700;font-size:18px;'>${post.price} </span>` : ''}
                </div>
                <button onclick="event.stopPropagation();viewJDFile('${url}', '${projectName}', '${post.thumbnail || ''}')" style="background:#43a047;color:#fff;border:none;padding:8px 16px;border-radius:6px;font-size:14px;cursor:pointer;"></button>
              </div>
            </div>
          `;
        }
      }
      // Reaction bar HTML (emoji left of count)
      let reactionBar = `<div style='display:flex;align-items:center;gap:4px;font-size:20px;margin-bottom:2px;'>`;
      if(sortedEmojis.length>0) {
        sortedEmojis.forEach(emoji => {
          reactionBar += `<span style='margin-right:0;'>${emoji}</span>`;
        });
      }
      if(totalReactions>0) {
        if(userReaction) {
          reactionBar += `<span style='font-size:15px;color:#222;margin-left:2px;'>${totalReactions>1?`   ${totalReactions-1} `:''}</span>`;
        } else {
          reactionBar += `<span style='font-size:15px;color:#222;margin-left:2px;'>${totalReactions} </span>`;
        }
      }
      reactionBar += `</div>`;
      // Like button color logic
      const liked = !!userReaction;
      // Main post HTML
      return `<div class='fb-post' style='margin-bottom:16px;' data-post-time='${post.time}'>
        <div class='fb-post-header' style='display:flex;align-items:center;justify-content:space-between;'>
          <div class='fb-post-header-left' style='display:flex;align-items:center;gap:10px;'>
            <a href="profile.html?user=${encodeURIComponent(post.name || post.user)}">
              <img src='${post.profileImage || 'default-profile.png'}' alt='Profile' class='fb-post-profile' style='width:44px;height:44px;border-radius:50%;object-fit:cover;'>
            </a>
            <div class='fb-post-info' style='display:flex;flex-direction:column;'>
              <a href="profile.html?user=${encodeURIComponent(post.name || post.user)}" class='fb-post-name' style='font-weight:600;font-size:16px;display:flex;align-items:center;gap:4px;text-decoration:none;color:#222;'>${post.name || 'User'}</a>
              <span class='fb-post-meta' style='font-size:14px;color:#65676b;display:flex;align-items:center;gap:6px;'>${timeAgo(post.time)} <span style='font-size:13px;color:#1877f2;font-weight:500;margin-left:2px;'>Public</span></span>
            </div>
          </div>
          <div class='fb-post-header-right' style='display:flex;align-items:center;gap:8px;'>
            ${post.name === getCurrentUserName() || post.user === getCurrentUserName() ? '' : '<button style="background:none;border:none;color:#1877f2;font-weight:600;font-size:15px;cursor:pointer;">Follow</button>'}
            <button class='post-menu-btn' title='Options' onclick='showPostMenu(${i})' style='font-size:22px;color:${post.name === getCurrentUserName() || post.user === getCurrentUserName() ? '#1877f2' : '#65676b'};background:none;border:none;cursor:pointer;'></button>
          </div>
        </div>
        <div class='fb-post-text' style='font-size:17px;margin:10px 0 8px 0;cursor:pointer;' onclick="openPostViewer(${i})">${post.caption ? post.caption.replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>') : ''}</div>
        ${media}
        <div style='display:flex;align-items:center;justify-content:space-between;gap:0;margin:10px 0 0 0;font-size:15px;color:#65676b;'>
          <span style='display:flex;flex-direction:row;align-items:center;justify-content:center;width:33.33%;margin-top:6px;'>
            ${liked ? `<span style='font-size:20px;margin-right:4px;'></span><span style='font-size:15px;color:#222;margin-right:4px;'></span>` : ''}
            <b id='like-count-${postId}'>${totalReactions||1}</b>
          </span>
          <span style='display:flex;flex-direction:row;align-items:center;justify-content:center;width:33.33%;margin-top:6px;'>
            <b id='comment-count-${postId}' style='margin-right:4px;'>${post.comment||1}</b> comments
          </span>
          <span style='display:flex;flex-direction:row;align-items:center;justify-content:center;width:33.33%;margin-top:6px;'>
            <b id='share-count-${postId}' style='margin-right:4px;'>${post.share||1}</b> shares
          </span>
        </div>
        <div style='background:#fff;display:flex;align-items:center;justify-content:space-around;margin-top:10px;padding:0;'>
          <button id='like-btn-${postId}' style='background:none;border:none;display:flex;align-items:center;gap:8px;font-size:18px;cursor:pointer;padding:16px 0;width:33.33%;justify-content:center;font-weight:500;color:${liked ? '#1877f2' : '#222'};position:relative;' onmousedown='window.__showEmojiPanel && window.__showEmojiPanel(event,"${postId}")' onclick='window.__likeClick && window.__likeClick("${postId}")'>
            <svg width='22' height='22' viewBox='0 0 24 24' fill='none' stroke='${liked ? '#1877f2' : '#65676b'}' stroke-width='2.1' stroke-linecap='round' stroke-linejoin='round' style='display:inline-block;vertical-align:middle;'><path d='M7 10v8a2 2 0 0 0 2 2h6.5a2 2 0 0 0 2-2v-7.5a1 1 0 0 0-1-1H14V7.5A2.5 2.5 0 0 0 11.5 5c-.6 0-1.1.2-1.5.5L7 10z'></path><path d='M7 10H5a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h2'></path></svg>
            <span> </span>
          </button>
          <button style='background:none;border:none;display:flex;align-items:center;gap:8px;font-size:18px;color:#65676b;cursor:pointer;padding:16px 0;width:33.33%;justify-content:center;font-weight:500;' onclick='openCommentModal("${postId}")'>
            <svg width='22' height='22' viewBox='0 0 24 24' fill='none' stroke='#65676b' stroke-width='2.1' stroke-linecap='round' stroke-linejoin='round' style='display:inline-block;vertical-align:middle;'><ellipse cx='12' cy='12' rx='9' ry='7'></ellipse><path d='M12 19c-2.5 0-4.5-1.5-4.5-3.5'></path></svg>
             
          </button>
          <button style='background:none;border:none;display:flex;align-items:center;gap:8px;font-size:18px;color:#65676b;cursor:pointer;padding:16px 0;width:33.33%;justify-content:center;font-weight:500;' onclick='incrementShare("${postId}")'>
            <svg width='22' height='22' viewBox='0 0 24 24' fill='none' stroke='#65676b' stroke-width='2.1' stroke-linecap='round' stroke-linejoin='round' style='display:inline-block;vertical-align:middle;'><path d='M4 12v-2a2 2 0 0 1 2-2h7.5'></path><path d='M14 7l5 5-5 5'></path></svg>
             
          </button>
        </div>
        <div id='emoji-panel-${postId}' style='display:none;position:absolute;z-index:9999;bottom:60px;left:50%;transform:translateX(-50%);background:#fff;border-radius:30px;box-shadow:0 2px 12px rgba(0,0,0,0.13);padding:8px 16px;gap:8px;align-items:center;'>
          ${EMOJI_LIST.map(e=>`<span style='font-size:2rem;cursor:pointer;padding:2px 4px;' onclick='window.__selectEmoji && window.__selectEmoji("${postId}","${e}")'>${e}</span>`).join('')}
        </div>
      </div>`;
    }).join('');
    // After rendering, set up emoji panel events
    posts.forEach(function(post) {
      var postId = 'post-' + post.time;
      // Hide panel on click outside
      document.addEventListener('mousedown', function(e) {
        var panel = document.getElementById('emoji-panel-'+postId);
        if(panel && panel.style.display==='flex' && !panel.contains(e.target)) panel.style.display='none';
      });
    });
  }

  // Emoji panel logic
  window.__showEmojiPanel = function(e, postId) {
    if(e.button!==0 && e.button!==2) return; // left or right click
    e.preventDefault();
    var panel = document.getElementById('emoji-panel-'+postId);
    if(panel) {
      panel.style.display = 'flex';
      setTimeout(()=>{
        document.addEventListener('mousedown', function handler(ev){
          if(panel && !panel.contains(ev.target)) { panel.style.display='none'; document.removeEventListener('mousedown', handler); }
        });
      }, 10);
    }
  };
  window.__selectEmoji = async function(postId, emoji) {
    var user = getCurrentUserName();
    await fetch(`${BASE_URL}/react`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ postId, user, emoji })
    });
    await loadPosts();
  };
  // Like button click: only , toggle if already reacted
  window.__likeClick = async function(postId) {
    var user = getCurrentUserName();
    var posts = JSON.parse(localStorage.getItem('posts')||'[]');
    var post = posts.find(p=>('post-'+p.time)===postId);
    if(!post) return;
    var reactions = post.reactions||[];
    var userReaction = reactions.find(r=>r.user===user);
    if(userReaction && userReaction.emoji==='') {
      // Remove like
      await fetch(`${BASE_URL}/react`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ postId, user, emoji: '' })
      });
      await loadPosts();
    } else {
      // Set like only
      await fetch(`${BASE_URL}/react`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ postId, user, emoji: '' })
      });
      await loadPosts();
    }
  };

      document.addEventListener('DOMContentLoaded', function() {
      renderPosts();
      updateNotificationBadge(); // Update notification badge on load
      
      var mindPic = document.getElementById('mind-profile-pic');
      var menuPic = document.getElementById('menu-profile-pic');
      var img = getProfileImage();
      if(mindPic) mindPic.src = img;
      if(menuPic) menuPic.src = img;
      
      // Add notification click event
      var notificationsNav = document.getElementById('notifications-nav');
      if(notificationsNav) {
        notificationsNav.onclick = function(e) {
          e.preventDefault();
          openNotificationsModal();
        };
      }

    // Search functionality
    var searchBtn = document.getElementById('search-btn');
    if(searchBtn) {
      searchBtn.onclick = function() {
        openSearchModal();
      };
    }

    // Search category buttons
    document.querySelectorAll('.search-category').forEach(function(btn) {
      btn.onclick = function() {
        document.querySelectorAll('.search-category').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        const category = this.getAttribute('data-category');
        performSearch(document.getElementById('searchInput').value, category);
      };
    });

    var mindPicLink = document.getElementById('mind-profile-pic');
    if(mindPicLink) mindPicLink.onclick = function() {
      window.location.href = 'profile.html';
    };
    // Add click event for menu button
    var menuProfileLink = document.getElementById('menu-profile-link');
    if(menuProfileLink) menuProfileLink.onclick = function(e) {
      e.preventDefault();
      document.getElementById('fb-menu-overlay').style.display = 'block';
      // Set user pic
      var userPic = localStorage.getItem('profileImage') || 'default-profile.png';
      document.getElementById('fb-menu-user-pic').src = userPic;
      // Set user name
      var userName = localStorage.getItem('profileName') || 'User Name';
      document.getElementById('fb-menu-user-name').textContent = userName;
    };
    document.getElementById('fb-menu-close').onclick = function() {
      document.getElementById('fb-menu-overlay').style.display = 'none';
    };
    document.getElementById('fb-menu-overlay').onclick = function(e) {
      if(e.target === this) this.style.display = 'none';
    };
    // Expand/collapse meta section
    document.querySelectorAll('.fb-menu-expand').forEach(function(el) {
      el.onclick = function() {
        var meta = document.querySelector('.fb-menu-meta');
        if(this.dataset.menu === 'meta') {
          meta.style.display = meta.style.display === 'block' ? 'none' : 'block';
        }
      };
    });
    document.getElementById('fb-menu-logout').onclick = function() {
      alert('Logged out! (Implement your logout logic here)');
    };

    var plusBtn = document.getElementById('plus-menu-btn');
    var plusMenu = document.getElementById('plus-menu-popup');
    if(plusBtn && plusMenu) {
      plusBtn.onclick = function(e) {
        e.stopPropagation();
        plusMenu.style.display = plusMenu.style.display === 'block' ? 'none' : 'block';
      };
      document.addEventListener('click', function(e) {
        if(plusMenu.style.display === 'block') plusMenu.style.display = 'none';
      });
      plusMenu.onclick = function(e) { e.stopPropagation(); };
      
      // Add click handlers for plus menu items
      
      document.querySelector('.plus-dxf').onclick = function() {
        plusMenu.style.display = 'none';
        openDXFModal();
      };
      
      document.querySelector('.plus-eng').onclick = function() {
        plusMenu.style.display = 'none';
        openTDModal();
      };
      
      document.querySelector('.plus-jd').onclick = function() {
        plusMenu.style.display = 'none';
        openJDModal();
      };
    }
  });
  // Show post menu modal
  function showPostMenu(index) {
    if(postMenuModal) postMenuModal.remove();
    const posts = JSON.parse(localStorage.getItem('posts') || '[]');
    const post = posts[index];
    const currentUser = getCurrentUserName();
    const isOwner = post.name === currentUser || post.user === currentUser;
    
    postMenuModal = document.createElement('div');
    postMenuModal.className = 'post-menu-modal';
    
    let menuHTML = `
      <div class="post-menu-sheet">
        <button onclick="window.__pinPost(${index})"><span class='icon'></span> Pin post</button>
        <button onclick="window.__savePost(${index})"><span class='icon'></span> Save post</button>
    `;
    
    //    ,    
    if (isOwner) {
      menuHTML += `
        <button onclick="window.__editPost(${index})"><span class='icon'></span> Edit Post</button>
        <button onclick="window.__privacyPost(${index})"><span class='icon'></span> Edit Privacy</button>
        <button onclick="window.__hidePost(${index})"><span class='icon'></span> Hide from profile</button>
        <div class='sheet-divider'></div>
        <button class='danger' onclick="window.__deletePost(${index})"><span class='icon'></span> Delete</button>
      `;
    } else {
      //      
      menuHTML += `
        <button onclick="window.__reportPost(${index})"><span class='icon'></span> Report post</button>
        <button onclick="window.__blockUser(${index})"><span class='icon'></span> Block user</button>
      `;
    }
    
    menuHTML += `
        <button onclick="window.__notifyPost(${index})"><span class='icon'></span> Be notified about this post</button>
        <div class='sheet-bottom'><button onclick="window.__closePostMenu()" style="background:none;border:none;font-size:18px;color:#1877f2;">Close</button></div>
      </div>
    `;
    
    postMenuModal.innerHTML = menuHTML;
    postMenuModal.onclick = function(e) { if(e.target === postMenuModal) postMenuModal.remove(); };
    document.body.appendChild(postMenuModal);
  }
  window.__closePostMenu = function() { if(postMenuModal) postMenuModal.remove(); };
  window.__deletePost = function(index) {
    let posts = JSON.parse(localStorage.getItem('posts') || '[]');
    posts.splice(index, 1);
    localStorage.setItem('posts', JSON.stringify(posts));
    renderPosts();
    window.__closePostMenu();
  };
  window.__editPost = function(index) {
    let posts = JSON.parse(localStorage.getItem('posts') || '[]');
    const post = posts[index];
    window.__closePostMenu();
    editingPostIndex = index;
    // Show inline edit UI
    const feed = document.getElementById('post-feed');
    const postDiv = feed.children[index];
    const textDiv = postDiv.querySelector('.fb-post-text');
    const oldText = post.caption || '';
    textDiv.innerHTML = `<textarea id='edit-caption' style='width:98%;font-size:16px;padding:8px;border-radius:6px;border:1.5px solid #e4e6eb;'>${oldText.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</textarea><br><button id='save-edit-caption' style='background:#1877f2;color:#fff;padding:6px 18px;border:none;border-radius:6px;margin-top:6px;'>Save</button> <button id='cancel-edit-caption' style='background:#e4e6eb;color:#222;padding:6px 14px;border:none;border-radius:6px;margin-top:6px;'>Cancel</button>`;
    document.getElementById('save-edit-caption').onclick = function() {
      const newText = document.getElementById('edit-caption').value;
      posts[index].caption = newText;
      localStorage.setItem('posts', JSON.stringify(posts));
      renderPosts();
    };
    document.getElementById('cancel-edit-caption').onclick = function() {
      renderPosts();
    };
  };
  // Send notification to all users
  function sendNotificationToAllUsers(post) {
    const allUsers = Object.keys(userPreferences);
    const currentUser = getCurrentUserName();
    
    allUsers.forEach(userId => {
      const userPrefs = userPreferences[userId];
      if (!userPrefs.notifications) {
        userPrefs.notifications = [];
      }
      
      //     
      if (userId !== localStorage.getItem('userId')) {
        const notification = {
          id: Date.now() + Math.random(),
          type: 'new_post',
          message: `${currentUser}    `,
          postId: post.time,
          postCaption: post.caption ? post.caption.substring(0, 50) + '...' : ' ',
          timestamp: Date.now(),
          read: false,
          postType: post.type ? (post.type.startsWith('image/') ? '' : post.type.startsWith('video/') ? '' : post.type === 'dxf' ? 'DXF ' : post.type === '3d' ? '3D ' : post.type === 'jd' ? ' ' : '') : ''
        };
        
        userPrefs.notifications.unshift(notification);
        
        //  50  
        if (userPrefs.notifications.length > 50) {
          userPrefs.notifications = userPrefs.notifications.slice(0, 50);
        }
      }
    });
    
    localStorage.setItem('userPreferences', JSON.stringify(userPreferences));
  }
  
  // Get unread notification count
  function getUnreadNotificationCount() {
    const userId = localStorage.getItem('userId');
    const userPrefs = userPreferences[userId] || {};
    const notifications = userPrefs.notifications || [];
    return notifications.filter(n => !n.read).length;
  }
  
  // Mark notification as read
  function markNotificationAsRead(notificationId) {
    const userId = localStorage.getItem('userId');
    const userPrefs = userPreferences[userId] || {};
    const notifications = userPrefs.notifications || [];
    
    const notification = notifications.find(n => n.id === notificationId);
    if (notification) {
      notification.read = true;
      localStorage.setItem('userPreferences', JSON.stringify(userPreferences));
    }
  }
  
  // Dummy handlers for other options
  window.__pinPost = function() { alert('Pin post: Not implemented'); window.__closePostMenu(); };
  window.__savePost = function() { alert('Save post: Not implemented'); window.__closePostMenu(); };
  window.__privacyPost = function() { alert('Edit privacy: Not implemented'); window.__closePostMenu(); };
  window.__hidePost = function() { alert('Hide from profile: Not implemented'); window.__closePostMenu(); };
  window.__notifyPost = function() { alert('Be notified: Not implemented'); window.__closePostMenu(); };
  window.__reportPost = function() { alert('Post reported successfully!'); window.__closePostMenu(); };
  window.__blockUser = function() { alert('User blocked successfully!'); window.__closePostMenu(); };

  var scannerNav = Array.from(document.querySelectorAll('.fb-bottom-nav .nav-item')).find(a => a.textContent.trim().includes('Scanner'));
  var scannerModal = document.getElementById('scanner-modal');
  var scannerClose = document.getElementById('scanner-close');
  var qrReader = null;
  if(scannerNav && scannerModal && scannerClose) {
    scannerNav.onclick = function(e) {
      e.preventDefault();
      scannerModal.style.display = 'flex';
      document.getElementById('qr-result').textContent = '';
      if(!qrReader) {
        qrReader = new Html5Qrcode("qr-reader");
      }
      qrReader.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 220 },
        function(decodedText, decodedResult) {
          document.getElementById('qr-result').textContent = 'Result: ' + decodedText;
          setTimeout(function() {
            scannerModal.style.display = 'none';
            qrReader.stop();
          }, 1200);
        },
        function(errorMessage) { /* ignore errors */ }
      );
    };
    scannerClose.onclick = function() {
      scannerModal.style.display = 'none';
      if(qrReader) qrReader.stop();
    };
    scannerModal.onclick = function(e) {
      if(e.target === scannerModal) {
        scannerModal.style.display = 'none';
        if(qrReader) qrReader.stop();
      }
    };
  }

  // --- SERVER API FUNCTIONS ---
  async function fetchStories() {
    const res = await fetch(`${BASE_URL}/stories`);
    if (!res.ok) return [];
    return await res.json(); // [{url, time, user, type}]
  }
  async function uploadStory(file) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('userName', localStorage.getItem('profileName') || 'User Name');
    formData.append('profileImage', localStorage.getItem('profileImage') || 'default-profile.png');
    const res = await fetch(`${BASE_URL}/upload`, {
      method: 'POST',
      body: formData
    });
    if (!res.ok) {
      alert('Upload failed!');
      return null;
    }
    return await res.json();
  }

  // --- STORY LOADING ---
  const storyBoxes = Array.from(document.querySelectorAll('.fb-stories .fb-story')).filter(box => !box.classList.contains('create'));
  async function loadStoryVideos() {
    const stories = await fetchStories();
    const seen = JSON.parse(localStorage.getItem('seenStories') || '[]');
    const unseenStories = stories.filter(story => !seen.includes(story.time));
    const storiesContainer = document.querySelector('.fb-stories');
    // Remove all except the create box
    storiesContainer.querySelectorAll('.fb-story:not(.create)').forEach(e => e.remove());
    unseenStories.forEach(story => {
      const box = document.createElement('div');
      box.className = 'fb-story';
      box.style.cursor = 'pointer';
      if (story.type && story.type.startsWith('video/')) {
        const video = document.createElement('video');
        video.src = story.url;
        video.style.width = '100%';
        video.style.height = '100%';
        video.style.objectFit = 'cover';
        video.style.borderRadius = '16px';
        box.appendChild(video);
      } else if (story.type && story.type.startsWith('image/')) {
        const img = document.createElement('img');
        img.src = story.url;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '16px';
        box.appendChild(img);
      }
      // Profile image (clickable)
      const profileImg = document.createElement('img');
      profileImg.src = story.profileImage || 'default-profile.png';
      profileImg.className = 'story-profile';
      profileImg.style.cursor = 'pointer';
      profileImg.onclick = function(e) {
        e.stopPropagation();
        window.location.href = `profile.html?user=${encodeURIComponent(story.userName)}`;
      };
      box.appendChild(profileImg);
      // Name (clickable)
      const nameDiv = document.createElement('div');
      nameDiv.className = 'story-name';
      nameDiv.textContent = story.userName || 'User Name';
      nameDiv.style.cursor = 'pointer';
      nameDiv.onclick = function(e) {
        e.stopPropagation();
        window.location.href = `profile.html?user=${encodeURIComponent(story.userName)}`;
      };
      box.appendChild(nameDiv);
      box.onclick = function() {
        openStoryViewerModal(story);
      };
      storiesContainer.appendChild(box);
    });
  }
  loadStoryVideos();

  // --- STORY UPLOAD FLOW ---
  const createStoryBox = document.getElementById('create-story-box');
  const storyInput = document.getElementById('story-video-input');
  const storyModal = document.getElementById('story-modal');
  const storyPreview = document.getElementById('story-video-preview');
  const storyNextBtn = document.getElementById('story-next-btn');
  const storyCancelBtn = document.getElementById('story-cancel-btn');
  let selectedStoryFile = null;

  if (createStoryBox && storyInput) {
    createStoryBox.onclick = function() {
      storyInput.value = '';
      storyInput.click();
    };
    storyInput.onchange = function(e) {
      const file = e.target.files[0];
      if (file) {
        if (file.size > 2 * 1024 * 1024 * 1024) {
          alert('Video size must be 2GB or less.');
          return;
        }
        if (file.type.startsWith('video/')) {
          const reader = new FileReader();
          reader.onload = function(evt) {
            storyPreview.src = evt.target.result;
            selectedStoryFile = file;
            storyModal.style.display = 'flex';
          };
          reader.readAsDataURL(file);
        } else {
          alert('Please select a video file.');
        }
      }
    };
  }
  if (storyNextBtn && storyPreview && storyModal) {
    storyNextBtn.onclick = async function() {
      if (!selectedStoryFile) return;
      // Find next empty box
      const stories = await fetchStories();
      let targetIndex = stories.findIndex(v => !v);
      if (targetIndex === -1) {
        targetIndex = storyBoxes.findIndex(box => box.innerHTML.trim() === '');
      }
      if (targetIndex === -1) {
        alert('No empty story box available!');
        storyModal.style.display = 'none';
        return;
      }
      const box = storyBoxes[targetIndex];
      box.innerHTML = `<div class='story-loading'><div class='spinner'></div></div>`;
      // Upload to server
      const uploaded = await uploadStory(selectedStoryFile);
      setTimeout(() => {
        box.innerHTML = '';
        if (uploaded && uploaded.type === 'video') {
          const video = document.createElement('video');
          video.src = uploaded.url;
          video.style.width = '100%';
          video.style.height = '100%';
          video.style.objectFit = 'cover';
          video.style.borderRadius = '16px';
          box.appendChild(video);
          video.load();
          video.pause();
          video.currentTime = 0;
        }
        loadStoryVideos(); // Refresh all boxes
      }, 2000);
      storyModal.style.display = 'none';
      selectedStoryFile = null;
    };
  }
  if (storyCancelBtn && storyPreview && storyModal) {
    storyCancelBtn.onclick = function() {
      storyModal.style.display = 'none';
      storyPreview.src = '';
      selectedStoryFile = null;
    };
  }

  // Story viewer modal logic
  const storyViewerModal = document.getElementById('story-viewer-modal');
  const storyViewerVideo = document.getElementById('story-viewer-video');
  const storyViewerClose = document.getElementById('story-viewer-close');
  const storyViewerMute = document.getElementById('story-viewer-mute');
  const storyViewerMuteIcon = document.getElementById('story-viewer-mute-icon');
  const storyViewerProgress = document.getElementById('story-viewer-progress');
  const storyViewerProfile = document.getElementById('story-viewer-profile');
  const storyViewerName = document.getElementById('story-viewer-name');
  const storyViewerTime = document.getElementById('story-viewer-time');
  // Placeholder data for demo
  function setStoryViewerInfo() {
    // You can set these from your story data if available
    storyViewerProfile.src = localStorage.getItem('profileImage') || 'default-profile.png';
    storyViewerName.textContent = localStorage.getItem('profileName') || 'User Name';
    storyViewerTime.textContent = '4h';
  }
  // Add click event to each story video box
  storyBoxes.forEach(box => {
    box.onclick = function() {
      const video = box.querySelector('video');
      if (video && video.src) {
        video.pause();
        video.currentTime = 0;
        storyViewerVideo.src = video.src;
        storyViewerModal.style.display = 'flex';
        storyViewerVideo.currentTime = 0;
        storyViewerVideo.controls = true;
        storyViewerVideo.muted = false;
        storyViewerMuteIcon.textContent = '';
        setStoryViewerInfo();
        storyViewerVideo.play();
      }
    };
  });
  // Close button
  storyViewerClose.onclick = function() {
    storyViewerModal.style.display = 'none';
    storyViewerVideo.pause();
    storyViewerVideo.src = '';
    storyViewerProgress.style.width = '0%';
    storyViewerMenuPopup.style.display = 'none';
  };
  // Video ends: auto close
  storyViewerVideo.onended = function() {
    storyViewerModal.style.display = 'none';
    storyViewerVideo.src = '';
    storyViewerProgress.style.width = '0%';
  };
  // Click outside video closes modal
  storyViewerModal.onclick = function(e) {
    if (e.target === storyViewerModal) {
      storyViewerModal.style.display = 'none';
      storyViewerVideo.pause();
      storyViewerVideo.src = '';
      storyViewerProgress.style.width = '0%';
      storyViewerMenuPopup.style.display = 'none';
    }
  };
  // Mute/unmute button
  storyViewerMute.onclick = function(e) {
    e.stopPropagation();
    storyViewerVideo.muted = !storyViewerVideo.muted;
    storyViewerMuteIcon.textContent = storyViewerVideo.muted ? '' : '';
  };
  // Progress bar update
  storyViewerVideo.ontimeupdate = function() {
    if (storyViewerVideo.duration) {
      const percent = (storyViewerVideo.currentTime / storyViewerVideo.duration) * 100;
      storyViewerProgress.style.width = percent + '%';
    }
  };
  storyViewerVideo.onloadedmetadata = function() {
    storyViewerProgress.style.width = '0%';
  };
  // Emoji reaction click effect
  document.querySelectorAll('#story-viewer-reactions .story-emoji').forEach(emoji => {
    emoji.onclick = function(e) {
      e.stopPropagation();
      emoji.style.transform = 'scale(1.4)';
      setTimeout(() => { emoji.style.transform = 'scale(1)'; }, 200);
      // You can add your own logic here (e.g., send reaction)
    };
  });
  const storyViewerMenu = document.getElementById('story-viewer-menu');
  const storyViewerMenuPopup = document.getElementById('story-viewer-menu-popup');
  // Show/hide menu popup
  storyViewerMenu.onclick = function(e) {
    e.stopPropagation();
    if (storyViewerMenuPopup.style.display === 'block') {
      storyViewerMenuPopup.style.display = 'none';
    } else {
      storyViewerMenuPopup.style.display = 'block';
    }
  };
  // Hide menu on outside click or modal close
  document.addEventListener('click', function(e) {
    if (storyViewerMenuPopup.style.display === 'block' && !storyViewerMenuPopup.contains(e.target) && e.target !== storyViewerMenu) {
      storyViewerMenuPopup.style.display = 'none';
    }
  });
  // Menu item actions (real functionality)
  document.querySelectorAll('.story-menu-item').forEach(btn => {
    btn.onclick = function(e) {
      e.stopPropagation();
      const action = btn.getAttribute('data-action');
      // Find the current video src
      const currentSrc = storyViewerVideo.src;
      // Find the story box index for this video
      let videos = getValidStories();
      let boxIndex = videos.findIndex(v => v && v.src === currentSrc);
      if (action === 'delete') {
        if (boxIndex !== -1) {
          videos.splice(boxIndex, 1);
          localStorage.setItem('storyVideos', JSON.stringify(videos));
          // Remove video from box visually
          storyBoxes[boxIndex].innerHTML = '';
          loadStoryVideos(); // Update all story boxes instantly
        }
        storyViewerModal.style.display = 'none';
      } else if (action === 'save') {
        if (currentSrc) {
          let gallery = JSON.parse(localStorage.getItem('savedGallery') || '[]');
          if (!gallery.includes(currentSrc)) {
            gallery.push(currentSrc);
            localStorage.setItem('savedGallery', JSON.stringify(gallery));
            renderSavedGallery();
          }
        }
      } else if (action === 'print') {
        if (currentSrc) {
          const win = window.open('');
          win.document.write(`<video src='${currentSrc}' style='width:100%' controls autoplay></video>`);
          win.document.close();
          win.focus();
          setTimeout(() => { win.print(); }, 500);
        }
      } else if (action === 'hide') {
        if (boxIndex !== -1) {
          storyBoxes[boxIndex].style.display = 'none';
        }
        storyViewerModal.style.display = 'none';
      }
      storyViewerMenuPopup.style.display = 'none';
    };
  });

  // Render saved gallery
  function renderSavedGallery() {
    const gallery = JSON.parse(localStorage.getItem('savedGallery') || '[]');
    const list = document.getElementById('saved-gallery-list');
    if (!list) return;
    if (gallery.length === 0) {
      list.innerHTML = '<div style="color:#888;font-size:15px;">No saved videos yet.</div>';
      return;
    }
    list.innerHTML = '';
    gallery.forEach(src => {
      const wrap = document.createElement('div');
      wrap.style.width = '90px';
      wrap.style.height = '160px';
      wrap.style.background = '#f0f2f5';
      wrap.style.borderRadius = '14px';
      wrap.style.overflow = 'hidden';
      wrap.style.display = 'flex';
      wrap.style.alignItems = 'center';
      wrap.style.justifyContent = 'center';
      const video = document.createElement('video');
      video.src = src;
      video.controls = true;
      video.style.width = '100%';
      video.style.height = '100%';
      video.style.objectFit = 'cover';
      video.style.borderRadius = '14px';
      wrap.appendChild(video);
      list.appendChild(wrap);
    });
  }
  renderSavedGallery();

  function openStoryViewerModal(story) {
    if (!story) return;
    if (story.type && story.type.startsWith('video/')) {
      storyViewerVideo.src = story.url;
      storyViewerVideo.style.display = '';
      storyViewerVideo.currentTime = 0;
      storyViewerVideo.controls = true;
      storyViewerVideo.muted = false;
      storyViewerMuteIcon.textContent = '';
      storyViewerModal.style.display = 'flex';
      //      delay
      setTimeout(() => {
        storyViewerVideo.play();
      }, 100);
    } else {
      storyViewerVideo.style.display = 'none';
      //         
    }
    // , ,    
    storyViewerProfile.src = story.profileImage || 'default-profile.png';
    storyViewerName.textContent = story.userName || 'User Name';
    const hoursAgo = Math.floor((Date.now() - story.time) / (60 * 60 * 1000));
    storyViewerTime.textContent = hoursAgo > 0 ? hoursAgo + 'h' : 'Just now';
    storyViewerProgress.style.width = '0%';
    storyViewerMenuPopup.style.display = 'none';
    // Mark as seen for this user
    let seen = JSON.parse(localStorage.getItem('seenStories') || '[]');
    if (!seen.includes(story.time)) {
      seen.push(story.time);
      localStorage.setItem('seenStories', JSON.stringify(seen));
    }
  }

  // --- PHOTO/VIDEO POST PREVIEW & UPLOAD ---
  var openCreatePost = document.getElementById('open-create-post');
  var fileInput = document.getElementById('create-post-file');
  var postPreviewModal = document.getElementById('post-preview-modal');
  var postPreviewImg = document.getElementById('post-preview-img');
  var postPreviewVideo = document.getElementById('post-preview-video');
  var postCaptionInput = document.getElementById('post-caption-input');
  var postNextBtn = document.getElementById('post-next-btn');
  var postCancelBtn = document.getElementById('post-cancel-btn');
  var postModalProfilePic = document.getElementById('post-modal-profile-pic');
  var postModalProfileName = document.getElementById('post-modal-profile-name');

  if(openCreatePost && fileInput) {
    openCreatePost.onclick = function() { fileInput.value = ''; fileInput.click(); };
    fileInput.onchange = function(e) {
      var file = e.target.files[0];
      if(file) {
        selectedPostFile = file;
        selectedPostType = file.type.startsWith('video/') ? 'video' : 'image';
        postModalProfilePic.src = localStorage.getItem('profileImage') || 'default-profile.png';
        postModalProfileName.textContent = localStorage.getItem('profileName') || 'User Name';
        if(selectedPostType === 'image') {
          var reader = new FileReader();
          reader.onload = function(evt) {
            postPreviewImg.src = evt.target.result;
            postPreviewImg.style.display = '';
            postPreviewVideo.style.display = 'none';
            postPreviewModal.style.display = 'flex';
          };
          reader.readAsDataURL(file);
        } else if(selectedPostType === 'video') {
          var reader = new FileReader();
          reader.onload = function(evt) {
            postPreviewVideo.src = evt.target.result;
            postPreviewVideo.style.display = '';
            postPreviewImg.style.display = 'none';
            postPreviewModal.style.display = 'flex';
          };
          reader.readAsDataURL(file);
        }
        postCaptionInput.value = '';
      } else {
        selectedPostFile = null;
        selectedPostType = null;
      }
    };
  }
  if(postNextBtn && postPreviewModal) {
    postNextBtn.onclick = async function() {
      if(!selectedPostFile) {
        alert('No file selected!');
        return;
      }
      postPreviewModal.style.display = 'none';
      postPreviewImg.style.display = 'none';
      postPreviewVideo.style.display = 'none';
      var posts = JSON.parse(localStorage.getItem('posts') || '[]');
      posts.unshift({ uploading: true });
      localStorage.setItem('posts', JSON.stringify(posts));
      renderPosts();
      const formData = new FormData();
      formData.append('file', selectedPostFile);
      formData.append('caption', postCaptionInput.value);
      formData.append('user', localStorage.getItem('profileName') || 'User Name');
      formData.append('profileImage', localStorage.getItem('profileImage') || 'default-profile.png');
      // Debug: log what is being sent
      console.log('Uploading post:', selectedPostFile, postCaptionInput.value);
      let errorOccurred = false;
      try {
        const res = await fetch(`${BASE_URL}/post`, {
          method: 'POST',
          body: formData
        });
        if (!res.ok) {
          const errText = await res.text();
          alert('Upload failed: ' + errText);
          errorOccurred = true;
        }
      } catch (err) {
        alert('Upload failed: ' + err.message);
        errorOccurred = true;
      }
      posts = JSON.parse(localStorage.getItem('posts') || '[]');
      if(posts.length && posts[0].uploading) posts.shift();
      localStorage.setItem('posts', JSON.stringify(posts));
      await loadPosts();
      
      // Send notification to all users about new post
      if (!errorOccurred) {
        const newPost = {
          name: localStorage.getItem('profileName') || 'User Name',
          caption: postCaptionInput.value,
          type: selectedPostType === 'video' ? 'video/mp4' : 'image/jpeg',
          time: Date.now()
        };
        sendNotificationToAllUsers(newPost);
        updateNotificationBadge(); // Update badge for all users
      }
      
      selectedPostFile = null;
      selectedPostType = null;
    };
  }
  if(postCancelBtn && postPreviewModal) {
    postCancelBtn.onclick = function() {
      postPreviewModal.style.display = 'none';
      postPreviewImg.style.display = 'none';
      postPreviewVideo.style.display = 'none';
      selectedPostFile = null;
      selectedPostType = null;
    };
  }

  // Add these functions to the script:
  function incrementLike(id) {
    const currentUser = getCurrentUserName();
    const userLikeKey = id + '-like-user-' + currentUser;
    let liked = localStorage.getItem(userLikeKey) === '1';
    let count = parseInt(localStorage.getItem(id+'-like')||'1',10);
    if (!liked) {
      count++;
      localStorage.setItem(userLikeKey, '1');
    } else {
      count = Math.max(1, count-1);
      localStorage.setItem(userLikeKey, '0');
    }
    localStorage.setItem(id+'-like',count);
    document.getElementById('like-count-'+id).textContent = count;
    // Change button color immediately
    const likeBtn = document.getElementById('like-btn-' + id);
    if (likeBtn) {
      likeBtn.style.color = !liked ? '#1877f2' : '#222';
      const svg = likeBtn.querySelector('svg');
      if (svg) svg.setAttribute('stroke', !liked ? '#1877f2' : '#65676b');
    }
  }

  function incrementShare(id) {
    let count = parseInt(localStorage.getItem(id+'-share')||'0',10)+1;
    localStorage.setItem(id+'-share',count);
    document.getElementById('share-count-'+id).textContent = count;
  }

  // Add this if not present
  async function fetchPosts() {
    const res = await fetch(`${BASE_URL}/posts`);
    if (!res.ok) return [];
    return await res.json();
  }
  async function loadPosts() {
    posts = await fetchPosts();
    localStorage.setItem('posts', JSON.stringify(posts));
    renderPosts();
  }
  document.addEventListener('DOMContentLoaded', function() {
    loadPosts();
  });

  // Fetch and set the current user's cover photo
          fetch('https://my-fb-server-2.onrender.com/profiles')
    .then(res => res.json())
    .then(profiles => {
      const userName = localStorage.getItem('profileName') || 'User Name';
      const user = profiles.find(p => p.name === userName);
      if (user && user.background) {
        document.getElementById('homeCover').style.background = `#b71c1c url('${user.background}') center/cover no-repeat`;
      }
    });

  // Comment Modal Functions
  let currentPostId = null;
  let posts = [];

  function openCommentModal(postId) {
    console.log('Opening comment modal for postId:', postId);
    currentPostId = postId;
    const modal = document.getElementById('commentModal');
    
    // Get posts from localStorage
    const allPosts = JSON.parse(localStorage.getItem('posts') || '[]');
    const post = allPosts.find(p => 'post-' + p.time === postId);
    
    if (!post) {
      console.log('Post not found:', postId);
      alert('       ');
      return;
    }
    
    console.log('Found post:', post);
    
    // Set modal profile pic and name
    document.getElementById('modalProfilePic').src = post.profileImage || 'default-profile.png';
    document.getElementById('modalProfileName').textContent = post.name || post.author || '';
    
    // Set post content
    const postContent = document.getElementById('modalPostContent');
    postContent.innerHTML = `
      <div class="comment-post-text">${post.caption || ''}</div>
      ${post.url ? `
        <div class="comment-post-media">
          ${post.type && post.type.startsWith('video/') ? 
            `<video controls style="width:100%;border-radius:8px;margin-top:10px;"><source src="${post.url}" type="video/mp4"></video>` :
            `<img src="${post.url}" alt="Post media" style="width:100%;border-radius:8px;margin-top:10px;">`
          }
        </div>
      ` : ''}
    `;
    
    // Load comments
    loadComments(postId);
    
    // Show modal
    modal.style.display = 'block';
    
    // Focus on input
    setTimeout(() => {
      document.getElementById('commentInput').focus();
    }, 100);
  }

  function closeCommentModal() {
    document.getElementById('commentModal').style.display = 'none';
    document.getElementById('commentInput').value = '';
    document.getElementById('sendCommentBtn').disabled = true;
    currentPostId = null;
  }

  function handleCommentInput(input) {
    const sendBtn = document.getElementById('sendCommentBtn');
    if (input.value.trim().length > 0) {
      sendBtn.disabled = false;
      sendBtn.classList.add('active');
    } else {
      sendBtn.disabled = true;
      sendBtn.classList.remove('active');
    }
  }

  function loadComments(postId) {
    const commentsList = document.getElementById('commentsList');
    
    // Show loading
    commentsList.innerHTML = '<div style="text-align:center;padding:20px;color:#65676b;"> ...</div>';
    
    // Fetch comments from server
    fetch(`https://my-fb-server-2.onrender.com/comments/${postId}`)
      .then(res => res.json())
      .then(comments => {
        if (!comments || comments.length === 0) {
          commentsList.innerHTML = `
            <div class="no-comments">
              <div class="no-comments-icon"></div>
              <div>   </div>
              <div style="font-size: 14px; margin-top: 5px;">   </div>
            </div>
          `;
          return;
        }
        
        commentsList.innerHTML = comments.map(comment => `
          <div class="comment-item">
            <img src="${comment.profileImage || 'default-profile.png'}" alt="Profile" style="width:32px;height:32px;border-radius:50%;object-fit:cover;margin-right:10px;flex-shrink:0;">
            <div class="comment-content">
              <div class="comment-author">${comment.author}</div>
              <div class="comment-text">${comment.text}</div>
            </div>
          </div>
        `).join('');
      })
      .catch(error => {
        console.error('Error loading comments:', error);
        commentsList.innerHTML = `
          <div class="no-comments">
            <div class="no-comments-icon"></div>
            <div>    </div>
          </div>
        `;
      });
  }

  function sendComment() {
    const input = document.getElementById('commentInput');
    const commentText = input.value.trim();
    
    if (!commentText || !currentPostId) return;
    
    // Disable send button while sending
    const sendBtn = document.getElementById('sendCommentBtn');
    sendBtn.disabled = true;
    sendBtn.textContent = '...';
    
    // Get current user info
    const currentUser = localStorage.getItem('profileName') || '';
    const profileImage = localStorage.getItem('profileImage') || 'default-profile.png';
    
    // Send comment to server
    fetch('https://my-fb-server-2.onrender.com/comments', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        postId: currentPostId,
        author: currentUser,
        text: commentText,
        profileImage: profileImage
      })
    })
    .then(res => res.json())
    .then(comment => {
      // Reload comments
      loadComments(currentPostId);
      
      // Update comment count
      updateCommentCount(currentPostId);
      
      // Clear input
      input.value = '';
      sendBtn.disabled = true;
      sendBtn.classList.remove('active');
      sendBtn.textContent = '';
      
      // Focus back on input
      input.focus();
    })
    .catch(error => {
      console.error('Error sending comment:', error);
      alert('      ');
      
      // Re-enable send button
      sendBtn.disabled = false;
      sendBtn.textContent = '';
    });
  }

  function updateCommentCount(postId) {
    // Fetch updated comment count from server
    fetch(`https://my-fb-server-2.onrender.com/comments/${postId}`)
      .then(res => res.json())
      .then(comments => {
        const count = comments.length;
        const countElement = document.getElementById(`comment-count-${postId}`);
        if (countElement) {
          countElement.textContent = count;
        }
      })
      .catch(error => {
        console.error('Error updating comment count:', error);
      });
  }

  // Close modal when clicking outside
  window.onclick = function(event) {
    const modal = document.getElementById('commentModal');
    if (event.target === modal) {
      closeCommentModal();
    }
  }

  // Handle Enter key in comment input
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey && document.getElementById('commentInput') === document.activeElement) {
      e.preventDefault();
      sendComment();
    }
  });

  // Search Modal Functions
  function openSearchModal() {
    document.getElementById('searchModal').style.display = 'block';
    document.getElementById('searchInput').focus();
    // Show initial results or recent searches
    showRecentSearches();
  }

  function closeSearchModal() {
    document.getElementById('searchModal').style.display = 'none';
    document.getElementById('searchInput').value = '';
    document.getElementById('searchResults').innerHTML = '';
  }

  function showRecentSearches() {
    const resultsDiv = document.getElementById('searchResults');
    resultsDiv.innerHTML = `
      <div style="padding: 20px; text-align: center; color: #65676b;">
        <div style="font-size: 48px; margin-bottom: 10px; opacity: 0.5;"></div>
        <div>    </div>
        <div style="font-size: 14px; margin-top: 5px;">, ,    </div>
      </div>
    `;
  }

  function performSearch(query, category = 'all') {
    if (!query.trim()) {
      showRecentSearches();
      return;
    }

    const searchTerm = query.toLowerCase();
    const results = [];

    // Get all data sources
    const posts = JSON.parse(localStorage.getItem('posts') || '[]');
    const profiles = JSON.parse(localStorage.getItem('profiles') || '[]');
    const stories = JSON.parse(localStorage.getItem('stories') || '[]');

    // Search in posts
    if (category === 'all' || category === 'posts') {
      posts.forEach(post => {
        if (post.caption && post.caption.toLowerCase().includes(searchTerm)) {
          results.push({
            type: 'post',
            title: post.caption.substring(0, 50) + (post.caption.length > 50 ? '...' : ''),
            subtitle: post.name || 'User',
            avatar: post.profileImage || 'default-profile.png',
            preview: post.url,
            data: post
          });
        }
      });
    }

    // Search in users/profiles
    if (category === 'all' || category === 'users') {
      profiles.forEach(profile => {
        if (profile.name && profile.name.toLowerCase().includes(searchTerm)) {
          results.push({
            type: 'user',
            title: profile.name,
            subtitle: '',
            avatar: profile.profileImage || 'default-profile.png',
            preview: null,
            data: profile
          });
        }
      });
    }

    // Search in photos
    if (category === 'all' || category === 'photos') {
      posts.forEach(post => {
        if (post.url && post.type && post.type.startsWith('image/') && 
            (post.caption && post.caption.toLowerCase().includes(searchTerm))) {
          results.push({
            type: 'photo',
            title: post.caption ? post.caption.substring(0, 30) + '...' : '',
            subtitle: post.name || 'User',
            avatar: post.profileImage || 'default-profile.png',
            preview: post.url,
            data: post
          });
        }
      });
    }

    // Search in videos
    if (category === 'all' || category === 'videos') {
      posts.forEach(post => {
        if (post.url && post.type && post.type.startsWith('video/') && 
            (post.caption && post.caption.toLowerCase().includes(searchTerm))) {
          results.push({
            type: 'video',
            title: post.caption ? post.caption.substring(0, 30) + '...' : '',
            subtitle: post.name || 'User',
            avatar: post.profileImage || 'default-profile.png',
            preview: post.url,
            data: post
          });
        }
      });

      // Also search in stories
      stories.forEach(story => {
        if (story.type && story.type.startsWith('video/') && 
            (story.userName && story.userName.toLowerCase().includes(searchTerm))) {
          results.push({
            type: 'video',
            title: story.userName + '  ',
            subtitle: '',
            avatar: story.profileImage || 'default-profile.png',
            preview: story.url,
            data: story
          });
        }
      });
    }

    displaySearchResults(results);
  }

  function displaySearchResults(results) {
    const resultsDiv = document.getElementById('searchResults');
    
    if (results.length === 0) {
      resultsDiv.innerHTML = `
        <div class="no-search-results">
          <div class="no-search-results-icon"></div>
          <div>   </div>
          <div style="font-size: 14px; margin-top: 5px;">    </div>
        </div>
      `;
      return;
    }

    resultsDiv.innerHTML = results.map(result => `
      <div class="search-result-item" onclick="handleSearchResultClick('${result.type}', ${JSON.stringify(result.data).replace(/"/g, '&quot;')})">
        <img src="${result.avatar}" alt="Avatar" class="search-result-avatar">
        <div class="search-result-info">
          <div class="search-result-name">${result.title}</div>
          <div class="search-result-type">${result.subtitle}</div>
        </div>
        ${result.preview ? `<img src="${result.preview}" alt="Preview" class="search-result-preview">` : ''}
      </div>
    `).join('');
  }

  function handleSearchResultClick(type, data) {
    closeSearchModal();
    
    switch(type) {
      case 'user':
        // Navigate to user profile
        window.location.href = `profile.html?user=${encodeURIComponent(data.name)}`;
        break;
      case 'post':
        // Scroll to post in feed
        scrollToPost(data.time);
        break;
      case 'photo':
      case 'video':
        // Show media in full screen or navigate to post
        if (data.url) {
          showMediaPreview(data.url, data.type);
        }
        break;
    }
  }

  function scrollToPost(postTime) {
    const postElement = document.querySelector(`[data-post-time="${postTime}"]`);
    if (postElement) {
      postElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
      // Highlight the post briefly
      postElement.style.backgroundColor = '#f0f8ff';
      setTimeout(() => {
        postElement.style.backgroundColor = '';
      }, 2000);
    }
  }

  function showMediaPreview(url, type) {
    // Create a modal to show the media
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10001;
    `;
    
    const media = type.startsWith('video/') ? 
      `<video src="${url}" controls style="max-width: 90vw; max-height: 90vh; border-radius: 8px;"></video>` :
      `<img src="${url}" style="max-width: 90vw; max-height: 90vh; border-radius: 8px; object-fit: contain;">`;
    
    modal.innerHTML = `
      <div style="position: relative;">
        ${media}
        <button onclick="this.parentElement.parentElement.remove()" style="
          position: absolute;
          top: -40px;
          right: 0;
          background: none;
          border: none;
          color: white;
          font-size: 24px;
          cursor: pointer;
        ">&times;</button>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    // Close on click outside
    modal.onclick = function(e) {
      if (e.target === modal) modal.remove();
    };
  }

  // Close search modal when clicking outside
  window.onclick = function(event) {
    const searchModal = document.getElementById('searchModal');
    const commentModal = document.getElementById('commentModal');
    const dxfModal = document.getElementById('dxfModal');
    
    if (event.target === searchModal) {
      closeSearchModal();
    }
    
    if (event.target === commentModal) {
      closeCommentModal();
    }
    
    if (event.target === dxfModal) {
      closeDXFModal();
    }
    
    const thumbnailGeneratorModal = document.getElementById('thumbnailGeneratorModal');
    if (event.target === thumbnailGeneratorModal) {
      closeThumbnailGenerator();
    }
  }

  // DXF Modal Functions
  let selectedDXFFile = null;
  let selectedThumbnail = null;
  let thumbnailCanvas = null;
  let thumbnailCtx = null;

  function openDXFModal() {
    document.getElementById('dxfModal').style.display = 'block';
    resetDXFModal();
  }

  function closeDXFModal() {
    document.getElementById('dxfModal').style.display = 'none';
    resetDXFModal();
  }

  function resetDXFModal() {
    selectedDXFFile = null;
    selectedThumbnail = null;
    document.getElementById('dxfFileInput').value = '';
    document.getElementById('dxfProjectName').value = '';
    document.getElementById('dxfDescription').value = '';
    document.getElementById('dxfCategory').value = '';
    document.getElementById('dxfTags').value = '';
    document.getElementById('dxfPrivacy').value = 'public';
    document.getElementById('dxfUploadBtn').disabled = true;
    document.getElementById('dxfUploadSection').style.display = 'block';
    document.getElementById('dxfPreviewSection').style.display = 'none';
    document.getElementById('dxfOptionsSection').style.display = 'none';
    
    // Reset thumbnail preview
    const thumbnailPreview = document.getElementById('dxfThumbnailPreview');
    thumbnailPreview.innerHTML = `
      <div class="dxf-thumbnail-placeholder">
        <div class="dxf-thumbnail-placeholder-icon"></div>
        <div>  </div>
      </div>
    `;
  }

  function handleDXFFileSelect(input) {
    const file = input.files[0];
    if (file) {
      // Check if it's a DXF file
      if (!file.name.toLowerCase().endsWith('.dxf')) {
        alert(' DXF    ');
        return;
      }

      // Check file size (max 10MB)
      if (file.size > 10 * 1024 * 1024) {
        alert('  10MB     ');
        return;
      }

      selectedDXFFile = file;
      showDXFPreview(file);
      document.getElementById('dxfUploadBtn').disabled = false;
    }
  }

  function showDXFPreview(file) {
    // Show file info
    document.getElementById('dxfFileName').textContent = file.name;
    document.getElementById('dxfFileSize').textContent = formatFileSize(file.size);

    // Show preview section
    document.getElementById('dxfUploadSection').style.display = 'none';
    document.getElementById('dxfPreviewSection').style.display = 'block';
    document.getElementById('dxfOptionsSection').style.display = 'block';

    // Create a simple preview (you can enhance this with actual DXF parsing)
    const canvas = document.getElementById('dxfPreviewCanvas');
    canvas.innerHTML = `
      <div class="dxf-preview-placeholder">
        <div class="dxf-preview-placeholder-icon"></div>
        <div>${file.name}</div>
        <div style="font-size: 12px; margin-top: 5px; color: #888;">
          DXF  - ${formatFileSize(file.size)}
        </div>
      </div>
    `;
  }

  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  function removeDXFFile() {
    selectedDXFFile = null;
    document.getElementById('dxfFileInput').value = '';
    document.getElementById('dxfUploadSection').style.display = 'block';
  }

  // 3D Modal Functions
  let selectedTDFile = null;
  let selectedTDThumbnail = null;

  function openTDModal() {
    document.getElementById('tdModal').style.display = 'block';
    resetTDModal();
  }

  function closeTDModal() {
    document.getElementById('tdModal').style.display = 'none';
    resetTDModal();
  }

  function resetTDModal() {
    selectedTDFile = null;
    selectedTDThumbnail = null;
    document.getElementById('tdFileInput').value = '';
    document.getElementById('tdProjectName').value = '';
    document.getElementById('tdDescription').value = '';
    document.getElementById('tdCategory').value = '';
    document.getElementById('tdTags').value = '';
    document.getElementById('tdPrivacy').value = 'public';
    document.getElementById('tdPrice').value = '';
    document.getElementById('tdUploadBtn').disabled = true;
    document.getElementById('tdUploadSection').style.display = 'block';
    document.getElementById('tdPreviewSection').style.display = 'none';
    document.getElementById('tdOptionsSection').style.display = 'none';
    
    // Reset thumbnail preview
    const thumbnailPreview = document.getElementById('tdThumbnailPreview');
    thumbnailPreview.innerHTML = `
      <div class="td-thumbnail-placeholder">
        <div class="td-thumbnail-placeholder-icon"></div>
        <div>  </div>
      </div>
    `;
  }

  function handleTDFileSelect(input) {
    const file = input.files[0];
    if (file) {
      // Check if it's a supported 3D file
      const supportedFormats = ['.obj', '.stl', '.fbx', '.3ds', '.dae', '.blend'];
      const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
      
      if (!supportedFormats.includes(fileExtension)) {
        alert(' 3D   (.obj, .stl, .fbx, .3ds, .dae, .blend)   ');
        return;
      }

      // Check file size (max 50MB for 3D files)
      if (file.size > 50 * 1024 * 1024) {
        alert('  50MB     ');
        return;
      }

      selectedTDFile = file;
      showTDPreview(file);
      document.getElementById('tdUploadBtn').disabled = false;
    }
  }

  function showTDPreview(file) {
    // Show file info
    document.getElementById('tdFileName').textContent = file.name;
    document.getElementById('tdFileSize').textContent = formatFileSize(file.size);

    // Show preview section
    document.getElementById('tdUploadSection').style.display = 'none';
    document.getElementById('tdPreviewSection').style.display = 'block';
    document.getElementById('tdOptionsSection').style.display = 'block';

    // Create a simple preview
    const canvas = document.getElementById('tdPreviewCanvas');
    canvas.innerHTML = `
      <div class="td-preview-placeholder">
        <div class="td-preview-placeholder-icon"></div>
        <div>${file.name}</div>
        <div style="font-size: 12px; margin-top: 5px; color: #888;">
          3D  - ${formatFileSize(file.size)}
        </div>
      </div>
    `;
  }

  function removeTDFile() {
    selectedTDFile = null;
    document.getElementById('tdFileInput').value = '';
    document.getElementById('tdUploadSection').style.display = 'block';
    document.getElementById('tdPreviewSection').style.display = 'none';
    document.getElementById('tdOptionsSection').style.display = 'none';
  }

  function uploadCustomTDThumbnail() {
    document.getElementById('tdThumbnailInput').click();
  }

  function handleTDThumbnailSelect(input) {
    const file = input.files[0];
    if (file) {
      if (!file.type.startsWith('image/')) {
        alert('     ');
        return;
      }

      if (file.size > 5 * 1024 * 1024) {
        alert('   5MB     ');
        return;
      }

      selectedTDThumbnail = file;
      showTDThumbnailPreview(file);
    }
  }

  function showTDThumbnailPreview(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const thumbnailPreview = document.getElementById('tdThumbnailPreview');
      thumbnailPreview.innerHTML = `
        <img src="${e.target.result}" alt="Thumbnail" class="td-thumbnail-image">
        <div class="td-thumbnail-overlay">
          <button onclick="removeTDThumbnail()"></button>
        </div>
      `;
    };
    reader.readAsDataURL(file);
  }

  function removeTDThumbnail() {
    selectedTDThumbnail = null;
    document.getElementById('tdThumbnailInput').value = '';
    const thumbnailPreview = document.getElementById('tdThumbnailPreview');
    thumbnailPreview.innerHTML = `
      <div class="td-thumbnail-placeholder">
        <div class="td-thumbnail-placeholder-icon"></div>
        <div>  </div>
      </div>
    `;
  }

  function generateTDThumbnail() {
    // Similar to DXF thumbnail generation but for 3D
    alert('3D    !');
  }

  function uploadTDFile() {
    if (!selectedTDFile) {
      alert(' 3D    ');
      return;
    }

    const projectName = document.getElementById('tdProjectName').value.trim();
    if (!projectName) {
      alert('  ');
      return;
    }

    // Create form data for upload
    const formData = new FormData();
    formData.append('file', selectedTDFile);
    formData.append('projectName', projectName);
    formData.append('description', document.getElementById('tdDescription').value);
    formData.append('category', document.getElementById('tdCategory').value);
    formData.append('tags', document.getElementById('tdTags').value);
    formData.append('privacy', document.getElementById('tdPrivacy').value);
    formData.append('price', document.getElementById('tdPrice').value);
    formData.append('type', '3d');
    formData.append('user', localStorage.getItem('profileName') || 'User Name');
    formData.append('profileImage', localStorage.getItem('profileImage') || 'default-profile.png');

    if (selectedTDThumbnail) {
      formData.append('thumbnail', selectedTDThumbnail);
    }

    // Show loading state
    const uploadBtn = document.getElementById('tdUploadBtn');
    uploadBtn.textContent = ' ...';
    uploadBtn.disabled = true;

    // Upload to server
    fetch(`${BASE_URL}/upload3d`, {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('3D    !');
        closeTDModal();
        // Refresh posts to show the new 3D post
        loadPosts();
        
        // Send notification to all users about new 3D post
        const newPost = {
          name: localStorage.getItem('profileName') || 'User Name',
          caption: ` ${projectName}`,
          type: '3d',
          time: Date.now()
        };
        sendNotificationToAllUsers(newPost);
        updateNotificationBadge();
      } else {
        alert('  : ' + data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('  ');
    })
    .finally(() => {
      uploadBtn.textContent = '3D  ';
      uploadBtn.disabled = false;
    });
  }

  async function uploadDXFFile() {
    if (!selectedDXFFile) {
      alert('    ');
      return;
    }

    const projectName = document.getElementById('dxfProjectName').value.trim();
    const description = document.getElementById('dxfDescription').value.trim();
    const category = document.getElementById('dxfCategory').value;
    const tags = document.getElementById('dxfTags').value.trim();
    const privacy = document.getElementById('dxfPrivacy').value;

    if (!projectName) {
      alert('  ');
      return;
    }

    // Disable upload button
    const uploadBtn = document.getElementById('dxfUploadBtn');
    uploadBtn.disabled = true;
    uploadBtn.textContent = ' ...';

    try {
      const formData = new FormData();
      formData.append('file', selectedDXFFile);
      formData.append('projectName', projectName);
      formData.append('description', description);
      formData.append('category', category);
      formData.append('tags', tags);
      formData.append('privacy', privacy);
      formData.append('user', localStorage.getItem('profileName') || 'User Name');
      formData.append('profileImage', localStorage.getItem('profileImage') || 'default-profile.png');
      
      // Add thumbnail if selected
      if (selectedThumbnail) {
        formData.append('thumbnail', selectedThumbnail);
      }

      const price = getDXFPrice();
      formData.append('price', price);

      const response = await fetch(`${BASE_URL}/upload-dxf`, {
        method: 'POST',
        body: formData
      });

      if (response.ok) {
        const result = await response.json();
        alert('DXF    !');
        closeDXFModal();
        
        // Optionally refresh the page or update the feed
        // You can add the DXF post to the feed here
        addDXFPostToFeed(result);
        
        // Send notification to all users about new DXF post
        const newPost = {
          name: localStorage.getItem('profileName') || 'User Name',
          caption: ` ${projectName}`,
          type: 'dxf',
          time: Date.now()
        };
        sendNotificationToAllUsers(newPost);
        updateNotificationBadge();
      } else {
        const error = await response.text();
        alert('  : ' + error);
      }
    } catch (error) {
      alert('  : ' + error.message);
    } finally {
      uploadBtn.disabled = false;
      uploadBtn.textContent = ' ';
    }
  }

  function addDXFPostToFeed(dxfData) {
    // Add DXF post to the feed
    const posts = JSON.parse(localStorage.getItem('posts') || '[]');
    const newPost = {
      time: Date.now(),
      name: localStorage.getItem('profileName') || 'User Name',
      profileImage: localStorage.getItem('profileImage') || 'default-profile.png',
      caption: ` ${dxfData.projectName}\n\n${dxfData.description}\n\n#DXF #${dxfData.category}`,
      type: 'dxf',
      url: dxfData.fileUrl,
      category: dxfData.category,
      tags: dxfData.tags,
      privacy: dxfData.privacy,
      price: dxfData.price || '',
      thumbnail: selectedThumbnail || null,
      comment: 0,
      share: 0
    };
    
    posts.unshift(newPost);
    localStorage.setItem('posts', JSON.stringify(posts));
    renderPosts();
  }

  // JD Modal Functions
  let selectedJDFile = null;
  let selectedJDThumbnail = null;

  function openJDModal() {
    document.getElementById('jdModal').style.display = 'block';
    resetJDModal();
  }

  function closeJDModal() {
    document.getElementById('jdModal').style.display = 'none';
    resetJDModal();
  }

  function resetJDModal() {
    selectedJDFile = null;
    selectedJDThumbnail = null;
    document.getElementById('jdFileInput').value = '';
    document.getElementById('jdJobTitle').value = '';
    document.getElementById('jdCompanyName').value = '';
    document.getElementById('jdDescription').value = '';
    document.getElementById('jdCategory').value = '';
    document.getElementById('jdLocation').value = '';
    document.getElementById('jdTags').value = '';
    document.getElementById('jdPrivacy').value = 'public';
    document.getElementById('jdSalary').value = '';
    document.getElementById('jdUploadBtn').disabled = true;
    document.getElementById('jdUploadSection').style.display = 'block';
    document.getElementById('jdPreviewSection').style.display = 'none';
    document.getElementById('jdOptionsSection').style.display = 'none';
    
    // Reset thumbnail preview
    const thumbnailPreview = document.getElementById('jdThumbnailPreview');
    thumbnailPreview.innerHTML = `
      <div class="jd-thumbnail-placeholder">
        <div class="jd-thumbnail-placeholder-icon"></div>
        <div>  </div>
      </div>
    `;
  }

  function handleJDFileSelect(input) {
    const file = input.files[0];
    if (file) {
      // Check if it's a supported JD file
      const supportedFormats = ['.pdf', '.doc', '.docx', '.txt'];
      const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
      
      if (!supportedFormats.includes(fileExtension)) {
        alert(' JD   (.pdf, .doc, .docx, .txt)   ');
        return;
      }

      // Check file size (max 10MB for JD files)
      if (file.size > 10 * 1024 * 1024) {
        alert('  10MB     ');
        return;
      }

      selectedJDFile = file;
      showJDPreview(file);
      document.getElementById('jdUploadBtn').disabled = false;
    }
  }

  function showJDPreview(file) {
    // Show file info
    document.getElementById('jdFileName').textContent = file.name;
    document.getElementById('jdFileSize').textContent = formatFileSize(file.size);

    // Show preview section
    document.getElementById('jdUploadSection').style.display = 'none';
    document.getElementById('jdPreviewSection').style.display = 'block';
    document.getElementById('jdOptionsSection').style.display = 'block';

    // Create a simple preview
    const canvas = document.getElementById('jdPreviewCanvas');
    canvas.innerHTML = `
      <div class="jd-preview-placeholder">
        <div class="jd-preview-placeholder-icon"></div>
        <div>${file.name}</div>
        <div style="font-size: 12px; margin-top: 5px; color: #888;">
          JD  - ${formatFileSize(file.size)}
        </div>
      </div>
    `;
  }

  function removeJDFile() {
    selectedJDFile = null;
    document.getElementById('jdFileInput').value = '';
    document.getElementById('jdUploadSection').style.display = 'block';
    document.getElementById('jdPreviewSection').style.display = 'none';
    document.getElementById('jdOptionsSection').style.display = 'none';
  }

  function uploadCustomJDThumbnail() {
    document.getElementById('jdThumbnailInput').click();
  }

  function handleJDThumbnailSelect(input) {
    const file = input.files[0];
    if (file) {
      if (!file.type.startsWith('image/')) {
        alert('     ');
        return;
      }

      if (file.size > 5 * 1024 * 1024) {
        alert('   5MB     ');
        return;
      }

      selectedJDThumbnail = file;
      showJDThumbnailPreview(file);
    }
  }

  function showJDThumbnailPreview(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const thumbnailPreview = document.getElementById('jdThumbnailPreview');
      thumbnailPreview.innerHTML = `
        <img src="${e.target.result}" alt="Thumbnail" class="jd-thumbnail-image">
        <div class="jd-thumbnail-overlay">
          <button onclick="removeJDThumbnail()"></button>
        </div>
      `;
    };
    reader.readAsDataURL(file);
  }

  function removeJDThumbnail() {
    selectedJDThumbnail = null;
    document.getElementById('jdThumbnailInput').value = '';
    const thumbnailPreview = document.getElementById('jdThumbnailPreview');
    thumbnailPreview.innerHTML = `
      <div class="jd-thumbnail-placeholder">
        <div class="jd-thumbnail-placeholder-icon"></div>
        <div>  </div>
      </div>
    `;
  }

  function generateJDThumbnail() {
    // Similar to DXF thumbnail generation but for JD
    alert('JD    !');
  }

  function uploadJDFile() {
    if (!selectedJDFile) {
      alert(' JD    ');
      return;
    }

    const jobTitle = document.getElementById('jdJobTitle').value.trim();
    if (!jobTitle) {
      alert('  ');
      return;
    }

    const companyName = document.getElementById('jdCompanyName').value.trim();
    if (!companyName) {
      alert('  ');
      return;
    }

    // Create form data for upload
    const formData = new FormData();
    formData.append('file', selectedJDFile);
    formData.append('jobTitle', jobTitle);
    formData.append('companyName', companyName);
    formData.append('description', document.getElementById('jdDescription').value);
    formData.append('category', document.getElementById('jdCategory').value);
    formData.append('location', document.getElementById('jdLocation').value);
    formData.append('tags', document.getElementById('jdTags').value);
    formData.append('privacy', document.getElementById('jdPrivacy').value);
    formData.append('salary', document.getElementById('jdSalary').value);
    formData.append('type', 'jd');
    formData.append('user', localStorage.getItem('profileName') || 'User Name');
    formData.append('profileImage', localStorage.getItem('profileImage') || 'default-profile.png');

    if (selectedJDThumbnail) {
      formData.append('thumbnail', selectedJDThumbnail);
    }

    // Show loading state
    const uploadBtn = document.getElementById('jdUploadBtn');
    uploadBtn.textContent = ' ...';
    uploadBtn.disabled = true;

    // Upload to server
    fetch(`${BASE_URL}/uploadjd`, {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('JD    !');
        closeJDModal();
        // Refresh posts to show the new JD post
        loadPosts();
        
        // Send notification to all users about new JD post
        const newPost = {
          name: localStorage.getItem('profileName') || 'User Name',
          caption: ` ${jobTitle} at ${companyName}`,
          type: 'jd',
          time: Date.now()
        };
        sendNotificationToAllUsers(newPost);
        updateNotificationBadge();
      } else {
        alert('  : ' + data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('  ');
    })
    .finally(() => {
      uploadBtn.textContent = 'JD  ';
      uploadBtn.disabled = false;
    });
  }

  // Help Modal Functions
  function openHelpModal() {
    document.getElementById('helpModal').style.display = 'block';
  }

  function closeHelpModal() {
    document.getElementById('helpModal').style.display = 'none';
  }

  function openGuideModal() {
    document.getElementById('guideModal').style.display = 'block';
  }

  function closeGuideModal() {
    document.getElementById('guideModal').style.display = 'none';
  }

  function showDXFGuide() {
    document.getElementById('guideTitle').textContent = 'DXF   ';
    document.getElementById('guideContent').innerHTML = `
      <div class="guide-step">
        <div class="guide-step-content">
          <div class="guide-step-number">1</div>
          <div class="guide-step-text">
            <div class="guide-step-title">Plus   </div>
            <div class="guide-step-desc">     +   </div>
          </div>
        </div>
      </div>
      
      <div class="guide-step">
        <div class="guide-step-content">
          <div class="guide-step-number">2</div>
          <div class="guide-step-text">
            <div class="guide-step-title">DXF   </div>
            <div class="guide-step-desc">  "DXF"   </div>
          </div>
        </div>
      </div>
      
      <div class="guide-step">
        <div class="guide-step-content">
          <div class="guide-step-number">3</div>
          <div class="guide-step-text">
            <div class="guide-step-title">  </div>
            <div class="guide-step-desc">DXF    (.dxf )</div>
          </div>
        </div>
      </div>
      
      <div class="guide-step">
        <div class="guide-step-content">
          <div class="guide-step-number">4</div>
          <div class="guide-step-text">
            <div class="guide-step-title">  </div>
            <div class="guide-step-desc"> , , ,    </div>
          </div>
        </div>
      </div>
      
      <div class="guide-step">
        <div class="guide-step-content">
          <div class="guide-step-number">5</div>
          <div class="guide-step-text">
            <div class="guide-step-title"> </div>
            <div class="guide-step-desc">"DXF  "   </div>
          </div>
        </div>
      </div>
      
      <div class="guide-note">
        <strong>:</strong>  .dxf       10MB     
      </div>
    `;
    closeHelpModal();
    openGuideModal();
  }

  function show3DGuide() {
    document.getElementById('guideTitle').textContent = '3D   ';
    document.getElementById('guideContent').innerHTML = `
      <div class="guide-step">
        <div class="guide-step-content">
          <div class="guide-step-number">1</div>
          <div class="guide-step-text">
            <div class="guide-step-title">Plus   </div>
            <div class="guide-step-desc">     +   </div>
          </div>
        </div>
      </div>
      
      <div class="guide-step">
        <div class="guide-step-content">
          <div class="guide-step-number">2</div>
          <div class="guide-step-text">
            <div class="guide-step-title">3D   </div>
            <div class="guide-step-desc">  "3D"   </div>
          </div>
        </div>
      </div>
      
      <div class="guide-step">
        <div class="guide-step-content">
          <div class="guide-step-number">3</div>
          <div class="guide-step-text">
            <div class="guide-step-title">3D   </div>
            <div class="guide-step-desc">3D    (.obj, .stl, .fbx, .3ds, .dae, .blend)</div>
          </div>
        </div>
      </div>
      
      <div class="guide-step">
        <div class="guide-step-content">
          <div class="guide-step-number">4</div>
          <div class="guide-step-text">
            <div class="guide-step-title">  </div>
            <div class="guide-step-desc"> , , ,    </div>
          </div>
        </div>
      </div>
      
      <div class="guide-step">
        <div class="guide-step-content">
          <div class="guide-step-number">5</div>
          <div class="guide-step-text">
            <div class="guide-step-title"> </div>
            <div class="guide-step-desc">"3D  "   </div>
          </div>
        </div>
      </div>
      
      <div class="guide-note">
        <strong>:</strong>  : .obj, .stl, .fbx, .3ds, .dae, .blend   50MB     
      </div>
    `;
    closeHelpModal();
    openGuideModal();
  }

  function showJDGuide() {
    document.getElementById('guideTitle').textContent = 'JD   ';
    document.getElementById('guideContent').innerHTML = `
      <div class="guide-step">
        <div class="guide-step-content">
          <div class="guide-step-number">1</div>
          <div class="guide-step-text">
            <div class="guide-step-title">Plus   </div>
            <div class="guide-step-desc">     +   </div>
          </div>
        </div>
      </div>
      
      <div class="guide-step">
        <div class="guide-step-content">
          <div class="guide-step-number">2</div>
          <div class="guide-step-text">
            <div class="guide-step-title">JD   </div>
            <div class="guide-step-desc">  "JD"   </div>
          </div>
        </div>
      </div>
      
      <div class="guide-step">
        <div class="guide-step-content">
          <div class="guide-step-number">3</div>
          <div class="guide-step-text">
            <div class="guide-step-title">JD   </div>
            <div class="guide-step-desc">JD    (.pdf, .doc, .docx, .txt)</div>
          </div>
        </div>
      </div>
      
      <div class="guide-step">
        <div class="guide-step-content">
          <div class="guide-step-number">4</div>
          <div class="guide-step-text">
            <div class="guide-step-title">  </div>
            <div class="guide-step-desc"> ,  , , , ,    </div>
          </div>
        </div>
      </div>
      
      <div class="guide-step">
        <div class="guide-step-content">
          <div class="guide-step-number">5</div>
          <div class="guide-step-text">
            <div class="guide-step-title"> </div>
            <div class="guide-step-desc">"JD  "   </div>
          </div>
        </div>
      </div>
      
      <div class="guide-note">
        <strong>:</strong>  : .pdf, .doc, .docx, .txt   10MB     
      </div>
    `;
    closeHelpModal();
    openGuideModal();
  }

  function openWhatsApp() {
    const phoneNumber = '01788458049';
    const message = '!  CNC FB   ';
    const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
    closeHelpModal();
  }

  function copyPhoneNumber() {
    const phoneNumber = '01788458049';
    navigator.clipboard.writeText(phoneNumber).then(function() {
      alert('   : ' + phoneNumber);
    }).catch(function() {
      // Fallback for older browsers
      const textArea = document.createElement('textarea');
      textArea.value = phoneNumber;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand('copy');
      document.body.removeChild(textArea);
      alert('   : ' + phoneNumber);
    });
    closeHelpModal();
  }

  // Close modals when clicking outside
  document.addEventListener('DOMContentLoaded', function() {
    const helpModal = document.getElementById('helpModal');
    const guideModal = document.getElementById('guideModal');
    
    if (helpModal) {
      helpModal.onclick = function(e) {
        if (e.target === helpModal) {
          closeHelpModal();
        }
      };
    }
    
    if (guideModal) {
      guideModal.onclick = function(e) {
        if (e.target === guideModal) {
          closeGuideModal();
        }
      };
    }
  });

  // Thumbnail Functions
  function uploadCustomThumbnail() {
    document.getElementById('dxfThumbnailInput').click();
  }

  function handleThumbnailSelect(input) {
    const file = input.files[0];
    if (file) {
      if (!file.type.startsWith('image/')) {
        alert('     ');
        return;
      }

      if (file.size > 5 * 1024 * 1024) {
        alert('  5MB     ');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        selectedThumbnail = e.target.result;
        showThumbnailPreview(selectedThumbnail);
      };
      reader.readAsDataURL(file);
    }
  }

  function showThumbnailPreview(imageData) {
    const thumbnailPreview = document.getElementById('dxfThumbnailPreview');
    thumbnailPreview.innerHTML = `
      <img src="${imageData}" alt="Thumbnail" class="dxf-thumbnail-image">
      <div class="dxf-thumbnail-overlay">
        <button onclick="removeThumbnail()"></button>
        <button onclick="editThumbnail()"></button>
      </div>
    `;
  }

  function removeThumbnail() {
    selectedThumbnail = null;
    document.getElementById('dxfThumbnailInput').value = '';
    const thumbnailPreview = document.getElementById('dxfThumbnailPreview');
    thumbnailPreview.innerHTML = `
      <div class="dxf-thumbnail-placeholder">
        <div class="dxf-thumbnail-placeholder-icon"></div>
        <div>  </div>
      </div>
    `;
  }

  function editThumbnail() {
    if (selectedThumbnail) {
      generateThumbnail();
    }
  }

  function generateThumbnail() {
    document.getElementById('thumbnailGeneratorModal').style.display = 'block';
    initThumbnailCanvas();
  }

  function closeThumbnailGenerator() {
    document.getElementById('thumbnailGeneratorModal').style.display = 'none';
  }

  function initThumbnailCanvas() {
    thumbnailCanvas = document.getElementById('thumbnailCanvas');
    thumbnailCtx = thumbnailCanvas.getContext('2d');
    
    // Set canvas size
    thumbnailCanvas.width = 400;
    thumbnailCanvas.height = 225; // 16:9 aspect ratio
    
    // Set initial background
    const bgColor = document.getElementById('thumbnailBgColor').value;
    thumbnailCtx.fillStyle = bgColor;
    thumbnailCtx.fillRect(0, 0, thumbnailCanvas.width, thumbnailCanvas.height);
    
    // Draw initial text
    drawThumbnailText();
    
    // Add event listeners
    document.getElementById('thumbnailText').addEventListener('input', drawThumbnailText);
    document.getElementById('thumbnailFontSize').addEventListener('input', drawThumbnailText);
    document.getElementById('thumbnailTextColor').addEventListener('change', drawThumbnailText);
    document.getElementById('thumbnailBgColor').addEventListener('change', drawThumbnailText);
    
    // Template event listeners
    document.querySelectorAll('.thumbnail-template').forEach(template => {
      template.addEventListener('click', function() {
        document.querySelectorAll('.thumbnail-template').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        applyThumbnailTemplate(this.getAttribute('data-template'));
      });
    });
  }

  function drawThumbnailText() {
    const text = document.getElementById('thumbnailText').value || 'DXF Project';
    const fontSize = document.getElementById('thumbnailFontSize').value;
    const textColor = document.getElementById('thumbnailTextColor').value;
    const bgColor = document.getElementById('thumbnailBgColor').value;
    
    // Clear and redraw background
    thumbnailCtx.fillStyle = bgColor;
    thumbnailCtx.fillRect(0, 0, thumbnailCanvas.width, thumbnailCanvas.height);
    
    // Draw text
    thumbnailCtx.fillStyle = textColor;
    thumbnailCtx.font = `bold ${fontSize}px Arial`;
    thumbnailCtx.textAlign = 'center';
    thumbnailCtx.textBaseline = 'middle';
    
    // Add text shadow
    thumbnailCtx.shadowColor = 'rgba(0,0,0,0.5)';
    thumbnailCtx.shadowBlur = 4;
    thumbnailCtx.shadowOffsetX = 2;
    thumbnailCtx.shadowOffsetY = 2;
    
    thumbnailCtx.fillText(text, thumbnailCanvas.width / 2, thumbnailCanvas.height / 2);
    
    // Reset shadow
    thumbnailCtx.shadowColor = 'transparent';
    thumbnailCtx.shadowBlur = 0;
    thumbnailCtx.shadowOffsetX = 0;
    thumbnailCtx.shadowOffsetY = 0;
  }

  function applyThumbnailTemplate(template) {
    const templates = {
      blue: { bg: '#1877f2', text: '#ffffff' },
      green: { bg: '#43a047', text: '#ffffff' },
      red: { bg: '#e53935', text: '#ffffff' },
      purple: { bg: '#8e24aa', text: '#ffffff' },
      orange: { bg: '#ff9800', text: '#ffffff' },
      gradient: { bg: 'linear-gradient(45deg, #1877f2, #43a047)', text: '#ffffff' }
    };
    
    const selectedTemplate = templates[template];
    if (selectedTemplate) {
      document.getElementById('thumbnailBgColor').value = selectedTemplate.bg;
      document.getElementById('thumbnailTextColor').value = selectedTemplate.text;
      drawThumbnailText();
    }
  }

  function applyThumbnail() {
    if (thumbnailCanvas) {
      selectedThumbnail = thumbnailCanvas.toDataURL('image/png');
      showThumbnailPreview(selectedThumbnail);
      closeThumbnailGenerator();
    }
  }

  // DXF Download Function with Payment
  async function downloadDXFFile(url, filename, price = 0, uploader = null) {
    const currentUser = localStorage.getItem('profileName') || 'User Name';
    
    // If no price, download directly
    if (!price || price <= 0) {
      console.log('Free download - no payment required');
      const link = document.createElement('a');
      link.href = url;
      link.download = filename + '.dxf';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      return;
    }
    
    // Check if user is trying to download their own file
    if (uploader === currentUser) {
      console.log('Downloading own file - no payment required');
      const link = document.createElement('a');
      link.href = url;
      link.download = filename + '.dxf';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      return;
    }
    
    // Show payment confirmation
    const confirmPayment = confirm(` DXF    ${price}  \n\n           \n\n  ?`);
    
    if (!confirmPayment) {
      return;
    }
    
    try {
      // Process payment
      const paymentResult = await processFilePayment(currentUser, uploader, price, 'DXF', filename, url);
      
      if (paymentResult.success) {
        // Extract filename from URL for secure download
        const urlParts = url.split('/');
        const serverFilename = urlParts[urlParts.length - 1];
        
        // Create secure download URL with payment verification
        const downloadUrl = `${BASE_URL}/download/${serverFilename}?buyer=${encodeURIComponent(currentUser)}&seller=${encodeURIComponent(uploader)}&amount=${price}&fileType=DXF`;
        
        // Download the file using secure endpoint
        try {
          const link = document.createElement('a');
          link.href = downloadUrl;
          link.download = filename + '.dxf';
          link.style.display = 'none';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          // Also try opening in new tab as fallback
          setTimeout(() => {
            window.open(downloadUrl, '_blank');
          }, 100);
        } catch (downloadError) {
          console.error('Download error:', downloadError);
          // Fallback: open in new tab
          window.open(downloadUrl, '_blank');
        }
        
        // Show success message
        alert(`  !\n\n${price}     ${uploader}    \n : ${paymentResult.newBalance.toLocaleString()}`);
        
        // Refresh user balance if on profile page
        if (typeof updateUserBalance === 'function') {
          updateUserBalance();
        }
      } else {
        alert(`  : ${paymentResult.error}`);
      }
    } catch (error) {
      console.error('Payment error:', error);
      alert('      ');
    }
  }

  // 3D Download Function with Payment
  async function download3DFile(url, filename, price = 0, uploader = null) {
    const currentUser = localStorage.getItem('profileName') || 'User Name';
    
    // If no price, download directly
    if (!price || price <= 0) {
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      return;
    }
    
    // Check if user is trying to download their own file
    if (uploader === currentUser) {
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      return;
    }
    
    // Show payment confirmation
    const confirmPayment = confirm(` 3D    ${price}  \n\n           \n\n  ?`);
    
    if (!confirmPayment) {
      return;
    }
    
    try {
      // Process payment
      const paymentResult = await processFilePayment(currentUser, uploader, price, '3D', filename, url);
      
      if (paymentResult.success) {
        // Extract filename from URL for secure download
        const urlParts = url.split('/');
        const serverFilename = urlParts[urlParts.length - 1];
        
        // Create secure download URL with payment verification
        const downloadUrl = `${BASE_URL}/download/${serverFilename}?buyer=${encodeURIComponent(currentUser)}&seller=${encodeURIComponent(uploader)}&amount=${price}&fileType=3D`;
        
        // Download the file using secure endpoint
        try {
          const link = document.createElement('a');
          link.href = downloadUrl;
          link.download = filename;
          link.style.display = 'none';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          // Also try opening in new tab as fallback
          setTimeout(() => {
            window.open(downloadUrl, '_blank');
          }, 100);
        } catch (downloadError) {
          console.error('Download error:', downloadError);
          // Fallback: open in new tab
          window.open(downloadUrl, '_blank');
        }
        
        // Show success message
        alert(`  !\n\n${price}     ${uploader}    \n : ${paymentResult.newBalance.toLocaleString()}`);
        
        // Refresh user balance if on profile page
        if (typeof updateUserBalance === 'function') {
          updateUserBalance();
        }
      } else {
        alert(`  : ${paymentResult.error}`);
      }
    } catch (error) {
      console.error('Payment error:', error);
      alert('      ');
    }
  }

  // JD Download Function with Payment
  async function downloadJDFile(url, filename, price = 0, uploader = null) {
    const currentUser = localStorage.getItem('profileName') || 'User Name';
    
    // If no price, download directly
    if (!price || price <= 0) {
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      return;
    }
    
    // Check if user is trying to download their own file
    if (uploader === currentUser) {
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      return;
    }
    
    // Show payment confirmation
    const confirmPayment = confirm(` JD    ${price}  \n\n           \n\n  ?`);
    
    if (!confirmPayment) {
      return;
    }
    
    try {
      // Process payment
      const paymentResult = await processFilePayment(currentUser, uploader, price, 'JD', filename, url);
      
      if (paymentResult.success) {
        // Extract filename from URL for secure download
        const urlParts = url.split('/');
        const serverFilename = urlParts[urlParts.length - 1];
        
        // Create secure download URL with payment verification
        const downloadUrl = `${BASE_URL}/download/${serverFilename}?buyer=${encodeURIComponent(currentUser)}&seller=${encodeURIComponent(uploader)}&amount=${price}&fileType=JD`;
        
        // Download the file using secure endpoint
        try {
          const link = document.createElement('a');
          link.href = downloadUrl;
          link.download = filename;
          link.style.display = 'none';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          // Also try opening in new tab as fallback
          setTimeout(() => {
            window.open(downloadUrl, '_blank');
          }, 100);
        } catch (downloadError) {
          console.error('Download error:', downloadError);
          // Fallback: open in new tab
          window.open(downloadUrl, '_blank');
        }
        
        // Show success message
        alert(`  !\n\n${price}     ${uploader}    \n : ${paymentResult.newBalance.toLocaleString()}`);
        
        // Refresh user balance if on profile page
        if (typeof updateUserBalance === 'function') {
          updateUserBalance();
        }
      } else {
        alert(`  : ${paymentResult.error}`);
      }
    } catch (error) {
      console.error('Payment error:', error);
      alert('      ');
    }
  }

  // TD Download Function (alias for 3D)
  async function downloadTDFile(url, filename, price = 0, uploader = null) {
    return download3DFile(url, filename, price, uploader);
  }

  // Test download function
  function testDownload() {
    console.log('Testing download...');
    const currentUser = localStorage.getItem('profileName') || 'User Name';
    console.log('Current user:', currentUser);
    
    // Test with a known file
    downloadDXFFile(
      'https://my-fb-server-2.onrender.com/uploads/dxf-1754676608096-zcnvn.dxf',
      'test-file',
      50,
      'jui'
    );
  }

  // Direct download function (no payment required)
  function directDownload() {
    console.log('Direct download test...');
    
    // Create a direct download link
    const link = document.createElement('a');
    link.href = 'https://my-fb-server-2.onrender.com/uploads/dxf-1754676608096-zcnvn.dxf';
    link.download = 'test-file.dxf';
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    console.log('Direct download initiated');
  }

  // Set profile name function
  function setProfileName(name) {
    localStorage.setItem('profileName', name);
    console.log('Profile name set to:', name);
    alert('Profile name set to: ' + name);
  }





  // Process file payment
  async function processFilePayment(buyer, seller, amount, fileType, filename, fileUrl) {
    try {
      console.log('Payment request data:', { buyer, seller, amount, fileType, filename, fileUrl });
      console.log('BASE_URL:', BASE_URL);
      
      const requestBody = {
        buyer: buyer,
        seller: seller,
        amount: parseFloat(amount),
        fileType: fileType,
        filename: filename,
        url: fileUrl,
        timestamp: Date.now()
      };
      
      console.log('Request body:', requestBody);
      
      const response = await fetch(`${BASE_URL}/file-payment`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestBody)
      });
      
      console.log('Response status:', response.status);
      console.log('Response ok:', response.ok);
      
      if (!response.ok) {
        const errorData = await response.json();
        console.error('Server error response:', errorData);
        return { success: false, error: errorData.error || 'Payment failed' };
      }
      
      const result = await response.json();
      console.log('Payment response:', result);
      return { success: true, newBalance: result.buyerBalance, fileUrl: result.fileUrl };
    } catch (error) {
      console.error('Payment processing error:', error);
      console.error('Error details:', error.message);
      return { success: false, error: 'Network error: ' + error.message };
    }
  }

  // Drag and drop functionality for DXF upload
  document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('dxfUploadArea');
    const fileInput = document.getElementById('dxfFileInput');

    if (uploadArea && fileInput) {
      uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });

      uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
      });

      uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          fileInput.files = files;
          handleDXFFileSelect(fileInput);
        }
      });
    }
  });

  function handlePriceSelect(select) {
    const customInput = document.getElementById('dxfPriceCustom');
    if (select.value === 'custom') {
      customInput.style.display = '';
      customInput.value = '';
      customInput.focus();
    } else {
      customInput.style.display = 'none';
      customInput.value = '';
    }
  }

  function getDXFPrice() {
    const select = document.getElementById('dxfPriceSelect');
    const customInput = document.getElementById('dxfPriceCustom');
    if (select.value === 'custom') {
      return customInput.value ? parseInt(customInput.value, 10) : '';
    }
    return select.value ? parseInt(select.value, 10) : '';
  }

  function viewDXFFile(url, name, thumbnail) {
    document.getElementById('dxfViewerModal').style.display = 'block';
    document.getElementById('dxfViewerFileName').textContent = name + '.dxf';
    
    // Extract filename from URL
    const filename = url.split('/').pop();
    
    // Show loading state
    document.getElementById('dxfViewerThumbWrap').innerHTML = `
      <div style="text-align:center;padding:20px;">
        <div style="font-size:48px;color:#1877f2;margin-bottom:16px;"></div>
        <div style="font-size:16px;color:#65676b;margin-bottom:8px;">DXF  ...</div>
        <div style="font-size:14px;color:#888;">SVG  </div>
      </div>
    `;
    
    // Convert DXF to SVG and show
    const svgUrl = `https://my-fb-server-2.onrender.com/dxf-to-svg?file=${filename}`;
    
    // Create interactive SVG viewer with zoom
    const svgViewer = `
      <div style="width:100%;max-width:600px;max-height:500px;border:2px solid #1877f2;border-radius:12px;background:#fff;box-shadow:0 4px 20px rgba(24,119,242,0.15);">
        <div style="padding:20px;text-align:center;">
          <div style="font-size:16px;color:#1877f2;margin-bottom:10px;font-weight:600;"> DXF to SVG Preview</div>
          
          <!-- Interactive SVG Container -->
          <div id="svgContainer" style="position:relative;width:100%;height:400px;border-radius:8px;cursor:grab;overflow:hidden;">
            <object data="${svgUrl}" type="image/svg+xml" style="width:100%;height:100%;border-radius:8px;transform-origin:center;" id="svgObject">
              <div style="text-align:center;padding:20px;">
                <div style="font-size:48px;color:#1877f2;margin-bottom:16px;"></div>
                <div style="font-size:16px;color:#65676b;margin-bottom:8px;">DXF </div>
                <div style="font-size:14px;color:#888;">SVG   </div>
              </div>
            </object>
          </div>
          
          <!-- Zoom Controls -->
          <div style="margin-top:15px;display:flex;justify-content:center;gap:10px;">
            <button onclick="zoomIn()" style="padding:8px 16px;background:#ffc107;color:white;border:none;border-radius:6px;cursor:pointer;font-size:14px;">
                
            </button>
            <button onclick="zoomOut()" style="padding:8px 16px;background:#ffc107;color:white;border:none;border-radius:6px;cursor:pointer;font-size:14px;">
                
            </button>
            <button onclick="resetZoom()" style="padding:8px 16px;background:#6c757d;color:white;border:none;border-radius:6px;cursor:pointer;font-size:14px;">
               
            </button>
          </div>
        </div>
      </div>
    `;
    
    // Show SVG after a short delay
    setTimeout(() => {
      document.getElementById('dxfViewerThumbWrap').innerHTML = svgViewer;
    }, 1000);
    
    document.getElementById('dxfViewerDownloadBtn').onclick = function() {
      downloadDXFFile(url, name);
    };
  }
  function closeDXFViewer() {
    document.getElementById('dxfViewerModal').style.display = 'none';
  }
  
  // Test function to show DXF viewer
  function testDXFViewer() {
    viewDXFFile('https://my-fb-server-2.onrender.com/uploads/test.dxf', 'test-file', null);
  }
  
  // Zoom functions
  let currentZoom = 1;
  let isDragging = false;
  let startX, startY, translateX = 0, translateY = 0;
  
  function zoomIn() {
    currentZoom = Math.min(currentZoom * 1.2, 5);
    updateZoom();
  }
  
  function zoomOut() {
    currentZoom = Math.max(currentZoom / 1.2, 0.5);
    updateZoom();
  }
  
  function resetZoom() {
    currentZoom = 1;
    translateX = 0;
    translateY = 0;
    updateZoom();
  }
  
  function updateZoom() {
    const svgObject = document.getElementById('svgObject');
    if (svgObject) {
      svgObject.style.transform = `scale(${currentZoom}) translate(${translateX}px, ${translateY}px)`;
    }
  }
  
  // Mouse events for panning
  document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('svgContainer');
    
    if (container) {
      container.addEventListener('mousedown', function(e) {
        isDragging = true;
        startX = e.clientX - translateX;
        startY = e.clientY - translateY;
        container.style.cursor = 'grabbing';
      });
      
      container.addEventListener('mousemove', function(e) {
        if (isDragging) {
          translateX = e.clientX - startX;
          translateY = e.clientY - startY;
          updateZoom();
        }
      });
      
      container.addEventListener('mouseup', function() {
        isDragging = false;
        container.style.cursor = 'grab';
      });
      
      container.addEventListener('mouseleave', function() {
        isDragging = false;
        container.style.cursor = 'grab';
      });
    }
  });
  

</script>

<!-- Search Modal -->
<div id="searchModal" class="search-modal">
  <div class="search-modal-content">
    <div class="search-modal-header">
      <h3> </h3>
      <button class="search-close" onclick="closeSearchModal()">&times;</button>
    </div>
    <div class="search-input-section">
      <div class="search-input-container">
        <span class="search-icon"></span>
        <input 
          type="text" 
          class="search-input" 
          id="searchInput" 
          placeholder=", ,    ..."
          oninput="performSearch(this.value)"
        >
      </div>
    </div>
    <div class="search-categories">
      <button class="search-category active" data-category="all"></button>
      <button class="search-category" data-category="users"></button>
      <button class="search-category" data-category="posts"></button>
      <button class="search-category" data-category="photos"></button>
      <button class="search-category" data-category="videos"></button>
    </div>
    <div class="search-results" id="searchResults">
      <!-- Search results will be loaded here -->
    </div>
  </div>
</div>

<!-- DXF Modal -->
<div id="dxfModal" class="dxf-modal">
  <div class="dxf-modal-content">
    <div class="dxf-modal-header">
      <h3>DXF   </h3>
      <button class="dxf-close" onclick="closeDXFModal()">&times;</button>
    </div>
    
    <div class="dxf-upload-section" id="dxfUploadSection">
      <div class="dxf-upload-area" id="dxfUploadArea" onclick="document.getElementById('dxfFileInput').click()">
        <div class="dxf-upload-icon"></div>
        <div class="dxf-upload-text">DXF   </div>
        <div class="dxf-upload-subtext">    </div>
      </div>
      <input type="file" id="dxfFileInput" class="dxf-file-input" accept=".dxf" onchange="handleDXFFileSelect(this)">
    </div>
    
    <div class="dxf-preview-section" id="dxfPreviewSection">
      <div class="dxf-preview-header">
        <div class="dxf-file-info">
          <div class="dxf-file-icon"></div>
          <div class="dxf-file-details">
            <h4 id="dxfFileName"> </h4>
            <p id="dxfFileSize"> </p>
          </div>
        </div>
        <button class="dxf-btn dxf-btn-secondary" onclick="removeDXFFile()"></button>
      </div>
      
      <div class="dxf-preview-canvas" id="dxfPreviewCanvas">
        <div class="dxf-preview-placeholder">
          <div class="dxf-preview-placeholder-icon"></div>
          <div>DXF </div>
        </div>
      </div>
      
      <!-- Thumbnail Section -->
      <div class="dxf-thumbnail-section">
        <div class="dxf-thumbnail-header">
          <label class="dxf-option-label"> </label>
          <div class="dxf-thumbnail-actions">
            <button class="dxf-btn dxf-btn-secondary" onclick="uploadCustomThumbnail()"> </button>
            <button class="dxf-btn dxf-btn-secondary" onclick="generateThumbnail()"> </button>
          </div>
        </div>
        
        <div class="dxf-thumbnail-preview" id="dxfThumbnailPreview">
          <div class="dxf-thumbnail-placeholder">
            <div class="dxf-thumbnail-placeholder-icon"></div>
            <div>  </div>
          </div>
        </div>
        
        <input type="file" id="dxfThumbnailInput" accept="image/*" style="display:none;" onchange="handleThumbnailSelect(this)">
      </div>
    </div>
    
    <div class="dxf-options-section" id="dxfOptionsSection">
      <div class="dxf-option-group">
        <label class="dxf-option-label"> </label>
        <input type="text" class="dxf-option-input" id="dxfProjectName" placeholder="  ">
      </div>
      
      <div class="dxf-option-group">
        <label class="dxf-option-label"></label>
        <textarea class="dxf-option-input" id="dxfDescription" placeholder="  " rows="3"></textarea>
      </div>
      
      <div class="dxf-option-group">
        <label class="dxf-option-label"></label>
        <select class="dxf-option-select" id="dxfCategory">
          <option value="">  </option>
          <option value="mechanical"></option>
          <option value="electrical"></option>
          <option value="civil"></option>
          <option value="architectural"></option>
          <option value="automotive"></option>
          <option value="aerospace"></option>
          <option value="other"></option>
        </select>
      </div>
      
      <div class="dxf-option-group">
        <label class="dxf-option-label"></label>
        <input type="text" class="dxf-option-input" id="dxfTags" placeholder="    ">
      </div>
      
      <div class="dxf-option-group">
        <label class="dxf-option-label"></label>
        <select class="dxf-option-select" id="dxfPrivacy">
          <option value="public">  </option>
          <option value="private"></option>
          <option value="friends">  </option>
        </select>
      </div>
      <div class="dxf-option-group">
        <label class="dxf-option-label"></label>
        <div style="display:flex;gap:8px;align-items:center;">
          <select class="dxf-option-select" id="dxfPriceSelect" onchange="handlePriceSelect(this)">
            <option value="">  </option>
            <option value="10"> </option>
            <option value="20"> </option>
            <option value="50"> </option>
            <option value="100"> </option>
            <option value="custom"></option>
          </select>
          <input type="number" min="0" step="1" class="dxf-option-input" id="dxfPriceCustom" placeholder=" " style="width:100px;display:none;">
        </div>
      </div>
    </div>
    
    <div class="dxf-actions">
      <button class="dxf-btn dxf-btn-secondary" onclick="closeDXFModal()"></button>
      <button class="dxf-btn dxf-btn-primary" id="dxfUploadBtn" onclick="uploadDXFFile()" disabled> </button>
    </div>
  </div>
</div>

<!-- Thumbnail Generator Modal -->
<div id="thumbnailGeneratorModal" class="thumbnail-generator-modal">
  <div class="thumbnail-generator-content">
    <div class="thumbnail-generator-header">
      <h3>  </h3>
      <button class="thumbnail-generator-close" onclick="closeThumbnailGenerator()">&times;</button>
    </div>
    
    <div class="thumbnail-generator-body">
      <div class="thumbnail-canvas-container">
        <canvas id="thumbnailCanvas" class="thumbnail-canvas"></canvas>
      </div>
      
      <div class="thumbnail-controls">
        <div class="thumbnail-control-group">
          <label class="thumbnail-control-label"></label>
          <input type="text" class="thumbnail-control-input" id="thumbnailText" placeholder=" " value="DXF Project">
        </div>
        
        <div class="thumbnail-control-group">
          <label class="thumbnail-control-label"> </label>
          <input type="range" class="thumbnail-control-input" id="thumbnailFontSize" min="12" max="72" value="24">
        </div>
        
        <div class="thumbnail-control-group">
          <label class="thumbnail-control-label"> </label>
          <input type="color" class="thumbnail-color-picker" id="thumbnailTextColor" value="#ffffff">
        </div>
        
        <div class="thumbnail-control-group">
          <label class="thumbnail-control-label"> </label>
          <input type="color" class="thumbnail-color-picker" id="thumbnailBgColor" value="#1877f2">
        </div>
      </div>
      
      <div class="thumbnail-templates">
        <div class="thumbnail-template" data-template="blue"></div>
        <div class="thumbnail-template" data-template="green"></div>
        <div class="thumbnail-template" data-template="red"></div>
        <div class="thumbnail-template" data-template="purple"></div>
        <div class="thumbnail-template" data-template="orange"></div>
        <div class="thumbnail-template" data-template="gradient"></div>
      </div>
      
      <div class="dxf-actions">
        <button class="dxf-btn dxf-btn-secondary" onclick="closeThumbnailGenerator()"></button>
        <button class="dxf-btn dxf-btn-primary" onclick="applyThumbnail()">  </button>
      </div>
    </div>
  </div>
</div>

<!-- 3D Modal -->
<div id="tdModal" class="td-modal">
  <div class="td-modal-content">
    <div class="td-modal-header">
      <h3>3D   </h3>
      <button class="td-close" onclick="closeTDModal()">&times;</button>
    </div>
    
    <div class="td-upload-section" id="tdUploadSection">
      <div class="td-upload-area" id="tdUploadArea" onclick="document.getElementById('tdFileInput').click()">
        <div class="td-upload-icon"></div>
        <div class="td-upload-text">3D   </div>
        <div class="td-upload-subtext">    </div>
      </div>
      <input type="file" id="tdFileInput" class="td-file-input" accept=".obj,.stl,.fbx,.3ds,.dae,.blend" onchange="handleTDFileSelect(this)">
    </div>
    
    <div class="td-preview-section" id="tdPreviewSection">
      <div class="td-preview-header">
        <div class="td-file-info">
          <div class="td-file-icon"></div>
          <div class="td-file-details">
            <h4 id="tdFileName"> </h4>
            <p id="tdFileSize"> </p>
          </div>
        </div>
        <button class="td-btn td-btn-secondary" onclick="removeTDFile()"></button>
      </div>
      
      <div class="td-preview-canvas" id="tdPreviewCanvas">
        <div class="td-preview-placeholder">
          <div class="td-preview-placeholder-icon"></div>
          <div>3D </div>
        </div>
      </div>
      
      <!-- Thumbnail Section -->
      <div class="td-thumbnail-section">
        <div class="td-thumbnail-header">
          <label class="td-option-label"> </label>
          <div class="td-thumbnail-actions">
            <button class="td-btn td-btn-secondary" onclick="uploadCustomTDThumbnail()"> </button>
            <button class="td-btn td-btn-secondary" onclick="generateTDThumbnail()"> </button>
          </div>
        </div>
        
        <div class="td-thumbnail-preview" id="tdThumbnailPreview">
          <div class="td-thumbnail-placeholder">
            <div class="td-thumbnail-placeholder-icon"></div>
            <div>  </div>
          </div>
        </div>
        
        <input type="file" id="tdThumbnailInput" accept="image/*" style="display:none;" onchange="handleTDThumbnailSelect(this)">
      </div>
    </div>
    
    <div class="td-options-section" id="tdOptionsSection">
      <div class="td-option-group">
        <label class="td-option-label"> </label>
        <input type="text" class="td-option-input" id="tdProjectName" placeholder="  ">
      </div>
      
      <div class="td-option-group">
        <label class="td-option-label"></label>
        <textarea class="td-option-input" id="tdDescription" placeholder="  " rows="3"></textarea>
      </div>
      
      <div class="td-option-group">
        <label class="td-option-label"></label>
        <select class="td-option-select" id="tdCategory">
          <option value="">  </option>
          <option value="architecture"></option>
          <option value="gaming"></option>
          <option value="animation"></option>
          <option value="product"> </option>
          <option value="character"></option>
          <option value="environment"></option>
          <option value="other"></option>
        </select>
      </div>
      
      <div class="td-option-group">
        <label class="td-option-label"></label>
        <input type="text" class="td-option-input" id="tdTags" placeholder="    ">
      </div>
      
      <div class="td-option-group">
        <label class="td-option-label"></label>
        <select class="td-option-select" id="tdPrivacy">
          <option value="public">  </option>
          <option value="private"></option>
          <option value="friends">  </option>
        </select>
      </div>
      
      <div class="td-option-group">
        <label class="td-option-label"> ()</label>
        <input type="number" class="td-option-input" id="tdPrice" placeholder="  ">
      </div>
    </div>
    
    <div class="td-actions">
      <button class="td-btn td-btn-secondary" onclick="closeTDModal()"></button>
      <button class="td-btn td-btn-primary" id="tdUploadBtn" onclick="uploadTDFile()" disabled>3D  </button>
    </div>
  </div>
</div>

<!-- JD Modal -->
<div id="jdModal" class="jd-modal">
  <div class="jd-modal-content">
    <div class="jd-modal-header">
      <h3>JD   </h3>
      <button class="jd-close" onclick="closeJDModal()">&times;</button>
    </div>
    
    <div class="jd-upload-section" id="jdUploadSection">
      <div class="jd-upload-area" id="jdUploadArea" onclick="document.getElementById('jdFileInput').click()">
        <div class="jd-upload-icon"></div>
        <div class="jd-upload-text">JD   </div>
        <div class="jd-upload-subtext">    </div>
      </div>
      <input type="file" id="jdFileInput" class="jd-file-input" accept=".pdf,.doc,.docx,.txt" onchange="handleJDFileSelect(this)">
    </div>
    
    <div class="jd-preview-section" id="jdPreviewSection">
      <div class="jd-preview-header">
        <div class="jd-file-info">
          <div class="jd-file-icon"></div>
          <div class="jd-file-details">
            <h4 id="jdFileName"> </h4>
            <p id="jdFileSize"> </p>
          </div>
        </div>
        <button class="jd-btn jd-btn-secondary" onclick="removeJDFile()"></button>
      </div>
      
      <div class="jd-preview-canvas" id="jdPreviewCanvas">
        <div class="jd-preview-placeholder">
          <div class="jd-preview-placeholder-icon"></div>
          <div>JD </div>
        </div>
      </div>
      
      <!-- Thumbnail Section -->
      <div class="jd-thumbnail-section">
        <div class="jd-thumbnail-header">
          <label class="jd-option-label"> </label>
          <div class="jd-thumbnail-actions">
            <button class="jd-btn jd-btn-secondary" onclick="uploadCustomJDThumbnail()"> </button>
            <button class="jd-btn jd-btn-secondary" onclick="generateJDThumbnail()"> </button>
          </div>
        </div>
        
        <div class="jd-thumbnail-preview" id="jdThumbnailPreview">
          <div class="jd-thumbnail-placeholder">
            <div class="jd-thumbnail-placeholder-icon"></div>
            <div>  </div>
          </div>
        </div>
        
        <input type="file" id="jdThumbnailInput" accept="image/*" style="display:none;" onchange="handleJDThumbnailSelect(this)">
      </div>
    </div>
    
    <div class="jd-options-section" id="jdOptionsSection">
      <div class="jd-option-group">
        <label class="jd-option-label"> </label>
        <input type="text" class="jd-option-input" id="jdJobTitle" placeholder="  ">
      </div>
      
      <div class="jd-option-group">
        <label class="jd-option-label"> </label>
        <input type="text" class="jd-option-input" id="jdCompanyName" placeholder="  ">
      </div>
      
      <div class="jd-option-group">
        <label class="jd-option-label"></label>
        <textarea class="jd-option-input" id="jdDescription" placeholder="  " rows="3"></textarea>
      </div>
      
      <div class="jd-option-group">
        <label class="jd-option-label"></label>
        <select class="jd-option-select" id="jdCategory">
          <option value="">  </option>
          <option value="software"> </option>
          <option value="design"></option>
          <option value="marketing"></option>
          <option value="sales"></option>
          <option value="hr"></option>
          <option value="finance"></option>
          <option value="engineering"></option>
          <option value="other"></option>
        </select>
      </div>
      
      <div class="jd-option-group">
        <label class="jd-option-label"></label>
        <input type="text" class="jd-option-input" id="jdLocation" placeholder=" ">
      </div>
      
      <div class="jd-option-group">
        <label class="jd-option-label"></label>
        <input type="text" class="jd-option-input" id="jdTags" placeholder="    ">
      </div>
      
      <div class="jd-option-group">
        <label class="jd-option-label"></label>
        <select class="jd-option-select" id="jdPrivacy">
          <option value="public">  </option>
          <option value="private"></option>
          <option value="friends">  </option>
        </select>
      </div>
      
      <div class="jd-option-group">
        <label class="jd-option-label"> ()</label>
        <input type="text" class="jd-option-input" id="jdSalary" placeholder=" ">
      </div>
    </div>
    
    <div class="jd-actions">
      <button class="jd-btn jd-btn-secondary" onclick="closeJDModal()"></button>
      <button class="jd-btn jd-btn-primary" id="jdUploadBtn" onclick="uploadJDFile()" disabled>JD  </button>
    </div>
  </div>
</div>

<!-- Help Modal -->
<div id="helpModal" class="help-modal">
  <div class="help-modal-content">
    <div class="help-modal-header">
      <button class="help-close" onclick="closeHelpModal()">&times;</button>
      <h3>  </h3>
    </div>
    <div class="help-options">
      <div class="help-option" onclick="showDXFGuide()">
        <div class="help-option-icon help-faq"></div>
        <div class="help-option-info">
          <div class="help-option-title">DXF   </div>
          <div class="help-option-desc">DXF     </div>
        </div>
      </div>
      
      <div class="help-option" onclick="show3DGuide()">
        <div class="help-option-icon help-faq"></div>
        <div class="help-option-info">
          <div class="help-option-title">3D   </div>
          <div class="help-option-desc">3D     </div>
        </div>
      </div>
      
      <div class="help-option" onclick="showJDGuide()">
        <div class="help-option-icon help-faq"></div>
        <div class="help-option-info">
          <div class="help-option-title">JD   </div>
          <div class="help-option-desc">JD     </div>
        </div>
      </div>
      
      <div class="help-option" onclick="openWhatsApp()">
        <div class="help-option-icon help-whatsapp"></div>
        <div class="help-option-info">
          <div class="help-option-title"> </div>
          <div class="help-option-desc">   </div>
        </div>
      </div>
      
      <div class="help-option" onclick="copyPhoneNumber()">
        <div class="help-option-icon help-phone"></div>
        <div class="help-option-info">
          <div class="help-option-title">   </div>
          <div class="help-option-desc">01788458049</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Guide Modal -->
<div id="guideModal" class="help-modal">
  <div class="help-modal-content" style="max-width: 500px;">
    <div class="help-modal-header">
      <button class="help-close" onclick="closeGuideModal()">&times;</button>
      <h3 id="guideTitle"></h3>
    </div>
    <div class="help-options" id="guideContent">
      <!-- Guide content will be inserted here -->
    </div>
  </div>
</div>

<!-- Post Viewer Modal -->
<div id="post-viewer-modal" class="post-viewer-modal">
  <div class="post-viewer-content">
    <div class="post-viewer-header">
      <div class="post-viewer-user-info">
        <img class="post-viewer-profile" id="post-viewer-profile" src="default-profile.png" alt="Profile">
        <div class="post-viewer-user-details">
          <div class="post-viewer-username" id="post-viewer-username">User Name</div>
          <div class="post-viewer-time" id="post-viewer-time">2h</div>
        </div>
      </div>
      <div class="post-viewer-actions">
        <button class="post-viewer-btn" id="post-viewer-share" title="Share"></button>
        <button class="post-viewer-btn" id="post-viewer-more" title="More"></button>
        <button class="post-viewer-btn post-viewer-close" id="post-viewer-close" title="Close">&times;</button>
      </div>
    </div>
    
    <div class="post-viewer-media" id="post-viewer-media">
      <!-- Media will be inserted here -->
    </div>
    
    <div class="post-viewer-footer">
      <div class="post-viewer-caption" id="post-viewer-caption">
        <!-- Caption will be inserted here -->
      </div>
      
      <div class="post-viewer-stats">
        <div class="post-viewer-likes" id="post-viewer-likes">0 likes</div>
        <div class="post-viewer-comments" id="post-viewer-comments">0 comments</div>
        <div class="post-viewer-shares" id="post-viewer-shares">0 shares</div>
      </div>
      
      <div class="post-viewer-actions-bar">
        <button class="post-viewer-action-btn" id="post-viewer-like-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M7 10v8a2 2 0 0 0 2 2h6.5a2 2 0 0 0 2-2v-7.5a1 1 0 0 0-1-1H14V7.5A2.5 2.5 0 0 0 11.5 5c-.6 0-1.1.2-1.5.5L7 10z"></path>
            <path d="M7 10H5a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h2"></path>
          </svg>
          <span>Like</span>
        </button>
        
        <button class="post-viewer-action-btn" id="post-viewer-comment-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <ellipse cx="12" cy="12" rx="9" ry="7"></ellipse>
            <path d="M12 19c-2.5 0-4.5-1.5-4.5-3.5"></path>
          </svg>
          <span>Comment</span>
        </button>
        
        <input type="text" class="post-viewer-comment-input" id="post-viewer-comment-input" placeholder="Write a comment...">
        
        <button class="post-viewer-action-btn" id="post-viewer-share-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 12v-2a2 2 0 0 1 2-2h7.5"></path>
            <path d="M14 7l5 5-5 5"></path>
          </svg>
          <span>Share</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Comment Modal -->
<div id="commentModal" class="comment-modal">
  <div class="comment-modal-content">
    <div class="comment-modal-header">
      <div style="display:flex;align-items:center;gap:10px;">
        <img id="modalProfilePic" src="default-profile.png" style="width:36px;height:36px;border-radius:50%;object-fit:cover;">
        <span id="modalProfileName" style="font-weight:600;font-size:16px;"></span>
        <span style="color:#888;font-size:15px;">- </span>
      </div>
      <button class="close-modal" onclick="closeCommentModal()">&times;</button>
    </div>
    <div class="comment-modal-body">
      <div class="comment-post-content" id="modalPostContent">
        <!-- Post content will be inserted here -->
      </div>
      <div class="comments-section" id="commentsList">
        <!-- Comments will be loaded here -->
      </div>
    </div>
    <div class="comment-input-section">
      <div class="comment-input-container">
        <textarea 
          class="comment-input" 
          id="commentInput" 
          placeholder=" ..."
          oninput="handleCommentInput(this)"
        ></textarea>
        <button class="comment-send-btn" id="sendCommentBtn" onclick="sendComment()" disabled>
          
        </button>
      </div>
      <div class="comment-actions">
        <button class="comment-action-btn"></button>
        <button class="comment-action-btn"></button>
        <button class="comment-action-btn"></button>
      </div>
    </div>
  </div>
</div>

<!-- Notifications Modal -->
<div id="notifications-modal" class="comment-modal" style="z-index:10003;">
  <div class="comment-modal-content">
    <div class="comment-modal-header">
      <h3></h3>
      <button class="close-modal" onclick="closeNotificationsModal()">&times;</button>
    </div>
    <div class="comment-modal-body">
      <div id="notifications-list">
        <!-- Notifications will be loaded here -->
      </div>
    </div>
  </div>
</div>

<!-- DXF Viewer Modal -->
<div id="dxfViewerModal" class="dxf-modal" style="z-index:10002;">
  <div class="dxf-modal-content">
    <div class="dxf-modal-header">
      <h3 id="dxfViewerTitle">DXF  </h3>
      <button class="dxf-close" onclick="closeDXFViewer()">&times;</button>
    </div>
    <div style="padding:30px;text-align:center;">
      <div id="dxfViewerThumbWrap" style="margin-bottom:24px;"></div>
      <div id="dxfViewerFileName" style="font-weight:600;font-size:18px;margin-bottom:12px;color:#1c1e21;"></div>
      <div style="margin-bottom:20px;">
        <button id="dxfViewerDownloadBtn" class="dxf-btn dxf-btn-primary" style="margin-right:10px;"></button>
        <button class="dxf-btn dxf-btn-secondary" onclick="closeDXFViewer()"> </button>
      </div>
      <div style="color:#65676b;font-size:14px;line-height:1.4;max-width:400px;margin:0 auto;">
         <strong>:</strong> DXF  SVG-     
           CAD   
      </div>
    </div>
  </div>
</div>
<script>
// Post Viewer Modal Functions
let currentViewingPost = null;

function openPostViewer(postIndex) {
  const post = currentUserFeed[postIndex];
  if (!post) return;
  
  currentViewingPost = post;
  
  // Set user info
  document.getElementById('post-viewer-profile').src = post.profileImage || 'default-profile.png';
  document.getElementById('post-viewer-username').textContent = post.name || post.user || 'User Name';
  document.getElementById('post-viewer-time').textContent = timeAgo(post.time);
  
  // Set caption
  document.getElementById('post-viewer-caption').textContent = post.caption || '';
  
  // Set stats
  const reactions = post.reactions || [];
  const comments = post.comment || 0;
  const shares = post.share || 0;
  
  document.getElementById('post-viewer-likes').textContent = `${reactions.length} likes`;
  document.getElementById('post-viewer-comments').textContent = `${comments} comments`;
  document.getElementById('post-viewer-shares').textContent = `${shares} shares`;
  
  // Set media
  const mediaContainer = document.getElementById('post-viewer-media');
  mediaContainer.innerHTML = '';
  
  if (post.url && post.type) {
    if (post.type.startsWith('image/')) {
      const img = document.createElement('img');
      img.src = post.url;
      img.alt = 'Post Image';
      mediaContainer.appendChild(img);
    } else if (post.type.startsWith('video/')) {
      const video = document.createElement('video');
      video.src = post.url;
      video.controls = true;
      video.autoplay = true;
      video.muted = false;
      mediaContainer.appendChild(video);
    } else if (post.type === 'dxf') {
      // For DXF files, show a preview card
      const projectName = post.caption ? post.caption.split('\n')[0].replace(' ', '') : 'DXF Project';
      const thumbnail = post.thumbnail || null;
      
      const dxfCard = document.createElement('div');
      dxfCard.style.cssText = `
        background: rgba(255,255,255,0.1);
        border: 2px solid rgba(255,255,255,0.2);
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        color: white;
        max-width: 400px;
      `;
      
      if (thumbnail) {
        const thumbImg = document.createElement('img');
        thumbImg.src = thumbnail;
        thumbImg.style.cssText = 'width:100%;height:150px;object-fit:cover;border-radius:8px;margin-bottom:15px;';
        dxfCard.appendChild(thumbImg);
      }
      
      const title = document.createElement('div');
      title.style.cssText = 'font-size:20px;font-weight:600;margin-bottom:10px;';
      title.textContent = projectName;
      dxfCard.appendChild(title);
      
      const type = document.createElement('div');
      type.style.cssText = 'font-size:14px;opacity:0.8;margin-bottom:15px;';
      type.textContent = 'DXF ';
      dxfCard.appendChild(type);
      
      const actions = document.createElement('div');
      actions.style.cssText = 'display:flex;gap:10px;justify-content:center;';
      
      const downloadBtn = document.createElement('button');
      downloadBtn.textContent = '';
      downloadBtn.style.cssText = 'background:#1877f2;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;';
      downloadBtn.onclick = () => downloadDXFFile(post.url, projectName, post.price || 0, post.name || post.user);
      actions.appendChild(downloadBtn);
      
      const viewBtn = document.createElement('button');
      viewBtn.textContent = '';
      viewBtn.style.cssText = 'background:#43a047;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;';
      viewBtn.onclick = () => viewDXFFile(post.url, projectName, post.thumbnail || '');
      actions.appendChild(viewBtn);
      
      dxfCard.appendChild(actions);
      mediaContainer.appendChild(dxfCard);
    }
  }
  
  // Set like button state
  const currentUser = getCurrentUserName();
  const userReaction = reactions.find(r => r.user === currentUser);
  const likeBtn = document.getElementById('post-viewer-like-btn');
  if (userReaction) {
    likeBtn.classList.add('liked');
    likeBtn.querySelector('span').textContent = 'Liked';
  } else {
    likeBtn.classList.remove('liked');
    likeBtn.querySelector('span').textContent = 'Like';
  }
  
  // Show modal
  document.getElementById('post-viewer-modal').style.display = 'block';
  
  // Prevent body scroll
  document.body.style.overflow = 'hidden';
}

function closePostViewer() {
  document.getElementById('post-viewer-modal').style.display = 'none';
  document.body.style.overflow = 'auto';
  currentViewingPost = null;
  
  // Stop any playing videos
  const videos = document.querySelectorAll('#post-viewer-media video');
  videos.forEach(video => {
    video.pause();
    video.currentTime = 0;
  });
}

// Post viewer event listeners
document.addEventListener('DOMContentLoaded', function() {
  // Close button
  document.getElementById('post-viewer-close').onclick = closePostViewer;
  
  // Click outside to close
  document.getElementById('post-viewer-modal').onclick = function(e) {
    if (e.target === this) {
      closePostViewer();
    }
  };
  
  // Like button
  document.getElementById('post-viewer-like-btn').onclick = function() {
    if (!currentViewingPost) return;
    
    const currentUser = getCurrentUserName();
    const postId = 'post-' + currentViewingPost.time;
    
    // Toggle like
    if (this.classList.contains('liked')) {
      // Unlike
      window.__likeClick(postId);
      this.classList.remove('liked');
      this.querySelector('span').textContent = 'Like';
    } else {
      // Like
      window.__likeClick(postId);
      this.classList.add('liked');
      this.querySelector('span').textContent = 'Liked';
    }
    
    // Update like count
    const reactions = currentViewingPost.reactions || [];
    const newCount = this.classList.contains('liked') ? reactions.length + 1 : reactions.length;
    document.getElementById('post-viewer-likes').textContent = `${newCount} likes`;
  };
  
  // Comment button
  document.getElementById('post-viewer-comment-btn').onclick = function() {
    if (!currentViewingPost) return;
    document.getElementById('post-viewer-comment-input').focus();
  };
  
  // Share button
  document.getElementById('post-viewer-share-btn').onclick = function() {
    if (!currentViewingPost) return;
    
    // Simple share functionality
    if (navigator.share) {
      navigator.share({
        title: 'Check out this post',
        text: currentViewingPost.caption || 'Interesting post',
        url: window.location.href
      });
    } else {
      // Fallback: copy to clipboard
      navigator.clipboard.writeText(window.location.href).then(() => {
        alert('Link copied to clipboard!');
      });
    }
    
    // Update share count
    const currentShares = parseInt(document.getElementById('post-viewer-shares').textContent) || 0;
    document.getElementById('post-viewer-shares').textContent = `${currentShares + 1} shares`;
  };
  
  // Comment input
  document.getElementById('post-viewer-comment-input').onkeypress = function(e) {
    if (e.key === 'Enter' && this.value.trim()) {
      // Add comment functionality here
      const comment = this.value.trim();
      this.value = '';
      
      // Update comment count
      const currentComments = parseInt(document.getElementById('post-viewer-comments').textContent) || 0;
      document.getElementById('post-viewer-comments').textContent = `${currentComments + 1} comments`;
      
      // You can add actual comment saving logic here
      console.log('Comment added:', comment);
    }
  };
  
  // More options button
  document.getElementById('post-viewer-more').onclick = function() {
    if (!currentViewingPost) return;
    
    // Show more options (save, report, etc.)
    const options = ['Save post', 'Report post', 'Copy link'];
    const choice = prompt('Choose an option:\n' + options.map((opt, i) => `${i + 1}. ${opt}`).join('\n'));
    
    if (choice === '1') {
      alert('Post saved!');
    } else if (choice === '2') {
      alert('Post reported!');
    } else if (choice === '3') {
      navigator.clipboard.writeText(window.location.href).then(() => {
        alert('Link copied to clipboard!');
      });
    }
  };
  
  // Share button in header
  document.getElementById('post-viewer-share').onclick = function() {
    if (!currentViewingPost) return;
    
    if (navigator.share) {
      navigator.share({
        title: 'Check out this post',
        text: currentViewingPost.caption || 'Interesting post',
        url: window.location.href
      });
    } else {
      navigator.clipboard.writeText(window.location.href).then(() => {
        alert('Link copied to clipboard!');
      });
    }
  };
});

// Update notification badge
function updateNotificationBadge() {
  const badge = document.getElementById('notification-badge');
  const count = getUnreadNotificationCount();
  
  if (count > 0) {
    badge.style.display = 'inline-block';
    badge.textContent = count > 99 ? '99+' : count.toString();
  } else {
    badge.style.display = 'none';
  }
}

// Load and display notifications
function loadNotifications() {
  const userId = localStorage.getItem('userId');
  const userPrefs = userPreferences[userId] || {};
  const notifications = userPrefs.notifications || [];
  const notificationsList = document.getElementById('notifications-list');
  
  if (notifications.length === 0) {
    notificationsList.innerHTML = `
      <div style="text-align:center;padding:40px 20px;color:#65676b;">
        <div style="font-size:48px;margin-bottom:10px;"></div>
        <p>  </p>
        <p style="font-size:14px;">     </p>
      </div>
    `;
    return;
  }
  
  notificationsList.innerHTML = notifications.map(notification => `
    <div class="notification-item" style="padding:15px;border-bottom:1px solid #e4e6ea;cursor:pointer;${!notification.read ? 'background:#f0f8ff;' : ''}" onclick="handleNotificationClick(${notification.id}, ${notification.postId})">
      <div style="display:flex;align-items:flex-start;gap:12px;">
        <div style="width:40px;height:40px;background:#1877f2;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-size:18px;">
          ${notification.postType === '' ? '' : notification.postType === '' ? '' : notification.postType === 'DXF ' ? '' : notification.postType === '3D ' ? '' : notification.postType === ' ' ? '' : ''}
        </div>
        <div style="flex:1;">
          <div style="font-weight:600;color:#1c1e21;margin-bottom:4px;">${notification.message}</div>
          <div style="font-size:13px;color:#65676b;margin-bottom:4px;">${notification.postCaption}</div>
          <div style="font-size:12px;color:#65676b;">${timeAgo(notification.timestamp)}</div>
        </div>
        ${!notification.read ? '<div style="width:8px;height:8px;background:#1877f2;border-radius:50%;margin-top:8px;"></div>' : ''}
      </div>
    </div>
  `).join('');
}

// Handle notification click
function handleNotificationClick(notificationId, postId) {
  markNotificationAsRead(notificationId);
  updateNotificationBadge();
  loadNotifications();
  
  // Find and open the post
  const posts = JSON.parse(localStorage.getItem('posts') || '[]');
  const postIndex = posts.findIndex(p => p.time === postId);
  
  if (postIndex !== -1) {
    openPostViewer(postIndex);
  }
  
  closeNotificationsModal();
}

// Open notifications modal
function openNotificationsModal() {
  document.getElementById('notifications-modal').style.display = 'block';
  loadNotifications();
}

// Close notifications modal
function closeNotificationsModal() {
  document.getElementById('notifications-modal').style.display = 'none';
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
  if (document.getElementById('post-viewer-modal').style.display === 'block') {
    if (e.key === 'Escape') {
      closePostViewer();
    }
  }
});
</script>
</body>
</html>
