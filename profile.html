<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile</title>
  <style>
    body { margin:0; font-family:sans-serif; background:#f0f2f5; }
    .cover { width:100vw; max-width:600px; height:160px; background:#b71c1c url('cover.jpg') center/cover no-repeat; position:relative; margin:0 auto; }
    #coverContainer { background-size:cover!important; background-position:center!important; }
    .profile-pic { width:110px; height:110px; border-radius:50%; border:5px solid #fff; position:absolute; left:18px; bottom:-55px; object-fit:cover; background:#fff; }
    .profile-header { background:#fff; max-width:600px; margin:0 auto; padding:70px 18px 16px 18px; border-radius:0 0 18px 18px; box-shadow:0 2px 8px rgba(0,0,0,0.04); margin-bottom:12px; }
    .profile-name { font-size:1.5rem; font-weight:700; }
    .profile-meta { color:#555; font-size:1rem; margin:6px 0 12px 0; }
    .profile-bio { margin:10px 0; font-size:1.05rem; }
    .profile-actions { display:flex; gap:8px; margin:18px 0 0 0; flex-wrap:wrap; }
    .profile-actions button { background:#1877f2; color:#fff; border:none; border-radius:8px; padding:8px 14px; font-size:0.98rem; font-weight:600; cursor:pointer; }
    .profile-actions button.secondary { background:#43a047; }
    .profile-actions button.tertiary { background:#222; }
    .profile-actions button.more { background:#eee; color:#222; }
    .profile-tabs { display:flex; gap:14px; border-bottom:2px solid #eee; margin:18px 0 0 0; }
    .profile-tabs .tab { padding:10px 0; font-weight:600; color:#555; cursor:pointer; }
    .profile-tabs .tab.active { color:#1877f2; border-bottom:3px solid #1877f2; }
    .profile-stories { display:flex; flex-direction:row; align-items:center; gap:8px; margin:18px 0 0 0; }
    .profile-story { width:44px; height:44px; border-radius:50%; border:2px solid #1877f2; object-fit:cover; }
    #editBioBtn { margin-top:8px;background:#e4e6eb;color:#222;border:none;border-radius:6px;padding:6px 14px;cursor:pointer; }
    #editBioSection { display:none;margin-top:8px; }
    #bioInput { width:98%;font-size:1rem;padding:8px;border-radius:6px; }
    #saveBioBtn { background:#1877f2;color:#fff;border:none;border-radius:6px;padding:6px 18px;margin-top:6px; }
    #cancelBioBtn { background:#e4e6eb;color:#222;border:none;border-radius:6px;padding:6px 14px;margin-top:6px; }
    @media (max-width:650px) {
      .cover, .profile-header { max-width:100vw; }
    }
      .payment-option.selected {
    background: #1877f2 !important;
    border: 3px solid #1877f2 !important;
    color: #fff !important;
  }
  .payment-option.selected div {
    color: #fff !important;
  }
  
  /* ‡¶°‡¶ø‡¶™‡ßã‡¶ú‡¶ø‡¶ü ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶¨‡¶æ‡¶ü‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
  button[id^="channel-"].selected {
    background: #1877f2 !important;
    border: 3px solid #1877f2 !important;
    color: #fff !important;
  }
  button[id^="channel-"].selected span {
    color: #fff !important;
  }
  
  /* ‡¶∏‡ßá‡¶®‡ßç‡¶° ‡¶Æ‡¶æ‡¶®‡¶ø ‡¶¨‡¶æ‡¶ü‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
  #channel-send.selected {
    background: #1877f2 !important;
    border: 3px solid #1877f2 !important;
    color: #fff !important;
  }
  #channel-send.selected span {
    color: #fff !important;
  }
  
  /* ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡¶∂‡¶ü ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶è‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
  .screenshot-upload-area {
    transition: all 0.3s ease;
  }
  
  .screenshot-upload-area:hover {
    border-color: #1877f2 !important;
    background: #e3f2fd !important;
  }
  </style>
</head>
<body>
  <div class="cover" id="coverContainer" style="position:relative;">
    <img id="profilePic" src="default-profile.png" class="profile-pic" alt="Profile" style="z-index:2;">
    <!-- Edit Profile Photo Button -->
    <label for="profilePicInput" style="position:absolute;bottom:-28px;left:112px;z-index:3;background:#fff;border-radius:50%;padding:0.5px;box-shadow:0 1px 4px rgba(0,0,0,0.10);cursor:pointer;display:flex;align-items:center;justify-content:center;width:28px;height:28px;">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="#222" stroke-width="2"/><path d="M8 13.5V10.5C8 9.67157 8.67157 9 9.5 9H14.5C15.3284 9 16 9.67157 16 10.5V13.5C16 14.3284 15.3284 15 14.5 15H9.5C8.67157 15 8 14.3284 8 13.5Z" stroke="#222" stroke-width="2"/><circle cx="12" cy="12" r="2" fill="#222"/></svg>
      <input type="file" id="profilePicInput" accept="image/*" style="display:none">
    </label>
    <!-- Edit Cover Photo Button -->
    <label for="coverPicInput" style="position:absolute;top:10px;right:10px;z-index:3;background:#fff;border-radius:50%;padding:5px;box-shadow:0 1px 4px rgba(0,0,0,0.10);cursor:pointer;display:flex;align-items:center;justify-content:center;width:32px;height:32px;">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><rect x="3" y="5" width="18" height="14" rx="3" stroke="#1877f2" stroke-width="2"/><circle cx="12" cy="12" r="3.5" fill="#1877f2"/></svg>
      <input type="file" id="coverPicInput" accept="image/*" style="display:none">
    </label>
  </div>
  <div class="profile-header">
    <div class="profile-name" style="display:flex;align-items:center;gap:8px;">
      <span id="profileUsername">User Name</span>
      <span id="editUsernameSection" style="display:none;align-items:center;gap:6px;">
        <input id="usernameInput" type="text" placeholder="Enter username" style="font-size:1.1rem;padding:5px 8px;border-radius:6px;border:1.5px solid #e4e6eb;width:120px;">
        <button id="saveUsernameBtn" style="background:#1877f2;color:#fff;border:none;border-radius:6px;padding:4px 12px;font-size:0.98rem;">Save</button>
        <button id="cancelUsernameBtn" style="background:#e4e6eb;color:#222;border:none;border-radius:6px;padding:4px 10px;font-size:0.98rem;">Cancel</button>
      </span>
      <button id="editUsernameMenu" title="Edit Username" style="background:none;border:none;cursor:pointer;font-size:1.5rem;line-height:1;padding:0 4px;display:flex;align-items:center;">
        <span style="font-size:1.6rem;">&#8942;</span>
      </button>
      <button id="addFriendBtn" style="background:#1877f2;color:#fff;border:none;border-radius:8px;padding:6px 16px;font-size:1rem;font-weight:600;cursor:pointer;margin-left:4px;display:flex;align-items:center;gap:6px;">
        <svg width="16" height="16" viewBox="0 0 20 20" fill="none" style="display:inline;"><circle cx="10" cy="10" r="9" stroke="#fff" stroke-width="2"/><path d="M10 6v8M6 10h8" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
        Add Friend
      </button>
      <div id="userBalance" style="margin-left:auto;background:linear-gradient(135deg, #27ae60, #2ecc71);color:#fff;padding:8px 16px;border-radius:20px;font-weight:700;font-size:1.1rem;box-shadow:0 4px 12px rgba(39, 174, 96, 0.3);display:flex;align-items:center;gap:6px;">
        <span style="font-size:1.2rem;">üí∞</span>
        <span id="balanceAmount">‡ß≥ 0</span>
      </div>
    </div>
    <div class="profile-meta">2K followers &nbsp;¬∑&nbsp; 154 following</div>
    <div class="profile-stories">
      <span id="followingStories" style="display:flex;flex-direction:row;align-items:center;gap:8px;"></span>
    </div>
    <div class="profile-bio" id="profileBio" style="display:none;"></div>
    <button id="editBioBtn">Edit Bio</button>
    <div id="editBioSection">
      <textarea id="bioInput" rows="3"></textarea><br>
      <button id="saveBioBtn">Save</button>
      <button id="cancelBioBtn">Cancel</button>
    </div>
    <div class="profile-actions">
      <button onclick="openSimpleDepositModal()">Deposit</button>
      <button class="secondary" onclick="openWithdrawModal()" style="background:#43a047;color:#fff;border:none;border-radius:8px;padding:8px 14px;font-size:0.98rem;font-weight:600;cursor:pointer;">Withdraw</button>
      <button class="tertiary">Advertise</button>
      <button class="more">...</button>
    </div>
    <div class="profile-tabs">
      <div class="tab active" onclick="showTab('posts')">Posts</div>
      <div class="tab" onclick="showTab('about')">About</div>
      <div class="tab" onclick="showTab('dxf')">DXF</div>
      <div class="tab" onclick="showTab('3d')">3D</div>
      <div class="tab" onclick="showTab('jd')">JD</div>
    </div>

  </div>
  
  <!-- Posts Section -->
  <div id="profilePostsSection" style="max-width:600px;margin:0 auto 32px auto;"></div>
  
  <!-- About Section -->
  <div id="profileAboutSection" style="max-width:600px;margin:0 auto 32px auto;display:none;">
    <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border-radius:16px;box-shadow:0 8px 32px rgba(102, 126, 234, 0.3);padding:20px;margin-bottom:16px;">
      <h3 style="margin:0 0 20px 0;font-size:24px;color:#fff;text-align:center;font-weight:700;text-shadow:0 2px 4px rgba(0,0,0,0.3);">‚ú® About Me</h3>
      
      <!-- Basic Info -->
      <div style="background:rgba(255,255,255,0.95);border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 4px 16px rgba(0,0,0,0.1);">
        <h4 style="margin:0 0 16px 0;font-size:18px;color:#1c1e21;display:flex;align-items:center;gap:10px;font-weight:600;">
          <span style="background:linear-gradient(45deg, #667eea, #764ba2);color:#fff;padding:8px;border-radius:50%;font-size:16px;">üë§</span> Basic Information
          <button id="editBasicBtn" onclick="editBasicInfo()" style="background:linear-gradient(45deg, #667eea, #764ba2);color:#fff;border:none;padding:6px 12px;border-radius:20px;font-size:12px;cursor:pointer;margin-left:auto;font-weight:500;box-shadow:0 2px 8px rgba(102, 126, 234, 0.3);">Edit</button>
        </h4>
      
      <!-- Basic Info -->
      <div style="margin-bottom:24px;">
        <h4 style="margin:0 0 12px 0;font-size:16px;color:#1c1e21;display:flex;align-items:center;gap:8px;">
          <span>üë§</span> Basic Information
          <button id="editBasicBtn" onclick="editBasicInfo()" style="background:none;border:none;color:#1877f2;font-size:14px;cursor:pointer;margin-left:auto;">Edit</button>
        </h4>
        <div id="basicInfoDisplay">
          <div style="margin-bottom:12px;padding:12px;background:linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%);border-radius:8px;border-left:4px solid #667eea;">
            <span style="font-weight:600;color:#667eea;font-size:14px;">Name:</span> 
            <span id="displayName" style="color:#1c1e21;font-weight:500;margin-left:8px;">Not specified</span>
          </div>
          <div style="margin-bottom:12px;padding:12px;background:linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%);border-radius:8px;border-left:4px solid #667eea;">
            <span style="font-weight:600;color:#667eea;font-size:14px;">Birthday:</span> 
            <span id="displayBirthday" style="color:#1c1e21;font-weight:500;margin-left:8px;">Not specified</span>
          </div>
          <div style="margin-bottom:12px;padding:12px;background:linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%);border-radius:8px;border-left:4px solid #667eea;">
            <span style="font-weight:600;color:#667eea;font-size:14px;">Gender:</span> 
            <span id="displayGender" style="color:#1c1e21;font-weight:500;margin-left:8px;">Not specified</span>
          </div>
          <div style="margin-bottom:12px;padding:12px;background:linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%);border-radius:8px;border-left:4px solid #667eea;">
            <span style="font-weight:600;color:#667eea;font-size:14px;">Email:</span> 
            <span id="displayEmail" style="color:#1c1e21;font-weight:500;margin-left:8px;">Not specified</span>
          </div>
          <div style="margin-bottom:12px;padding:12px;background:linear-gradient(135deg, #f8f9ff 0%, #e8f2ff 100%);border-radius:8px;border-left:4px solid #667eea;">
            <span style="font-weight:600;color:#667eea;font-size:14px;">Phone:</span> 
            <span id="displayPhone" style="color:#1c1e21;font-weight:500;margin-left:8px;">Not specified</span>
          </div>
        </div>
        <div id="basicInfoEdit" style="display:none;">
          <div style="margin-bottom:16px;">
            <label style="display:block;font-weight:600;color:#667eea;margin-bottom:8px;font-size:14px;">Full Name:</label>
            <input type="text" id="editName" style="width:100%;padding:12px;border:2px solid #e4e6ea;border-radius:8px;font-size:14px;transition:border-color 0.3s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e4e6ea'">
          </div>
          <div style="margin-bottom:16px;">
            <label style="display:block;font-weight:600;color:#667eea;margin-bottom:8px;font-size:14px;">Birthday:</label>
            <input type="date" id="editBirthday" style="width:100%;padding:12px;border:2px solid #e4e6ea;border-radius:8px;font-size:14px;transition:border-color 0.3s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e4e6ea'">
          </div>
          <div style="margin-bottom:16px;">
            <label style="display:block;font-weight:600;color:#667eea;margin-bottom:8px;font-size:14px;">Gender:</label>
            <select id="editGender" style="width:100%;padding:12px;border:2px solid #e4e6ea;border-radius:8px;font-size:14px;transition:border-color 0.3s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e4e6ea'">
              <option value="">Select gender</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div style="margin-bottom:16px;">
            <label style="display:block;font-weight:600;color:#667eea;margin-bottom:8px;font-size:14px;">Email:</label>
            <input type="email" id="editEmail" style="width:100%;padding:12px;border:2px solid #e4e6ea;border-radius:8px;font-size:14px;transition:border-color 0.3s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e4e6ea'">
          </div>
          <div style="margin-bottom:16px;">
            <label style="display:block;font-weight:600;color:#667eea;margin-bottom:8px;font-size:14px;">Phone:</label>
            <input type="tel" id="editPhone" style="width:100%;padding:12px;border:2px solid #e4e6ea;border-radius:8px;font-size:14px;transition:border-color 0.3s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#e4e6ea'">
          </div>
          <div style="display:flex;gap:12px;">
            <button onclick="saveBasicInfo()" style="background:linear-gradient(45deg, #667eea, #764ba2);color:#fff;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:600;box-shadow:0 4px 16px rgba(102, 126, 234, 0.3);transition:transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">Save</button>
            <button onclick="cancelBasicInfo()" style="background:#f8f9fa;color:#667eea;border:2px solid #667eea;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.2s;" onmouseover="this.style.background='#667eea';this.style.color='#fff'" onmouseout="this.style.background='#f8f9fa';this.style.color='#667eea'">Cancel</button>
          </div>
        </div>
      </div>
      
      <!-- Work & Education -->
      <div style="background:rgba(255,255,255,0.95);border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 4px 16px rgba(0,0,0,0.1);">
        <h4 style="margin:0 0 16px 0;font-size:18px;color:#1c1e21;display:flex;align-items:center;gap:10px;font-weight:600;">
          <span style="background:linear-gradient(45deg, #667eea, #764ba2);color:#fff;padding:8px;border-radius:50%;font-size:16px;">üíº</span> Work & Education
          <button id="editWorkBtn" onclick="editWorkInfo()" style="background:linear-gradient(45deg, #667eea, #764ba2);color:#fff;border:none;padding:6px 12px;border-radius:20px;font-size:12px;cursor:pointer;margin-left:auto;font-weight:500;box-shadow:0 2px 8px rgba(102, 126, 234, 0.3);">Edit</button>
        </h4>
        <div id="workInfoDisplay">
          <div style="margin-bottom:8px;">
            <span style="font-weight:600;color:#65676b;">Work:</span> 
            <span id="displayWork">Not specified</span>
          </div>
          <div style="margin-bottom:8px;">
            <span style="font-weight:600;color:#65676b;">Education:</span> 
            <span id="displayEducation">Not specified</span>
          </div>
          <div style="margin-bottom:8px;">
            <span style="font-weight:600;color:#65676b;">Skills:</span> 
            <span id="displaySkills">Not specified</span>
          </div>
        </div>
        <div id="workInfoEdit" style="display:none;">
          <div style="margin-bottom:12px;">
            <label style="display:block;font-weight:600;color:#65676b;margin-bottom:4px;">Work/Job:</label>
            <input type="text" id="editWork" placeholder="e.g., Software Engineer at Tech Company" style="width:100%;padding:8px;border:1px solid #e4e6ea;border-radius:6px;">
          </div>
          <div style="margin-bottom:12px;">
            <label style="display:block;font-weight:600;color:#65676b;margin-bottom:4px;">Education:</label>
            <input type="text" id="editEducation" placeholder="e.g., Bachelor's in Computer Science" style="width:100%;padding:8px;border:1px solid #e4e6ea;border-radius:6px;">
          </div>
          <div style="margin-bottom:12px;">
            <label style="display:block;font-weight:600;color:#65676b;margin-bottom:4px;">Skills:</label>
            <input type="text" id="editSkills" placeholder="e.g., JavaScript, React, Node.js" style="width:100%;padding:8px;border:1px solid #e4e6ea;border-radius:6px;">
          </div>
          <div style="display:flex;gap:8px;">
            <button onclick="saveWorkInfo()" style="background:#1877f2;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">Save</button>
            <button onclick="cancelWorkInfo()" style="background:#e4e6eb;color:#222;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">Cancel</button>
          </div>
        </div>
      </div>
      
      <!-- Places -->
      <div style="margin-bottom:24px;">
        <h4 style="margin:0 0 12px 0;font-size:16px;color:#1c1e21;display:flex;align-items:center;gap:8px;">
          <span>üìç</span> Places
          <button id="editPlacesBtn" onclick="editPlacesInfo()" style="background:none;border:none;color:#1877f2;font-size:14px;cursor:pointer;margin-left:auto;">Edit</button>
        </h4>
        <div id="placesInfoDisplay">
          <div style="margin-bottom:8px;">
            <span style="font-weight:600;color:#65676b;">Current City:</span> 
            <span id="displayCurrentCity">Not specified</span>
          </div>
          <div style="margin-bottom:8px;">
            <span style="font-weight:600;color:#65676b;">Hometown:</span> 
            <span id="displayHometown">Not specified</span>
          </div>
        </div>
        <div id="placesInfoEdit" style="display:none;">
          <div style="margin-bottom:12px;">
            <label style="display:block;font-weight:600;color:#65676b;margin-bottom:4px;">Current City:</label>
            <input type="text" id="editCurrentCity" placeholder="e.g., Dhaka, Bangladesh" style="width:100%;padding:8px;border:1px solid #e4e6ea;border-radius:6px;">
          </div>
          <div style="margin-bottom:12px;">
            <label style="display:block;font-weight:600;color:#65676b;margin-bottom:4px;">Hometown:</label>
            <input type="text" id="editHometown" placeholder="e.g., Chittagong, Bangladesh" style="width:100%;padding:8px;border:1px solid #e4e6ea;border-radius:6px;">
          </div>
          <div style="display:flex;gap:8px;">
            <button onclick="savePlacesInfo()" style="background:#1877f2;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">Save</button>
            <button onclick="cancelPlacesInfo()" style="background:#e4e6eb;color:#222;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">Cancel</button>
          </div>
        </div>
      </div>
      
      <!-- Family & Relationships -->
      <div style="margin-bottom:24px;">
        <h4 style="margin:0 0 12px 0;font-size:16px;color:#1c1e21;display:flex;align-items:center;gap:8px;">
          <span>üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span> Family & Relationships
          <button id="editFamilyBtn" onclick="editFamilyInfo()" style="background:none;border:none;color:#1877f2;font-size:14px;cursor:pointer;margin-left:auto;">Edit</button>
        </h4>
        <div id="familyInfoDisplay">
          <div style="margin-bottom:8px;">
            <span style="font-weight:600;color:#65676b;">Relationship Status:</span> 
            <span id="displayRelationship">Not specified</span>
          </div>
          <div style="margin-bottom:8px;">
            <span style="font-weight:600;color:#65676b;">Family Members:</span> 
            <span id="displayFamily">Not specified</span>
          </div>
        </div>
        <div id="familyInfoEdit" style="display:none;">
          <div style="margin-bottom:12px;">
            <label style="display:block;font-weight:600;color:#65676b;margin-bottom:4px;">Relationship Status:</label>
            <select id="editRelationship" style="width:100%;padding:8px;border:1px solid #e4e6ea;border-radius:6px;">
              <option value="">Select status</option>
              <option value="Single">Single</option>
              <option value="In a relationship">In a relationship</option>
              <option value="Married">Married</option>
              <option value="Engaged">Engaged</option>
              <option value="It's complicated">It's complicated</option>
            </select>
          </div>
          <div style="margin-bottom:12px;">
            <label style="display:block;font-weight:600;color:#65676b;margin-bottom:4px;">Family Members:</label>
            <input type="text" id="editFamily" placeholder="e.g., Parents, 2 siblings" style="width:100%;padding:8px;border:1px solid #e4e6ea;border-radius:6px;">
          </div>
          <div style="display:flex;gap:8px;">
            <button onclick="saveFamilyInfo()" style="background:#1877f2;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">Save</button>
            <button onclick="cancelFamilyInfo()" style="background:#e4e6eb;color:#222;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">Cancel</button>
          </div>
        </div>
      </div>
      
      <!-- Contact & Basic Info -->
      <div style="margin-bottom:24px;">
        <h4 style="margin:0 0 12px 0;font-size:16px;color:#1c1e21;display:flex;align-items:center;gap:8px;">
          <span>üìû</span> Contact & Basic Info
          <button id="editContactBtn" onclick="editContactInfo()" style="background:none;border:none;color:#1877f2;font-size:14px;cursor:pointer;margin-left:auto;">Edit</button>
        </h4>
        <div id="contactInfoDisplay">
          <div style="margin-bottom:8px;">
            <span style="font-weight:600;color:#65676b;">Website:</span> 
            <span id="displayWebsite">Not specified</span>
          </div>
          <div style="margin-bottom:8px;">
            <span style="font-weight:600;color:#65676b;">Social Links:</span> 
            <span id="displaySocialLinks">Not specified</span>
          </div>
        </div>
        <div id="contactInfoEdit" style="display:none;">
          <div style="margin-bottom:12px;">
            <label style="display:block;font-weight:600;color:#65676b;margin-bottom:4px;">Website:</label>
            <input type="url" id="editWebsite" placeholder="e.g., https://example.com" style="width:100%;padding:8px;border:1px solid #e4e6ea;border-radius:6px;">
          </div>
          <div style="margin-bottom:12px;">
            <label style="display:block;font-weight:600;color:#65676b;margin-bottom:4px;">Social Links:</label>
            <input type="text" id="editSocialLinks" placeholder="e.g., Instagram: @username, Twitter: @handle" style="width:100%;padding:8px;border:1px solid #e4e6ea;border-radius:6px;">
          </div>
          <div style="display:flex;gap:8px;">
            <button onclick="saveContactInfo()" style="background:#1877f2;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">Save</button>
            <button onclick="cancelContactInfo()" style="background:#e4e6eb;color:#222;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- DXF Section -->
  <div id="profileDXFSection" style="max-width:600px;margin:0 auto 32px auto;display:none;">
    <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border-radius:16px;box-shadow:0 8px 32px rgba(102, 126, 234, 0.3);padding:20px;margin-bottom:16px;">
      <h3 style="margin:0 0 20px 0;font-size:24px;color:#fff;text-align:center;font-weight:700;text-shadow:0 2px 4px rgba(0,0,0,0.3);">üìê DXF Files</h3>
      <div style="background:rgba(255,255,255,0.95);border-radius:12px;padding:20px;box-shadow:0 4px 16px rgba(0,0,0,0.1);">
        <div style="text-align:center;color:#65676b;padding:20px;">
          <div style="font-size:48px;margin-bottom:16px;">üìê</div>
          <div style="font-size:18px;font-weight:600;margin-bottom:8px;">No DXF files uploaded yet</div>
          <div style="font-size:14px;">Upload your DXF files to share with others</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 3D Section -->
  <div id="profile3DSection" style="max-width:600px;margin:0 auto 32px auto;display:none;">
    <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border-radius:16px;box-shadow:0 8px 32px rgba(102, 126, 234, 0.3);padding:20px;margin-bottom:16px;">
      <h3 style="margin:0 0 20px 0;font-size:24px;color:#fff;text-align:center;font-weight:700;text-shadow:0 2px 4px rgba(0,0,0,0.3);">üé¨ 3D Files</h3>
      <div style="background:rgba(255,255,255,0.95);border-radius:12px;padding:20px;box-shadow:0 4px 16px rgba(0,0,0,0.1);">
        <div style="text-align:center;color:#65676b;padding:20px;">
          <div style="font-size:48px;margin-bottom:16px;">üé¨</div>
          <div style="font-size:18px;font-weight:600;margin-bottom:8px;">No 3D files uploaded yet</div>
          <div style="font-size:14px;">Upload your 3D files to share with others</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- JD Section -->
  <div id="profileJDSection" style="max-width:600px;margin:0 auto 32px auto;display:none;">
    <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border-radius:16px;box-shadow:0 8px 32px rgba(102, 126, 234, 0.3);padding:20px;margin-bottom:16px;">
      <h3 style="margin:0 0 20px 0;font-size:24px;color:#fff;text-align:center;font-weight:700;text-shadow:0 2px 4px rgba(0,0,0,0.3);">üíº Job Posts</h3>
      <div style="background:rgba(255,255,255,0.95);border-radius:12px;padding:20px;box-shadow:0 4px 16px rgba(0,0,0,0.1);">
        <div style="text-align:center;color:#65676b;padding:20px;">
          <div style="font-size:48px;margin-bottom:16px;">üíº</div>
          <div style="font-size:18px;font-weight:600;margin-bottom:8px;">No job posts created yet</div>
          <div style="font-size:14px;">Create job posts to find opportunities</div>
        </div>
      </div>
    </div>
  </div>
  <script>
    // Load user data from registration system
    async function loadUserProfileData() {
      try {
        // First try to get from localStorage (from login)
        const loggedInUser = localStorage.getItem('loggedInUser');
        console.log('Loading user profile data...');
        console.log('localStorage data:', loggedInUser);
        
        if (loggedInUser) {
          const userData = JSON.parse(loggedInUser);
          console.log('Parsed user data:', userData);
          updateProfileWithUserData(userData);
          return;
        }

        // If not in localStorage, try to get from server
        console.log('No localStorage data, trying server...');
        const response = await fetch('/api/current-user');
        if (response.ok) {
          const data = await response.json();
          console.log('Server response:', data);
          if (data.success) {
            updateProfileWithUserData(data.user);
            // Save to localStorage for future use
            localStorage.setItem('loggedInUser', JSON.stringify(data.user));
            console.log('Saved user data to localStorage');
          }
        }
      } catch (error) {
        console.error('Error loading user profile data:', error);
      }
    }

    function updateProfileWithUserData(userData) {
      // Update profile name
      const profileUsername = document.getElementById('profileUsername');
      if (profileUsername && userData.firstName && userData.lastName) {
        profileUsername.textContent = `${userData.firstName} ${userData.lastName}`;
      }

      // Update profile meta (phone number)
      const profileMeta = document.querySelector('.profile-meta');
      if (profileMeta && userData.phoneNumber) {
        profileMeta.textContent = `üì± ${userData.phoneNumber}`;
      }

      // Update bio with birthday if available
      const profileBio = document.querySelector('.profile-bio');
      if (profileBio && userData.month && userData.day && userData.year) {
        const monthNames = [
          'January', 'February', 'March', 'April', 'May', 'June',
          'July', 'August', 'September', 'October', 'November', 'December'
        ];
        const monthName = monthNames[parseInt(userData.month) - 1];
        profileBio.textContent = `üéÇ Birthday: ${monthName} ${userData.day}, ${userData.year}`;
      }

      console.log('Profile updated with user data:', userData);
    }

    // Load user data when page loads
    document.addEventListener('DOMContentLoaded', function() {
      loadUserProfileData();
      
      // Also try to load complete user data from server for about section
      loadCompleteUserData();
    });
    
    // Load complete user data including birthday
    async function loadCompleteUserData() {
      try {
        const loggedInUser = localStorage.getItem('loggedInUser');
        if (loggedInUser) {
          const userData = JSON.parse(loggedInUser);
          console.log('Current user data:', userData);
          
          // If we don't have birthday data, try to get from server
          if (!userData.month || !userData.day || !userData.year) {
            console.log('Missing birthday data, fetching from server...');
            const response = await fetch('/api/current-user');
            if (response.ok) {
              const data = await response.json();
              if (data.success && data.user.month && data.user.day && data.user.year) {
                console.log('Got complete user data from server:', data.user);
                // Update localStorage with complete data
                const updatedUserData = { ...userData, ...data.user };
                localStorage.setItem('loggedInUser', JSON.stringify(updatedUserData));
                console.log('Updated localStorage with complete data');
              }
            }
          }
        }
      } catch (error) {
        console.error('Error loading complete user data:', error);
      }
    }
    // Load bio from localStorage if exists
    async function loadBio() {
      const currentUser = getQueryParam('user') || getCurrentUserName();
      
      // Try to load from server first, then fallback to localStorage
      try {
        const response = await fetch(`${BASE_URL}/bio-data/${currentUser}`);
        if (response.ok) {
          const bioData = await response.json();
          if (bioData.bio) {
            displayBio(bioData.bio);
            return;
          }
        }
      } catch (error) {
        console.error('Error loading bio from server:', error);
      }
      
      // Fallback to localStorage
      var bio = localStorage.getItem('profileBio') || '';
      displayBio(bio);
    }

    function displayBio(bio) {
      var bioDiv = document.getElementById('profileBio');
      var editBtn = document.getElementById('editBioBtn');
      
      if (bio && bio.trim() !== '') {
        bioDiv.innerHTML = bio;
        bioDiv.style.display = 'block';
        editBtn.style.display = 'inline-block';
      } else {
        bioDiv.innerHTML = '';
        bioDiv.style.display = 'none';
        editBtn.style.display = 'inline-block';
      }
    }
    
    loadBio();

    document.getElementById('editBioBtn').onclick = function() {
      document.getElementById('editBioSection').style.display = 'block';
      document.getElementById('editBioBtn').style.display = 'none';
      var current = document.getElementById('profileBio').innerHTML.replace(/<br>/g, '\n').replace(/<[^>]+>/g, '');
      document.getElementById('bioInput').value = current;
    };
    document.getElementById('saveBioBtn').onclick = async function() {
      var val = document.getElementById('bioInput').value.trim();
      const currentUser = getCurrentUserName();
      
      if(val === '') {
        localStorage.removeItem('profileBio');
      } else {
        localStorage.setItem('profileBio', val.replace(/\n/g, '<br>'));
      }
      
      // Upload bio to server
      try {
        const response = await fetch(`${BASE_URL}/upload-bio`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            userName: currentUser,
            bio: val.replace(/\n/g, '<br>')
          })
        });
        
        if (response.ok) {
          console.log('Bio uploaded successfully');
        } else {
          console.error('Failed to upload bio');
        }
      } catch (error) {
        console.error('Error uploading bio:', error);
      }
      
      loadBio();
      document.getElementById('editBioSection').style.display = 'none';
      document.getElementById('editBioBtn').style.display = 'inline-block';
    };
    document.getElementById('cancelBioBtn').onclick = function() {
      document.getElementById('editBioSection').style.display = 'none';
      document.getElementById('editBioBtn').style.display = 'inline-block';
    };

    // Username logic
    function loadUsername() {
      var username = localStorage.getItem('profileName') || 'User Name';
      document.getElementById('profileUsername').textContent = username;
    }
    // Helper: get query param
    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }
    const userName = getQueryParam('user');
    if (userName) {
      // Fetch and show the requested user's profile
              fetch('https://my-fb-server-2.onrender.com/profiles')
        .then(res => res.json())
        .then(profiles => {
          const user = profiles.find(p => p.name === userName);
          if (user) {
            document.getElementById('profileUsername').textContent = user.name;
            document.getElementById('profilePic').src = user.profileImage || 'default-profile.png';
            // Show cover photo if available
            var coverDiv = document.getElementById('coverContainer');
            if (user.background) {
              coverDiv.style.background = `#b71c1c url('${user.background}') center/cover no-repeat`;
            } else {
              coverDiv.style.background = `#b71c1c url('cover.jpg') center/cover no-repeat`;
            }
            // Hide edit buttons for other users
            document.getElementById('editUsernameMenu').style.display = 'none';
            document.querySelector('label[for="profilePicInput"]').style.display = 'none';
            // Disable Add Friend if it's your own profile
            if (user.name === (localStorage.getItem('profileName') || 'User Name')) {
              document.getElementById('addFriendBtn').style.display = 'none';
            }
            loadProfilePosts(user.name);
          }
        });
    } else {
      // Show local user's profile (existing logic)
      loadUsername();
      loadProfilePic();
      loadCoverPic();
      loadProfilePosts(localStorage.getItem('profileName') || 'User Name');
    }
    // Show/hide username edit inline
    const editMenuBtn = document.getElementById('editUsernameMenu');
    const editSection = document.getElementById('editUsernameSection');
    const usernameInput = document.getElementById('usernameInput');
    const usernameSpan = document.getElementById('profileUsername');
    editMenuBtn.onclick = function(e) {
      e.stopPropagation();
      usernameSpan.style.display = 'none';
      editSection.style.display = 'flex';
      usernameInput.value = localStorage.getItem('profileName') || '';
      usernameInput.focus();
    };
    // --- SERVER PROFILE UPLOAD/FETCH LOGIC ---
    const BASE_URL = 'https://my-fb-server-2.onrender.com';

    // Upload profile image and/or name to server
    async function uploadProfileToServer(profileImageFile, name) {
      const formData = new FormData();
      if (profileImageFile) formData.append('file', profileImageFile);
      formData.append('name', name || localStorage.getItem('profileName') || 'User Name');
      try {
        const res = await fetch(`${BASE_URL}/upload-profile`, {
          method: 'POST',
          body: formData
        });
        if (res.ok) {
          const data = await res.json();
          if (data.profileImage) localStorage.setItem('profileImage', data.profileImage);
          if (data.name) localStorage.setItem('profileName', data.name);
          loadProfilePic();
          loadUsername();
        }
      } catch (e) { /* ignore */ }
    }

    // Upload only name (when name changes)
    async function uploadProfileNameOnly(name) {
      await uploadProfileToServer(null, name);
    }

    // Fetch and render all profiles (demo: show as friend list)
    async function fetchAndRenderProfiles() {
      try {
        const res = await fetch(`${BASE_URL}/profiles`);
        if (!res.ok) return;
        const profiles = await res.json();
        const container = document.getElementById('allProfilesList');
        if (!container) return;
        container.innerHTML = profiles.map(p => `
          <div style='display:flex;align-items:center;gap:10px;margin-bottom:8px;'>
            <img src='${p.profileImage || 'default-profile.png'}' style='width:38px;height:38px;border-radius:50%;object-fit:cover;'>
            <span style='font-weight:600;'>${p.name || 'User'}</span>
          </div>
        `).join('');
      } catch (e) {}
    }

    // Profile Pic Upload Handler
    const profilePicInput = document.getElementById('profilePicInput');
    profilePicInput.addEventListener('change', function(e) {
      var file = e.target.files[0];
      if(file) {
        var formData = new FormData();
        formData.append('file', file);
        formData.append('name', localStorage.getItem('profileName') || 'User Name');
        fetch('https://my-fb-server-2.onrender.com/upload-profile', {
          method: 'POST',
          body: formData
        }).then(res => res.json()).then(data => {
          if(data.profileImage) {
            localStorage.setItem('profileImage', data.profileImage); // Save server URL
            document.getElementById('profilePic').src = data.profileImage;
          }
        });
      }
    });
    // Username Save Handler
    const saveUsernameBtn = document.getElementById('saveUsernameBtn');
    saveUsernameBtn.onclick = function() {
      var val = usernameInput.value.trim();
      if(val === '') {
        localStorage.removeItem('profileName');
      } else {
        localStorage.setItem('profileName', val);
        // --- Upload to server ---
        uploadProfileNameOnly(val);
      }
      loadUsername();
      editSection.style.display = 'none';
      usernameSpan.style.display = '';
    };
    document.getElementById('cancelUsernameBtn').onclick = function() {
      editSection.style.display = 'none';
      usernameSpan.style.display = '';
    };
    // Hide menu if click outside
    document.addEventListener('click', function(e) {
      if(editSection.style.display === 'flex' && !editSection.contains(e.target) && e.target !== editMenuBtn) {
        editSection.style.display = 'none';
      }
    });

    // Cover and Profile Photo Logic
    function loadProfilePic() {
      var url = localStorage.getItem('profileImage') || 'default-profile.png';
      document.getElementById('profilePic').src = url;
    }
    function loadCoverPic() {
      var url = localStorage.getItem('coverImage') || '';
      var coverDiv = document.getElementById('coverContainer');
      if(url) {
        coverDiv.style.background = `#b71c1c url('${url}') center/cover no-repeat`;
      } else {
        coverDiv.style.background = `#b71c1c url('cover.jpg') center/cover no-repeat`;
      }
    }
    loadProfilePic();
    loadCoverPic();

    // Follower logic
    function getFollowers() {
      return parseInt(localStorage.getItem('profileFollowers') || '0', 10);
    }
    function setFollowers(val) {
      localStorage.setItem('profileFollowers', val);
    }
    function getFollowing() {
      return parseInt(localStorage.getItem('profileFollowing') || '0', 10);
    }
    function setFollowing(val) {
      localStorage.setItem('profileFollowing', val);
    }
    function hasAddedFriend() {
      return localStorage.getItem('addedFriend') === '1';
    }
    function setAddedFriend() {
      localStorage.setItem('addedFriend', '1');
    }
    function updateFollowersUI() {
      var followers = getFollowers();
      var following = getFollowing();
      var meta = followers + ' followers ¬∑ ' + following + ' following';
      document.querySelector('.profile-meta').textContent = meta;
    }
    function updateAddFriendBtn() {
      var btn = document.getElementById('addFriendBtn');
      if (hasAddedFriend()) {
        btn.disabled = true;
        btn.style.opacity = '0.7';
        btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 20 20" fill="none" style="display:inline;"><circle cx="10" cy="10" r="9" stroke="#fff" stroke-width="2"/><path d="M10 6v8M6 10h8" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg> Friend';
      } else {
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 20 20" fill="none" style="display:inline;"><circle cx="10" cy="10" r="9" stroke="#fff" stroke-width="2"/><path d="M10 6v8M6 10h8" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg> Add Friend';
      }
    }
    // Following Stories logic
    function getFollowingProfiles() {
      try {
        return JSON.parse(localStorage.getItem('followingProfiles') || '[]');
      } catch { return []; }
    }
    function setFollowingProfiles(arr) {
      localStorage.setItem('followingProfiles', JSON.stringify(arr));
    }
    function addFollowingProfile(imgUrl) {
      let arr = getFollowingProfiles();
      arr.unshift(imgUrl); // add to front
      if (arr.length > 3) arr = arr.slice(0,3);
      setFollowingProfiles(arr);
    }
    function renderFollowingStories() {
      const arr = getFollowingProfiles();
      let html = '';
      for(let i=0;i<3;i++) {
        if(arr[i]) {
          html += `<img src="${arr[i]}" class="profile-story" style="border:2px solid #1877f2;object-fit:cover;background:#fff;" alt="Following">`;
        } else {
          html += '<div class="profile-story" style="background:#fff;border:2px solid #ccc;"></div>';
        }
      }
      document.getElementById('followingStories').innerHTML = html;
    }
    renderFollowingStories();
            document.addEventListener('DOMContentLoaded', function() {
            updateFollowersUI();
            updateAddFriendBtn();
            loadUserBalance(); // Load user balance
            startBalanceRefresh(); // Start periodic balance refresh
            // Add a section to show all profiles (Friend List demo)
            const friendListDiv = document.createElement('div');
            friendListDiv.innerHTML = `<h3 style='margin:24px 0 8px 0;'>All Users</h3><div id='allProfilesList'></div>`;
            document.body.appendChild(friendListDiv);
            fetchAndRenderProfiles();
        });
    document.getElementById('addFriendBtn').onclick = function() {
      if (hasAddedFriend()) return;
      var followers = getFollowers() + 1;
      var following = getFollowing() + 1;
      setFollowers(followers);
      setFollowing(following);
      setAddedFriend();
      // Add current profile image to followingProfiles
      var imgUrl = localStorage.getItem('profileImage') || 'default-profile.png';
      addFollowingProfile(imgUrl);
      updateFollowersUI();
      updateAddFriendBtn();
      renderFollowingStories();
    };
    document.getElementById('coverPicInput').addEventListener('change', function(e) {
      var file = e.target.files[0];
      if(file) {
        var formData = new FormData();
        formData.append('file', file);
        formData.append('name', localStorage.getItem('profileName') || 'User Name');
        formData.append('background', '1'); // indicate this is a cover photo
        fetch('https://my-fb-server-2.onrender.com/upload-profile', {
          method: 'POST',
          body: formData
        }).then(res => res.json()).then(data => {
          if(data.background) {
            localStorage.setItem('coverImage', data.background);
            loadCoverPic();
          }
        });
      }
    });

    // Time ago function (same as home.html)
    function timeAgo(ts) {
      const now = Date.now();
      const diff = Math.floor((now - ts) / 1000);
      if(diff < 60) return 'Just now';
      if(diff < 3600) return Math.floor(diff/60) + 'm';
      if(diff < 86400) return Math.floor(diff/3600) + 'h';
      if(diff < 604800) return Math.floor(diff/86400) + 'd';
      const d = new Date(ts);
      return d.toLocaleDateString();
    }

    // Get current user name
    function getCurrentUserName() {
      return localStorage.getItem('profileName') || 'User Name';
    }

    // Get current user phone
    function getCurrentUserPhone() {
      return localStorage.getItem('profilePhone') || 'N/A';
    }

    // Load user balance from server
    async function loadUserBalance() {
      try {
        const userName = getCurrentUserName();
        const response = await fetch(`https://my-fb-server-2.onrender.com/user/balance/${encodeURIComponent(userName)}`);
        
        if (response.ok) {
          const data = await response.json();
          const balanceElement = document.getElementById('balanceAmount');
          if (balanceElement) {
            balanceElement.textContent = `‡ß≥ ${data.balance.toLocaleString()}`;
          }
        } else {
          console.error('Failed to load user balance');
        }
      } catch (error) {
        console.error('Error loading user balance:', error);
      }
    }

                // Update user balance (called when admin approves deposit)
            async function updateUserBalance() {
                await loadUserBalance();
            }

            // Function to refresh balance periodically
            function startBalanceRefresh() {
                setInterval(async () => {
                    await loadUserBalance();
                }, 5000); // Refresh every 5 seconds
            }

    // Show post menu modal (same as home.html)
    let postMenuModal = null;
    function showPostMenu(index, posts) {
      if(postMenuModal) postMenuModal.remove();
      const post = posts[index];
      const currentUser = getCurrentUserName();
      const isOwner = post.name === currentUser || post.user === currentUser;
      
      postMenuModal = document.createElement('div');
      postMenuModal.className = 'post-menu-modal';
      postMenuModal.style.cssText = 'position:fixed;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:9999;display:flex;align-items:flex-end;justify-content:center;';
      
      let menuHTML = `
        <div style="background:#fff;width:100%;max-width:420px;border-radius:18px 18px 0 0;box-shadow:0 2px 16px rgba(0,0,0,0.10);padding:16px 0 8px 0;margin-bottom:0;animation:slideUp .2s;">
          <button onclick="window.__pinPost(${index})" style="width:100%;background:none;border:none;text-align:left;font-size:17px;padding:12px 24px;display:flex;align-items:center;gap:12px;color:#222;cursor:pointer;"><span style="font-size:20px;width:24px;text-align:center;">üìå</span> Pin post</button>
          <button onclick="window.__savePost(${index})" style="width:100%;background:none;border:none;text-align:left;font-size:17px;padding:12px 24px;display:flex;align-items:center;gap:12px;color:#222;cursor:pointer;"><span style="font-size:20px;width:24px;text-align:center;">üîñ</span> Save post</button>
      `;
      
      // ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶™‡ßã‡¶∏‡ßç‡¶ü‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶≤‡¶ø‡¶ï‡¶á ‡¶è‡¶°‡¶ø‡¶ü, ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶á‡¶§‡ßç‡¶Ø‡¶æ‡¶¶‡¶ø ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá
      if (isOwner) {
        menuHTML += `
          <button onclick="window.__editPost(${index})" style="width:100%;background:none;border:none;text-align:left;font-size:17px;padding:12px 24px;display:flex;align-items:center;gap:12px;color:#222;cursor:pointer;"><span style="font-size:20px;width:24px;text-align:center;">‚úèÔ∏è</span> Edit Post</button>
          <button onclick="window.__privacyPost(${index})" style="width:100%;background:none;border:none;text-align:left;font-size:17px;padding:12px 24px;display:flex;align-items:center;gap:12px;color:#222;cursor:pointer;"><span style="font-size:20px;width:24px;text-align:center;">üîí</span> Edit Privacy</button>
          <button onclick="window.__hidePost(${index})" style="width:100%;background:none;border:none;text-align:left;font-size:17px;padding:12px 24px;display:flex;align-items:center;gap:12px;color:#222;cursor:pointer;"><span style="font-size:20px;width:24px;text-align:center;">‚ùå</span> Hide from profile</button>
          <div style="height:1px;background:#eee;margin:6px 0;"></div>
          <button onclick="window.__deletePost(${index})" style="width:100%;background:none;border:none;text-align:left;font-size:17px;padding:12px 24px;display:flex;align-items:center;gap:12px;color:#e53935;cursor:pointer;"><span style="font-size:20px;width:24px;text-align:center;">üóëÔ∏è</span> Delete</button>
        `;
      } else {
        // ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶¶‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶Ö‡¶™‡¶∂‡¶®
        menuHTML += `
          <button onclick="window.__reportPost(${index})" style="width:100%;background:none;border:none;text-align:left;font-size:17px;padding:12px 24px;display:flex;align-items:center;gap:12px;color:#222;cursor:pointer;"><span style="font-size:20px;width:24px;text-align:center;">üö®</span> Report post</button>
          <button onclick="window.__blockUser(${index})" style="width:100%;background:none;border:none;text-align:left;font-size:17px;padding:12px 24px;display:flex;align-items:center;gap:12px;color:#222;cursor:pointer;"><span style="font-size:20px;width:24px;text-align:center;">üö´</span> Block user</button>
        `;
      }
      
      menuHTML += `
          <button onclick="window.__notifyPost(${index})" style="width:100%;background:none;border:none;text-align:left;font-size:17px;padding:12px 24px;display:flex;align-items:center;gap:12px;color:#222;cursor:pointer;"><span style="font-size:20px;width:24px;text-align:center;">üîî</span> Be notified about this post</button>
          <div style="padding:8px 0 0 0;text-align:center;"><button onclick="window.__closePostMenu()" style="background:none;border:none;font-size:18px;color:#1877f2;">Close</button></div>
        </div>
      `;
      
      postMenuModal.innerHTML = menuHTML;
      postMenuModal.onclick = function(e) { if(e.target === postMenuModal) postMenuModal.remove(); };
      document.body.appendChild(postMenuModal);
    }

    // Post menu handlers
    window.__closePostMenu = function() { if(postMenuModal) postMenuModal.remove(); };
    window.__deletePost = function(index) {
      // Delete post logic
      alert('Delete post: Not implemented');
      window.__closePostMenu();
    };
    window.__editPost = function(index) {
      alert('Edit post: Not implemented');
      window.__closePostMenu();
    };
    window.__pinPost = function() { alert('Pin post: Not implemented'); window.__closePostMenu(); };
    window.__savePost = function() { alert('Save post: Not implemented'); window.__closePostMenu(); };
    window.__privacyPost = function() { alert('Edit privacy: Not implemented'); window.__closePostMenu(); };
    window.__hidePost = function() { alert('Hide from profile: Not implemented'); window.__closePostMenu(); };
    window.__notifyPost = function() { alert('Be notified: Not implemented'); window.__closePostMenu(); };
    window.__reportPost = function() { alert('Post reported successfully!'); window.__closePostMenu(); };
    window.__blockUser = function() { alert('User blocked successfully!'); window.__closePostMenu(); };

    async function loadProfilePosts(userName) {
      const res = await fetch('https://my-fb-server-2.onrender.com/posts');
      const posts = await res.json();
      // Filter: only this user's posts (all types)
      const userPosts = posts.filter(p => p.name === userName);
      const section = document.getElementById('profilePostsSection');
      
      if (!userPosts.length) {
        section.innerHTML = `
          <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border-radius:16px;box-shadow:0 8px 32px rgba(102, 126, 234, 0.3);padding:20px;margin-bottom:16px;">
            <h3 style="margin:0 0 20px 0;font-size:24px;color:#fff;text-align:center;font-weight:700;text-shadow:0 2px 4px rgba(0,0,0,0.3);">üìù All Posts</h3>
            <div style="background:rgba(255,255,255,0.95);border-radius:12px;padding:20px;box-shadow:0 4px 16px rgba(0,0,0,0.1);">
              <div style="text-align:center;color:#65676b;padding:20px;">
                <div style="font-size:48px;margin-bottom:16px;">üìù</div>
                <div style="font-size:18px;font-weight:600;margin-bottom:8px;">No posts created yet</div>
                <div style="font-size:14px;">Create your first post to get started</div>
              </div>
            </div>
          </div>
        `;
        return;
      }

      section.innerHTML = `
        <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border-radius:16px;box-shadow:0 8px 32px rgba(102, 126, 234, 0.3);padding:20px;margin-bottom:16px;">
          <h3 style="margin:0 0 20px 0;font-size:24px;color:#fff;text-align:center;font-weight:700;text-shadow:0 2px 4px rgba(0,0,0,0.3);">üìù All Posts (${userPosts.length})</h3>
        </div>
        ${userPosts.map((post, i) => {
          const postId = 'post-' + post.time;
          const currentUser = getCurrentUserName();
          const reactions = post.reactions || [];
          const userReaction = reactions.find(r => r.user === currentUser);
          const totalReactions = reactions.length;
          const liked = !!userReaction;

        // Media rendering (same as home.html)
        let media = '';
        if (post.url && post.type) {
          if(post.type.startsWith('image/')) {
            media = '<div style="position:relative;"><img src="'+post.url+'" alt="Post" style="width:100%;max-width:100%;border-radius:10px;margin-top:8px;cursor:pointer;" onerror="this.parentElement.style.display=\'none\';" onclick="openPostViewer('+i+')"></div>';
          } else if(post.type.startsWith('video/')) {
            media = '<div style="position:relative;"><video src="'+post.url+'" controls style="width:100%;max-width:100%;border-radius:10px;margin-top:8px;"></video></div>';
          } else if(post.type === 'dxf') {
            const projectName = post.caption ? post.caption.split('\n')[0].replace('üìê ', '') : 'DXF Project';
            const thumbnail = post.thumbnail || null;
            
            media = `
              <div style="background:#f8f9fa;border:2px solid #e4e6ea;border-radius:10px;padding:15px;margin-top:8px;cursor:pointer;position:relative;" onclick="openPostViewer(${i})">
                ${thumbnail ? `
                                  <div style="margin-bottom:15px;">
                  <img src="${thumbnail}" alt="Thumbnail" style="width:100%;height:120px;object-fit:contain;object-position:center;border-radius:8px;border:1px solid #e4e6ea;background:#f8f9fa;">
                </div>
                ` : ''}
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                  <div style="font-size:24px;">üìê</div>
                  <div>
                    <div style="font-weight:600;color:#1c1e21;">${projectName}</div>
                    <div style="font-size:13px;color:#65676b;">DXF ‡¶´‡¶æ‡¶á‡¶≤</div>
                  </div>
                </div>
                <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
                  ${post.category ? `<span style="background:#1877f2;color:#fff;padding:4px 8px;border-radius:12px;font-size:12px;">${post.category}</span>` : ''}
                  ${post.tags ? post.tags.split(',').map(tag => `<span style="background:#f0f2f5;color:#65676b;padding:4px 8px;border-radius:12px;font-size:12px;">${tag.trim()}</span>`).join('') : ''}
                </div>
                <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
                  <button onclick="event.stopPropagation();downloadDXFFile('${post.url}', '${projectName}', ${post.price || 0}, '${post.name || post.user}')" style="background:#1877f2;color:#fff;border:none;padding:8px 16px;border-radius:6px;font-size:14px;cursor:pointer;">‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                  <div style="flex:1;text-align:center;">
                    ${post.price ? `<span style='color:#e53935;font-weight:700;font-size:18px;'>${post.price} ‡¶ü‡¶æ‡¶ï‡¶æ</span>` : ''}
                  </div>
                  <button onclick="event.stopPropagation();viewDXFFile('${post.url}', '${projectName}', '${post.thumbnail || ''}')" style="background:#43a047;color:#fff;border:none;padding:8px 16px;border-radius:6px;font-size:14px;cursor:pointer;">‡¶≠‡¶ø‡¶â</button>
                </div>
              </div>
            `;
                     } else if(post.type === '3d') {
             const projectName = post.caption ? post.caption.split('\n')[0].replace('üé≤ ', '') : '3D Project';
             const thumbnail = post.thumbnail || null;
             
             media = `
               <div style="background:#f8f9fa;border:2px solid #e4e6ea;border-radius:10px;padding:15px;margin-top:8px;cursor:pointer;position:relative;" onclick="openPostViewer(${i})">
                 ${thumbnail ? `
                   <div style="margin-bottom:15px;">
                     <img src="${thumbnail}" alt="Thumbnail" style="width:100%;height:120px;object-fit:contain;object-position:center;border-radius:8px;border:1px solid #e4e6ea;background:#f8f9fa;">
                   </div>
                 ` : ''}
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                  <div style="font-size:24px;">üé≤</div>
                  <div>
                    <div style="font-weight:600;color:#1c1e21;">${projectName}</div>
                    <div style="font-size:13px;color:#65676b;">3D ‡¶´‡¶æ‡¶á‡¶≤</div>
                  </div>
                </div>
                <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
                  ${post.category ? `<span style="background:#1877f2;color:#fff;padding:4px 8px;border-radius:12px;font-size:12px;">${post.category}</span>` : ''}
                  ${post.tags ? post.tags.split(',').map(tag => `<span style="background:#f0f2f5;color:#65676b;padding:4px 8px;border-radius:12px;font-size:12px;">${tag.trim()}</span>`).join('') : ''}
                </div>
                <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
                  <button onclick="event.stopPropagation();downloadTDFile('${post.url}', '${projectName}', ${post.price || 0}, '${post.name || post.user}')" style="background:#1877f2;color:#fff;border:none;padding:8px 16px;border-radius:6px;font-size:14px;cursor:pointer;">‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                  <div style="flex:1;text-align:center;">
                    ${post.price ? `<span style='color:#e53935;font-weight:700;font-size:18px;'>${post.price} ‡¶ü‡¶æ‡¶ï‡¶æ</span>` : ''}
                  </div>
                  <button onclick="event.stopPropagation();viewTDFile('${post.url}', '${projectName}', '${post.thumbnail || ''}')" style="background:#43a047;color:#fff;border:none;padding:8px 16px;border-radius:6px;font-size:14px;cursor:pointer;">‡¶≠‡¶ø‡¶â</button>
                </div>
              </div>
            `;
                     } else if(post.type === 'jd') {
             const projectName = post.caption ? post.caption.split('\n')[0].replace('üéØ ', '') : 'GD Project';
             const thumbnail = post.thumbnail || null;
             
             media = `
               <div style="background:#f8f9fa;border:2px solid #e4e6ea;border-radius:10px;padding:15px;margin-top:8px;cursor:pointer;position:relative;" onclick="openPostViewer(${i})">
                 ${thumbnail ? `
                   <div style="margin-bottom:15px;">
                     <img src="${thumbnail}" alt="Thumbnail" style="width:100%;height:120px;object-fit:contain;object-position:center;border-radius:8px;border:1px solid #e4e6ea;background:#f8f9fa;">
                   </div>
                 ` : ''}
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                  <div style="font-size:24px;">üéØ</div>
                  <div>
                    <div style="font-weight:600;color:#1c1e21;">${projectName}</div>
                    <div style="font-size:13px;color:#65676b;">GD ‡¶´‡¶æ‡¶á‡¶≤</div>
                  </div>
                </div>
                <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:8px;">
                  ${post.category ? `<span style="background:#1877f2;color:#fff;padding:4px 8px;border-radius:12px;font-size:12px;">${post.category}</span>` : ''}
                  ${post.tags ? post.tags.split(',').map(tag => `<span style="background:#f0f2f5;color:#65676b;padding:4px 8px;border-radius:12px;font-size:12px;">${tag.trim()}</span>`).join('') : ''}
                </div>
                <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
                  <button onclick="event.stopPropagation();downloadJDFile('${post.url}', '${projectName}', ${post.price || 0}, '${post.name || post.user}')" style="background:#1877f2;color:#fff;border:none;padding:8px 16px;border-radius:6px;font-size:14px;cursor:pointer;">‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                  <div style="flex:1;text-align:center;">
                    ${post.price ? `<span style='color:#e53935;font-weight:700;font-size:18px;'>${post.price} ‡¶ü‡¶æ‡¶ï‡¶æ</span>` : ''}
                  </div>
                  <button onclick="event.stopPropagation();viewJDFile('${post.url}', '${projectName}', '${post.thumbnail || ''}')" style="background:#43a047;color:#fff;border:none;padding:8px 16px;border-radius:6px;font-size:14px;cursor:pointer;">‡¶≠‡¶ø‡¶â</button>
                </div>
              </div>
            `;
          }
        }

        return `
          <div class="fb-post" style="background:#fff;border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,0.04);margin-bottom:12px;padding:12px 12px 0 12px;">
            <div style="display:flex;align-items:center;justify-content:space-between;">
              <div style="display:flex;align-items:center;gap:10px;">
                <img src="${post.profileImage || 'default-profile.png'}" alt="Profile" style="width:44px;height:44px;border-radius:50%;object-fit:cover;">
                <div style="display:flex;flex-direction:column;">
                  <span style="font-weight:600;font-size:16px;display:flex;align-items:center;gap:4px;text-decoration:none;color:#222;">${post.name || 'User'}</span>
                  <span style="font-size:14px;color:#65676b;display:flex;align-items:center;gap:6px;">${timeAgo(post.time)} <span style="font-size:13px;color:#1877f2;font-weight:500;margin-left:2px;">Public</span></span>
                </div>
              </div>
              <div style="display:flex;align-items:center;gap:8px;">
                ${post.name === getCurrentUserName() || post.user === getCurrentUserName() ? '' : '<button style="background:none;border:none;color:#1877f2;font-weight:600;font-size:15px;cursor:pointer;">Follow</button>'}
                <button class="post-menu-btn" title="Options" onclick="showPostMenu(${i}, userPosts)" style="font-size:22px;color:${post.name === getCurrentUserName() || post.user === getCurrentUserName() ? '#1877f2' : '#65676b'};background:none;border:none;cursor:pointer;">‚ãÆ</button>
              </div>
            </div>
            <div style="font-size:17px;margin:10px 0 8px 0;cursor:pointer;" onclick="openPostViewer(${i})">${post.caption ? post.caption.replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>') : ''}</div>
            ${media}
            <div style="display:flex;align-items:center;justify-content:space-between;gap:0;margin:10px 0 0 0;font-size:15px;color:#65676b;">
              <span style="display:flex;flex-direction:row;align-items:center;justify-content:center;width:33.33%;margin-top:6px;">
                ${liked ? `<span style="font-size:20px;margin-right:4px;">üëç</span><span style="font-size:15px;color:#222;margin-right:4px;">‡¶Ü‡¶™‡¶®‡¶ø</span>` : ''}
                <b>${totalReactions || 0}</b>
              </span>
              <span style="display:flex;flex-direction:row;align-items:center;justify-content:center;width:33.33%;margin-top:6px;">
                <b style="margin-right:4px;">${post.comment || 0}</b> comments
              </span>
              <span style="display:flex;flex-direction:row;align-items:center;justify-content:center;width:33.33%;margin-top:6px;">
                <b style="margin-right:4px;">${post.share || 0}</b> shares
              </span>
            </div>
            <div style="background:#fff;display:flex;align-items:center;justify-content:space-around;margin-top:10px;padding:0;">
              <button style="background:none;border:none;display:flex;align-items:center;gap:8px;font-size:18px;cursor:pointer;padding:16px 0;width:33.33%;justify-content:center;font-weight:500;color:${liked ? '#1877f2' : '#222'};" onclick="toggleLike('${postId}', ${i})">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="${liked ? '#1877f2' : '#65676b'}" stroke-width="2.1" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;"><path d="M7 10v8a2 2 0 0 0 2 2h6.5a2 2 0 0 0 2-2v-7.5a1 1 0 0 0-1-1H14V7.5A2.5 2.5 0 0 0 11.5 5c-.6 0-1.1.2-1.5.5L7 10z"></path><path d="M7 10H5a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h2"></path></svg>
                <span>‡¶≤‡¶æ‡¶á‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®</span>
              </button>
              <button style="background:none;border:none;display:flex;align-items:center;gap:8px;font-size:18px;color:#65676b;cursor:pointer;padding:16px 0;width:33.33%;justify-content:center;font-weight:500;" onclick="openCommentModal('${postId}')">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#65676b" stroke-width="2.1" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;"><ellipse cx="12" cy="12" rx="9" ry="7"></ellipse><path d="M12 19c-2.5 0-4.5-1.5-4.5-3.5"></path></svg>
                ‡¶ï‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
              </button>
              <button style="background:none;border:none;display:flex;align-items:center;gap:8px;font-size:18px;color:#65676b;cursor:pointer;padding:16px 0;width:33.33%;justify-content:center;font-weight:500;" onclick="incrementShare('${postId}')">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#65676b" stroke-width="2.1" stroke-linecap="round" stroke-linejoin="round" style="display:inline-block;vertical-align:middle;"><path d="M4 12v-2a2 2 0 0 1 2-2h7.5"></path><path d="M14 7l5 5-5 5"></path></svg>
                ‡¶∂‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
              </button>
            </div>
          </div>
        `;
      }).join('')}
    `;
    }

    // Comment modal (same as home.html)
    let commentModal = null;
    let currentCommentPostId = null;

    function openCommentModal(postId) {
      if(commentModal) commentModal.remove();
      
      currentCommentPostId = postId;
      const posts = JSON.parse(localStorage.getItem('posts') || '[]');
      const post = posts.find(p => ('post-' + p.time) === postId);
      
      if(!post) return;
      
      commentModal = document.createElement('div');
      commentModal.className = 'comment-modal';
      commentModal.style.cssText = 'position:fixed;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:10000;display:flex;align-items:center;justify-content:center;';
      
      const comments = post.comments || [];
      const currentUser = getCurrentUserName();
      
      commentModal.innerHTML = `
        <div style="background:#fff;width:90%;max-width:500px;max-height:80vh;border-radius:12px;display:flex;flex-direction:column;">
          <div style="padding:16px;border-bottom:1px solid #e4e6ea;display:flex;align-items:center;justify-content:space-between;">
            <h3 style="margin:0;font-size:18px;">Comments</h3>
            <button onclick="closeCommentModal()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#65676b;">&times;</button>
          </div>
          <div style="flex:1;overflow-y:auto;padding:16px;">
            ${comments.length === 0 ? '<div style="text-align:center;color:#65676b;padding:20px;">No comments yet</div>' : 
              comments.map(comment => `
                <div style="display:flex;gap:12px;margin-bottom:16px;">
                  <img src="${comment.profileImage || 'default-profile.png'}" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">
                  <div style="flex:1;">
                    <div style="font-weight:600;font-size:14px;margin-bottom:4px;">${comment.user}</div>
                    <div style="font-size:14px;color:#1c1e21;margin-bottom:4px;">${comment.text}</div>
                    <div style="font-size:12px;color:#65676b;">${timeAgo(comment.time)}</div>
                  </div>
                </div>
              `).join('')
            }
          </div>
          <div style="padding:16px;border-top:1px solid #e4e6ea;">
            <div style="display:flex;gap:8px;">
              <img src="${localStorage.getItem('profileImage') || 'default-profile.png'}" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">
              <input type="text" id="commentInput" placeholder="Write a comment..." style="flex:1;padding:8px 12px;border:1px solid #e4e6ea;border-radius:20px;font-size:14px;">
              <button onclick="addComment()" style="background:#1877f2;color:#fff;border:none;padding:8px 16px;border-radius:20px;font-size:14px;cursor:pointer;">Post</button>
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(commentModal);
      
      // Focus on input
      setTimeout(() => {
        const input = document.getElementById('commentInput');
        if(input) input.focus();
      }, 100);
      
      // Close on outside click
      commentModal.onclick = function(e) {
        if(e.target === commentModal) closeCommentModal();
      };
    }

    function closeCommentModal() {
      if(commentModal) {
        commentModal.remove();
        commentModal = null;
        currentCommentPostId = null;
      }
    }

    function addComment() {
      const input = document.getElementById('commentInput');
      const commentText = input.value.trim();
      
      if(!commentText || !currentCommentPostId) return;
      
      const posts = JSON.parse(localStorage.getItem('posts') || '[]');
      const post = posts.find(p => ('post-' + p.time) === currentCommentPostId);
      
      if(!post) return;
      
      if(!post.comments) post.comments = [];
      
      const newComment = {
        user: getCurrentUserName(),
        text: commentText,
        time: Date.now(),
        profileImage: localStorage.getItem('profileImage') || 'default-profile.png'
      };
      
      post.comments.push(newComment);
      localStorage.setItem('posts', JSON.stringify(posts));
      
      // Clear input and reload posts
      input.value = '';
      
      // Get current user name for profile posts reload
      const currentProfileUser = getQueryParam('user') || getCurrentUserName();
      loadProfilePosts(currentProfileUser);
      
      // Refresh comment modal
      openCommentModal(currentCommentPostId);
    }

    // Like function (updated to work with localStorage)
    function toggleLike(postId, index) {
      const currentUser = getCurrentUserName();
      const posts = JSON.parse(localStorage.getItem('posts') || '[]');
      const post = posts.find(p => ('post-' + p.time) === postId);
      
      if (!post) return;
      
      if (!post.reactions) post.reactions = [];
      
      const userReaction = post.reactions.find(r => r.user === currentUser);
      
      if (userReaction && userReaction.emoji === 'üëç') {
        // Remove like
        post.reactions = post.reactions.filter(r => r.user !== currentUser);
      } else {
        // Add like
        if (userReaction) {
          userReaction.emoji = 'üëç';
        } else {
          post.reactions.push({ user: currentUser, emoji: 'üëç' });
        }
      }
      
      localStorage.setItem('posts', JSON.stringify(posts));
      
      // Get current user name for profile posts reload
      const currentProfileUser = getQueryParam('user') || getCurrentUserName();
      loadProfilePosts(currentProfileUser);
    }

    // Share function (updated to work with localStorage)
    function incrementShare(postId) {
      const posts = JSON.parse(localStorage.getItem('posts') || '[]');
      const post = posts.find(p => ('post-' + p.time) === postId);
      
      if (post) {
        if (!post.share) post.share = 0;
        post.share += 1;
        localStorage.setItem('posts', JSON.stringify(posts));
        
        // Get current user name for profile posts reload
        const currentProfileUser = getQueryParam('user') || getCurrentUserName();
        loadProfilePosts(currentProfileUser);
      }
    }

    // Post viewer function (same as home.html)
    function openPostViewer(postIndex) {
      // This would open the same post viewer modal as home.html
      alert('Post viewer will be implemented here');
    }

    // Tab switching function
    function showTab(tabName) {
      // Hide all sections
      document.getElementById('profilePostsSection').style.display = 'none';
      document.getElementById('profileAboutSection').style.display = 'none';
      document.getElementById('profileDXFSection').style.display = 'none';
      document.getElementById('profile3DSection').style.display = 'none';
      document.getElementById('profileJDSection').style.display = 'none';
      
      // Remove active class from all tabs
      document.querySelectorAll('.profile-tabs .tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show selected section and activate tab
      if (tabName === 'posts') {
        document.getElementById('profilePostsSection').style.display = 'block';
        document.querySelector('.profile-tabs .tab:nth-child(1)').classList.add('active');
      } else if (tabName === 'about') {
        document.getElementById('profileAboutSection').style.display = 'block';
        document.querySelector('.profile-tabs .tab:nth-child(2)').classList.add('active');
        loadAboutInfo();
      } else if (tabName === 'dxf') {
        document.getElementById('profileDXFSection').style.display = 'block';
        document.querySelector('.profile-tabs .tab:nth-child(3)').classList.add('active');
        loadDXFFiles();
      } else if (tabName === '3d') {
        document.getElementById('profile3DSection').style.display = 'block';
        document.querySelector('.profile-tabs .tab:nth-child(4)').classList.add('active');
        load3DFiles();
      } else if (tabName === 'jd') {
        document.getElementById('profileJDSection').style.display = 'block';
        document.querySelector('.profile-tabs .tab:nth-child(5)').classList.add('active');
        loadJDFiles();
      }
    }

    // About section functions
    async function loadAboutInfo() {
      // Try to load from server first, then fallback to localStorage
      const aboutData = await loadAboutDataFromServer();
      const currentUser = getQueryParam('user') || getCurrentUserName();
      
      // Load data for current user
      const userData = aboutData[currentUser] || {};
      
      // Try to get registration data for auto-fill
      let registrationData = null;
      try {
        const loggedInUser = localStorage.getItem('loggedInUser');
        console.log('Logged in user data from localStorage:', loggedInUser);
        if (loggedInUser) {
          registrationData = JSON.parse(loggedInUser);
          console.log('Parsed registration data:', registrationData);
        }
      } catch (error) {
        console.error('Error parsing logged in user data:', error);
      }
      
      // Display basic info with auto-fill from registration
      document.getElementById('displayName').textContent = registrationData ? 
        `${registrationData.firstName} ${registrationData.lastName}` : 
        (userData.fullName || 'Not specified');
      
      // Auto-fill birthday from registration data
      let birthdayText = 'Not specified';
      if (registrationData && registrationData.month && registrationData.day && registrationData.year) {
        console.log('Birthday data found:', {
          month: registrationData.month,
          day: registrationData.day,
          year: registrationData.year
        });
        const monthNames = [
          'January', 'February', 'March', 'April', 'May', 'June',
          'July', 'August', 'September', 'October', 'November', 'December'
        ];
        const monthName = monthNames[parseInt(registrationData.month) - 1];
        birthdayText = `${monthName} ${registrationData.day}, ${registrationData.year}`;
        console.log('Formatted birthday:', birthdayText);
      } else if (userData.birthday) {
        birthdayText = userData.birthday;
      }
      document.getElementById('displayBirthday').textContent = birthdayText;
      
      document.getElementById('displayGender').textContent = userData.gender || 'Not specified';
      document.getElementById('displayEmail').textContent = userData.email || 'Not specified';
      
      // Auto-fill phone from registration data
      document.getElementById('displayPhone').textContent = registrationData ? 
        registrationData.phoneNumber : 
        (userData.phone || 'Not specified');
      
      // Display work info
      document.getElementById('displayWork').textContent = userData.work || 'Not specified';
      document.getElementById('displayEducation').textContent = userData.education || 'Not specified';
      document.getElementById('displaySkills').textContent = userData.skills || 'Not specified';
      
      // Display places info
      document.getElementById('displayCurrentCity').textContent = userData.currentCity || 'Not specified';
      document.getElementById('displayHometown').textContent = userData.hometown || 'Not specified';
      
      // Display family info
      document.getElementById('displayRelationship').textContent = userData.relationship || 'Not specified';
      document.getElementById('displayFamily').textContent = userData.family || 'Not specified';
      
      // Display contact info
      document.getElementById('displayWebsite').textContent = userData.website || 'Not specified';
      document.getElementById('displaySocialLinks').textContent = userData.socialLinks || 'Not specified';
    }

    // Basic Info functions
    function editBasicInfo() {
      const aboutData = JSON.parse(localStorage.getItem('profileAboutData') || '{}');
      const currentUser = getQueryParam('user') || getCurrentUserName();
      const userData = aboutData[currentUser] || {};
      
      // Try to get registration data for auto-fill
      let registrationData = null;
      try {
        const loggedInUser = localStorage.getItem('loggedInUser');
        if (loggedInUser) {
          registrationData = JSON.parse(loggedInUser);
        }
      } catch (error) {
        console.error('Error parsing logged in user data:', error);
      }
      
      // Auto-fill name from registration data
      document.getElementById('editName').value = registrationData ? 
        `${registrationData.firstName} ${registrationData.lastName}` : 
        (userData.fullName || '');
      
      // Auto-fill birthday from registration data
      let birthdayValue = '';
      if (registrationData && registrationData.month && registrationData.day && registrationData.year) {
        const monthNames = [
          'January', 'February', 'March', 'April', 'May', 'June',
          'July', 'August', 'September', 'October', 'November', 'December'
        ];
        const monthName = monthNames[parseInt(registrationData.month) - 1];
        birthdayValue = `${monthName} ${registrationData.day}, ${registrationData.year}`;
      } else {
        birthdayValue = userData.birthday || '';
      }
      document.getElementById('editBirthday').value = birthdayValue;
      
      document.getElementById('editGender').value = userData.gender || '';
      document.getElementById('editEmail').value = userData.email || '';
      
      // Auto-fill phone from registration data
      document.getElementById('editPhone').value = registrationData ? 
        registrationData.phoneNumber : 
        (userData.phone || '');
      
      document.getElementById('basicInfoDisplay').style.display = 'none';
      document.getElementById('basicInfoEdit').style.display = 'block';
    }

    function saveBasicInfo() {
      const aboutData = JSON.parse(localStorage.getItem('profileAboutData') || '{}');
      const currentUser = getQueryParam('user') || getCurrentUserName();
      
      if (!aboutData[currentUser]) aboutData[currentUser] = {};
      
      aboutData[currentUser].fullName = document.getElementById('editName').value;
      aboutData[currentUser].birthday = document.getElementById('editBirthday').value;
      aboutData[currentUser].gender = document.getElementById('editGender').value;
      aboutData[currentUser].email = document.getElementById('editEmail').value;
      aboutData[currentUser].phone = document.getElementById('editPhone').value;
      
      localStorage.setItem('profileAboutData', JSON.stringify(aboutData));
      
      // Upload to server
      uploadAboutDataToServer(currentUser, aboutData[currentUser]);
      
      document.getElementById('basicInfoDisplay').style.display = 'block';
      document.getElementById('basicInfoEdit').style.display = 'none';
      
      loadAboutInfo();
    }

    // Upload about data to server
    async function uploadAboutDataToServer(userName, userData) {
      try {
        const response = await fetch(`${BASE_URL}/upload-about`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            userName: userName,
            aboutData: userData
          })
        });
        
        if (response.ok) {
          console.log('About data uploaded successfully');
        } else {
          console.error('Failed to upload about data');
        }
      } catch (error) {
        console.error('Error uploading about data:', error);
      }
    }

    // Load about data from server
    async function loadAboutDataFromServer() {
      try {
        const response = await fetch(`${BASE_URL}/about-data`);
        if (response.ok) {
          const serverData = await response.json();
          localStorage.setItem('profileAboutData', JSON.stringify(serverData));
          return serverData;
        }
      } catch (error) {
        console.error('Error loading about data from server:', error);
      }
      return JSON.parse(localStorage.getItem('profileAboutData') || '{}');
    }

    function cancelBasicInfo() {
      document.getElementById('basicInfoDisplay').style.display = 'block';
      document.getElementById('basicInfoEdit').style.display = 'none';
    }

    // Work Info functions
    function editWorkInfo() {
      const aboutData = JSON.parse(localStorage.getItem('profileAboutData') || '{}');
      const currentUser = getQueryParam('user') || getCurrentUserName();
      const userData = aboutData[currentUser] || {};
      
      document.getElementById('editWork').value = userData.work || '';
      document.getElementById('editEducation').value = userData.education || '';
      document.getElementById('editSkills').value = userData.skills || '';
      
      document.getElementById('workInfoDisplay').style.display = 'none';
      document.getElementById('workInfoEdit').style.display = 'block';
    }

    function saveWorkInfo() {
      const aboutData = JSON.parse(localStorage.getItem('profileAboutData') || '{}');
      const currentUser = getQueryParam('user') || getCurrentUserName();
      
      if (!aboutData[currentUser]) aboutData[currentUser] = {};
      
      aboutData[currentUser].work = document.getElementById('editWork').value;
      aboutData[currentUser].education = document.getElementById('editEducation').value;
      aboutData[currentUser].skills = document.getElementById('editSkills').value;
      
      localStorage.setItem('profileAboutData', JSON.stringify(aboutData));
      
      // Upload to server
      uploadAboutDataToServer(currentUser, aboutData[currentUser]);
      
      document.getElementById('workInfoDisplay').style.display = 'block';
      document.getElementById('workInfoEdit').style.display = 'none';
      
      loadAboutInfo();
    }

    function cancelWorkInfo() {
      document.getElementById('workInfoDisplay').style.display = 'block';
      document.getElementById('workInfoEdit').style.display = 'none';
    }

    // Places Info functions
    function editPlacesInfo() {
      const aboutData = JSON.parse(localStorage.getItem('profileAboutData') || '{}');
      const currentUser = getQueryParam('user') || getCurrentUserName();
      const userData = aboutData[currentUser] || {};
      
      document.getElementById('editCurrentCity').value = userData.currentCity || '';
      document.getElementById('editHometown').value = userData.hometown || '';
      
      document.getElementById('placesInfoDisplay').style.display = 'none';
      document.getElementById('placesInfoEdit').style.display = 'block';
    }

    function savePlacesInfo() {
      const aboutData = JSON.parse(localStorage.getItem('profileAboutData') || '{}');
      const currentUser = getQueryParam('user') || getCurrentUserName();
      
      if (!aboutData[currentUser]) aboutData[currentUser] = {};
      
      aboutData[currentUser].currentCity = document.getElementById('editCurrentCity').value;
      aboutData[currentUser].hometown = document.getElementById('editHometown').value;
      
      localStorage.setItem('profileAboutData', JSON.stringify(aboutData));
      
      // Upload to server
      uploadAboutDataToServer(currentUser, aboutData[currentUser]);
      
      document.getElementById('placesInfoDisplay').style.display = 'block';
      document.getElementById('placesInfoEdit').style.display = 'none';
      
      loadAboutInfo();
    }

    function cancelPlacesInfo() {
      document.getElementById('placesInfoDisplay').style.display = 'block';
      document.getElementById('placesInfoEdit').style.display = 'none';
    }

    // Family Info functions
    function editFamilyInfo() {
      const aboutData = JSON.parse(localStorage.getItem('profileAboutData') || '{}');
      const currentUser = getQueryParam('user') || getCurrentUserName();
      const userData = aboutData[currentUser] || {};
      
      document.getElementById('editRelationship').value = userData.relationship || '';
      document.getElementById('editFamily').value = userData.family || '';
      
      document.getElementById('familyInfoDisplay').style.display = 'none';
      document.getElementById('familyInfoEdit').style.display = 'block';
    }

    function saveFamilyInfo() {
      const aboutData = JSON.parse(localStorage.getItem('profileAboutData') || '{}');
      const currentUser = getQueryParam('user') || getCurrentUserName();
      
      if (!aboutData[currentUser]) aboutData[currentUser] = {};
      
      aboutData[currentUser].relationship = document.getElementById('editRelationship').value;
      aboutData[currentUser].family = document.getElementById('editFamily').value;
      
      localStorage.setItem('profileAboutData', JSON.stringify(aboutData));
      
      // Upload to server
      uploadAboutDataToServer(currentUser, aboutData[currentUser]);
      
      document.getElementById('familyInfoDisplay').style.display = 'block';
      document.getElementById('familyInfoEdit').style.display = 'none';
      
      loadAboutInfo();
    }

    function cancelFamilyInfo() {
      document.getElementById('familyInfoDisplay').style.display = 'block';
      document.getElementById('familyInfoEdit').style.display = 'none';
    }

    // Contact Info functions
    function editContactInfo() {
      const aboutData = JSON.parse(localStorage.getItem('profileAboutData') || '{}');
      const currentUser = getQueryParam('user') || getCurrentUserName();
      const userData = aboutData[currentUser] || {};
      
      document.getElementById('editWebsite').value = userData.website || '';
      document.getElementById('editSocialLinks').value = userData.socialLinks || '';
      
      document.getElementById('contactInfoDisplay').style.display = 'none';
      document.getElementById('contactInfoEdit').style.display = 'block';
    }

    function saveContactInfo() {
      const aboutData = JSON.parse(localStorage.getItem('profileAboutData') || '{}');
      const currentUser = getQueryParam('user') || getCurrentUserName();
      
      if (!aboutData[currentUser]) aboutData[currentUser] = {};
      
      aboutData[currentUser].website = document.getElementById('editWebsite').value;
      aboutData[currentUser].socialLinks = document.getElementById('editSocialLinks').value;
      
      localStorage.setItem('profileAboutData', JSON.stringify(aboutData));
      
      // Upload to server
      uploadAboutDataToServer(currentUser, aboutData[currentUser]);
      
      document.getElementById('contactInfoDisplay').style.display = 'block';
      document.getElementById('contactInfoEdit').style.display = 'none';
      
      loadAboutInfo();
    }

    function cancelContactInfo() {
      document.getElementById('contactInfoDisplay').style.display = 'block';
      document.getElementById('contactInfoEdit').style.display = 'none';
    }

    // Load DXF files for the user
    async function loadDXFFiles() {
      const currentUser = getQueryParam('user') || getCurrentUserName();
      const posts = JSON.parse(localStorage.getItem('posts') || '[]');
      const dxfPosts = posts.filter(p => p.name === currentUser && p.type === 'dxf');
      
      const dxfSection = document.getElementById('profileDXFSection');
      if (dxfPosts.length === 0) {
        dxfSection.innerHTML = `
          <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border-radius:16px;box-shadow:0 8px 32px rgba(102, 126, 234, 0.3);padding:20px;margin-bottom:16px;">
            <h3 style="margin:0 0 20px 0;font-size:24px;color:#fff;text-align:center;font-weight:700;text-shadow:0 2px 4px rgba(0,0,0,0.3);">üìê DXF Files</h3>
            <div style="background:rgba(255,255,255,0.95);border-radius:12px;padding:20px;box-shadow:0 4px 16px rgba(0,0,0,0.1);">
              <div style="text-align:center;color:#65676b;padding:20px;">
                <div style="font-size:48px;margin-bottom:16px;">üìê</div>
                <div style="font-size:18px;font-weight:600;margin-bottom:8px;">No DXF files uploaded yet</div>
                <div style="font-size:14px;">Upload your DXF files to share with others</div>
              </div>
            </div>
          </div>
        `;
        return;
      }
      
      dxfSection.innerHTML = `
        <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border-radius:16px;box-shadow:0 8px 32px rgba(102, 126, 234, 0.3);padding:20px;margin-bottom:16px;">
          <h3 style="margin:0 0 20px 0;font-size:24px;color:#fff;text-align:center;font-weight:700;text-shadow:0 2px 4px rgba(0,0,0,0.3);">üìê DXF Files (${dxfPosts.length})</h3>
          ${dxfPosts.map((post, index) => {
            const projectName = post.caption ? post.caption.split('\n')[0].replace('üìê ', '') : 'DXF Project';
            return `
              <div style="background:rgba(255,255,255,0.95);border-radius:12px;padding:20px;margin-bottom:16px;box-shadow:0 4px 16px rgba(0,0,0,0.1);">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                  <div style="font-size:32px;">üìê</div>
                  <div style="flex:1;">
                    <div style="font-weight:600;color:#1c1e21;font-size:16px;">${projectName}</div>
                    <div style="font-size:13px;color:#65676b;">${timeAgo(post.time)}</div>
                  </div>
                </div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;">
                  ${post.category ? `<span style="background:#1877f2;color:#fff;padding:4px 8px;border-radius:12px;font-size:12px;">${post.category}</span>` : ''}
                  ${post.tags ? post.tags.split(',').map(tag => `<span style="background:#f0f2f5;color:#65676b;padding:4px 8px;border-radius:12px;font-size:12px;">${tag.trim()}</span>`).join('') : ''}
                </div>
                <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
                  <button onclick="downloadDXFFile('${post.url}', '${projectName}', ${post.price || 0}, '${post.name || post.user}')" style="background:#1877f2;color:#fff;border:none;padding:8px 16px;border-radius:6px;font-size:14px;cursor:pointer;">Download</button>
                  <div style="flex:1;text-align:center;">
                    ${post.price ? `<span style='color:#e53935;font-weight:700;font-size:18px;'>${post.price} ‡¶ü‡¶æ‡¶ï‡¶æ</span>` : ''}
                  </div>
                  <button onclick="viewDXFFile('${post.url}', '${projectName}', '${post.thumbnail || ''}')" style="background:#43a047;color:#fff;border:none;padding:8px 16px;border-radius:6px;font-size:14px;cursor:pointer;">View</button>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    // Load 3D files for the user
    async function load3DFiles() {
      const currentUser = getQueryParam('user') || getCurrentUserName();
      const posts = JSON.parse(localStorage.getItem('posts') || '[]');
      const tdPosts = posts.filter(p => p.name === currentUser && p.type === '3d');
      
      const tdSection = document.getElementById('profile3DSection');
      if (tdPosts.length === 0) {
        tdSection.innerHTML = `
          <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border-radius:16px;box-shadow:0 8px 32px rgba(102, 126, 234, 0.3);padding:20px;margin-bottom:16px;">
            <h3 style="margin:0 0 20px 0;font-size:24px;color:#fff;text-align:center;font-weight:700;text-shadow:0 2px 4px rgba(0,0,0,0.3);">üé¨ 3D Files</h3>
            <div style="background:rgba(255,255,255,0.95);border-radius:12px;padding:20px;box-shadow:0 4px 16px rgba(0,0,0,0.1);">
              <div style="text-align:center;color:#65676b;padding:20px;">
                <div style="font-size:48px;margin-bottom:16px;">üé¨</div>
                <div style="font-size:18px;font-weight:600;margin-bottom:8px;">No 3D files uploaded yet</div>
                <div style="font-size:14px;">Upload your 3D files to share with others</div>
              </div>
            </div>
          </div>
        `;
        return;
      }
      
      tdSection.innerHTML = `
        <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border-radius:16px;box-shadow:0 8px 32px rgba(102, 126, 234, 0.3);padding:20px;margin-bottom:16px;">
          <h3 style="margin:0 0 20px 0;font-size:24px;color:#fff;text-align:center;font-weight:700;text-shadow:0 2px 4px rgba(0,0,0,0.3);">üé¨ 3D Files (${tdPosts.length})</h3>
          ${tdPosts.map((post, index) => {
            const projectName = post.caption ? post.caption.split('\n')[0].replace('üé¨ ', '') : '3D Project';
            return `
              <div style="background:rgba(255,255,255,0.95);border-radius:12px;padding:20px;margin-bottom:16px;box-shadow:0 4px 16px rgba(0,0,0,0.1);">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                  <div style="font-size:32px;">üé¨</div>
                  <div style="flex:1;">
                    <div style="font-weight:600;color:#1c1e21;font-size:16px;">${projectName}</div>
                    <div style="font-size:13px;color:#65676b;">${timeAgo(post.time)}</div>
                  </div>
                </div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;">
                  ${post.category ? `<span style="background:#1877f2;color:#fff;padding:4px 8px;border-radius:12px;font-size:12px;">${post.category}</span>` : ''}
                  ${post.tags ? post.tags.split(',').map(tag => `<span style="background:#f0f2f5;color:#65676b;padding:4px 8px;border-radius:12px;font-size:12px;">${tag.trim()}</span>`).join('') : ''}
                </div>
                <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
                  <button onclick="download3DFile('${post.url}', '${projectName}', ${post.price || 0}, '${post.name || post.user}')" style="background:#1877f2;color:#fff;border:none;padding:8px 16px;border-radius:6px;font-size:14px;cursor:pointer;">Download</button>
                  <div style="flex:1;text-align:center;">
                    ${post.price ? `<span style='color:#e53935;font-weight:700;font-size:18px;'>${post.price} ‡¶ü‡¶æ‡¶ï‡¶æ</span>` : ''}
                  </div>
                  <button onclick="viewTDFile('${post.url}', '${projectName}', '${post.thumbnail || ''}')" style="background:#43a047;color:#fff;border:none;padding:8px 16px;border-radius:6px;font-size:14px;cursor:pointer;">View</button>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    // Load JD files for the user
    async function loadJDFiles() {
      const currentUser = getQueryParam('user') || getCurrentUserName();
      const posts = JSON.parse(localStorage.getItem('posts') || '[]');
      const jdPosts = posts.filter(p => p.name === currentUser && p.type === 'jd');
      
      const jdSection = document.getElementById('profileJDSection');
      if (jdPosts.length === 0) {
        jdSection.innerHTML = `
          <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border-radius:16px;box-shadow:0 8px 32px rgba(102, 126, 234, 0.3);padding:20px;margin-bottom:16px;">
            <h3 style="margin:0 0 20px 0;font-size:24px;color:#fff;text-align:center;font-weight:700;text-shadow:0 2px 4px rgba(0,0,0,0.3);">üíº Job Posts</h3>
            <div style="background:rgba(255,255,255,0.95);border-radius:12px;padding:20px;box-shadow:0 4px 16px rgba(0,0,0,0.1);">
              <div style="text-align:center;color:#65676b;padding:20px;">
                <div style="font-size:48px;margin-bottom:16px;">üíº</div>
                <div style="font-size:18px;font-weight:600;margin-bottom:8px;">No job posts created yet</div>
                <div style="font-size:14px;">Create job posts to find opportunities</div>
              </div>
            </div>
          </div>
        `;
        return;
      }
      
      jdSection.innerHTML = `
        <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border-radius:16px;box-shadow:0 8px 32px rgba(102, 126, 234, 0.3);padding:20px;margin-bottom:16px;">
          <h3 style="margin:0 0 20px 0;font-size:24px;color:#fff;text-align:center;font-weight:700;text-shadow:0 2px 4px rgba(0,0,0,0.3);">üíº Job Posts (${jdPosts.length})</h3>
          ${jdPosts.map((post, index) => {
            const jobTitle = post.caption ? post.caption.split('\n')[0].replace('üíº ', '') : 'Job Post';
            return `
              <div style="background:rgba(255,255,255,0.95);border-radius:12px;padding:20px;margin-bottom:16px;box-shadow:0 4px 16px rgba(0,0,0,0.1);">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                  <div style="font-size:32px;">üíº</div>
                  <div style="flex:1;">
                    <div style="font-weight:600;color:#1c1e21;font-size:16px;">${jobTitle}</div>
                    <div style="font-size:13px;color:#65676b;">${timeAgo(post.time)}</div>
                  </div>
                </div>
                <div style="margin-bottom:12px;">
                  <div style="font-size:14px;color:#1c1e21;line-height:1.5;">${post.caption ? post.caption.replace('üíº ' + jobTitle, '').trim() : 'No description available'}</div>
                </div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;">
                  ${post.category ? `<span style="background:#1877f2;color:#fff;padding:4px 8px;border-radius:12px;font-size:12px;">${post.category}</span>` : ''}
                  ${post.tags ? post.tags.split(',').map(tag => `<span style="background:#f0f2f5;color:#65676b;padding:4px 8px;border-radius:12px;font-size:12px;">${tag.trim()}</span>`).join('') : ''}
                </div>
                <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
                  <button onclick="downloadJDFile('${post.url}', '${jobTitle}', ${post.price || 0}, '${post.name || post.user}')" style="background:#1877f2;color:#fff;border:none;padding:8px 16px;border-radius:6px;font-size:14px;cursor:pointer;">Download</button>
                  <div style="flex:1;text-align:center;">
                    ${post.salary ? `<span style='color:#e53935;font-weight:700;font-size:18px;'>${post.salary}</span>` : ''}
                  </div>
                  <button onclick="viewJDFile('${post.url}', '${jobTitle}')" style="background:#43a047;color:#fff;border:none;padding:8px 16px;border-radius:6px;font-size:14px;cursor:pointer;">View</button>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }
    
    // Deposit and Withdraw Functions
    let selectedPaymentMethod = 'bkash';
    let selectedDepositChannel = 'jp';
    let selectedAmountValue = 0;
    
    function openDepositModal() {
      console.log('Deposit button clicked!');
      document.getElementById('depositModal').style.display = 'block';
      
      // Show first tab content
      document.getElementById('depositTabContent1').style.display = 'block';
      document.getElementById('depositTabContent2').style.display = 'none';
      document.getElementById('depositTabContent3').style.display = 'none';
      
      // Activate first tab
      document.getElementById('depositTab1').style.background = '#1877f2';
      document.getElementById('depositTab1').style.color = '#fff';
      document.getElementById('depositTab2').style.background = '#e4e6ea';
      document.getElementById('depositTab2').style.color = '#65676b';
      document.getElementById('depositTab3').style.background = '#e4e6ea';
      document.getElementById('depositTab3').style.color = '#65676b';
      
      // Initialize with default selections
      setTimeout(() => {
        initializeOldDepositModal();
      }, 100);
    }
    
    function openSimpleDepositModal() {
      // Create a multi-tab modal like the screenshots
      const modal = document.createElement('div');
      modal.id = 'simpleDepositModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
      `;
      
      modal.innerHTML = `
        <div style="
          background: white;
          border-radius: 16px;
          width: 95%;
          max-width: 500px;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3);
          overflow: hidden;
        ">
          <!-- Header -->
          <div style="
            background: linear-gradient(135deg, #1877f2 0%, #42a5f5 100%);
            padding: 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
          ">
            <h2 style="margin: 0; font-size: 20px; font-weight: 700;">üí∞ ‡¶°‡¶ø‡¶™‡ßã‡¶ú‡¶ø‡¶ü</h2>
            <button onclick="closeSimpleDepositModal()" style="
              background: none;
              border: none;
              color: white;
              font-size: 24px;
              cursor: pointer;
              padding: 0;
              width: 30px;
              height: 30px;
              display: flex;
              align-items: center;
              justify-content: center;
            ">‚úï</button>
          </div>
          
          <!-- Tab Navigation -->
          <div style="
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e4e6ea;
          ">
                         <button id="tab1" style="
               flex: 1;
               background: #1877f2;
               color: white;
               border: none;
               padding: 15px;
               font-size: 14px;
               font-weight: 600;
               cursor: pointer;
             ">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø</button>
             <button id="tab2" style="
               flex: 1;
               background: #e4e6ea;
               color: #65676b;
               border: none;
               padding: 15px;
               font-size: 14px;
               font-weight: 600;
               cursor: pointer;
             ">‡¶è‡¶Æ‡¶æ‡¶â‡¶®‡ßç‡¶ü</button>
             <button id="tab3" style="
               flex: 1;
               background: #e4e6ea;
               color: #65676b;
               border: none;
               padding: 15px;
               font-size: 14px;
               font-weight: 600;
               cursor: pointer;
             ">‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü</button>
          </div>
          
          <!-- Tab Content -->
          <div id="tabContent1" style="padding: 20px; display: block;">
            <!-- Promotion Selection -->

            
            <!-- Payment Methods -->
            <div style="margin-bottom: 20px;">
              <h3 style="color: #2c3e50; margin-bottom: 15px; font-size: 16px;">| ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø</h3>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                 <button id="payment-bkash" onclick="selectPaymentMethod('bkash')" class="payment-option" style="
                   border: 2px solid #e4e6ea;
                   background: white;
                   border-radius: 8px;
                   padding: 15px;
                   cursor: pointer;
                   font-weight: 600;
                   color: #65676b;
                   display: flex;
                   flex-direction: column;
                   align-items: center;
                   gap: 5px;
                   position: relative;
                 ">
                   <div style="font-size: 16px; color: #e2136e; font-weight: bold;">bKash</div>
                   <div>‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂</div>
                 </button>
                                 <button id="payment-nagad" onclick="selectPaymentMethod('nagad')" class="payment-option" style="
                   border: 2px solid #e4e6ea;
                   background: white;
                   border-radius: 8px;
                   padding: 15px;
                   cursor: pointer;
                   font-weight: 600;
                   color: #65676b;
                   display: flex;
                   flex-direction: column;
                   align-items: center;
                   gap: 5px;
                   position: relative;
                 ">
                   <div style="font-size: 16px; color: #ff6b35; font-weight: bold;">Nagad</div>
                   <div>‡¶®‡¶ó‡¶¶</div>
                 </button>
              </div>
            </div>
          </div>
          
          <div id="tabContent2" style="padding: 20px; display: none;">
            <!-- Deposit Channel -->
            <div style="margin-bottom: 25px;">
              <h3 style="color: #2c3e50; margin-bottom: 15px; font-size: 16px;">| ‡¶°‡¶ø‡¶™‡ßã‡¶ú‡¶ø‡¶ü ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</h3>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                 <button id="channel-cashout" onclick="selectCashout()" class="selected" style="
                   border: 3px solid #1877f2;
                   background: #1877f2;
                   border-radius: 8px;
                   padding: 12px;
                   cursor: pointer;
                   font-weight: 600;
                   color: #fff;
                   position: relative;
                   display: flex;
                   align-items: center;
                   gap: 8px;
                 ">
                   <span style="color: #fff;">üí∞</span>
                   <span>‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶â‡¶ü</span>
                   <span style="position: absolute; bottom: 2px; right: 2px; font-size: 10px; color: #fff;">‚úì</span>
                 </button>
                                 <button id="channel-send" onclick="console.log('Send button clicked'); selectSendMoney(); console.log('selectSendMoney completed')" style="
                   border: 2px solid #e4e6ea;
                   background: white;
                   border-radius: 8px;
                   padding: 12px;
                   cursor: pointer;
                   font-weight: 600;
                   color: #65676b;
                   display: flex;
                   align-items: center;
                   gap: 8px;
                   position: relative;
                 ">
                   <span style="color: #1877f2;">üì§</span>
                   <span>‡¶∏‡ßá‡¶®‡ßç‡¶° ‡¶Æ‡¶æ‡¶®‡¶ø</span>
                 </button>
              </div>
            </div>
            
            <!-- Amount Section -->
            <div style="margin-bottom: 25px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="color: #2c3e50; font-size: 16px; margin: 0;">| ‡¶è‡¶Æ‡¶æ‡¶â‡¶®‡ßç‡¶ü</h3>
                <span style="color: #7f8c8d; font-size: 14px;">‡ß≥ 100.00 - ‡ß≥ 15,000.00</span>
              </div>
              
              <!-- Preset Amounts -->
              <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 15px;">
                 <button id="amount-100" onclick="selectAmount(100)" style="
                   border: 2px solid #e4e6ea;
                   background: white;
                   border-radius: 6px;
                   padding: 10px;
                   cursor: pointer;
                   font-weight: 600;
                   color: #65676b;
                   font-size: 14px;
                 ">100</button>
                 <button id="amount-120" onclick="selectAmount(120)" style="
                   border: 2px solid #e4e6ea;
                   background: white;
                   border-radius: 6px;
                   padding: 10px;
                   cursor: pointer;
                   font-weight: 600;
                   color: #65676b;
                   font-size: 14px;
                 ">120</button>
                 <button id="amount-150" onclick="selectAmount(150)" style="
                   border: 2px solid #e4e6ea;
                   background: white;
                   border-radius: 6px;
                   padding: 10px;
                   cursor: pointer;
                   font-weight: 600;
                   color: #65676b;
                   font-size: 14px;
                 ">150</button>
                 <button id="amount-200" onclick="selectAmount(200)" style="
                   border: 2px solid #e4e6ea;
                   background: white;
                   border-radius: 6px;
                   padding: 10px;
                   cursor: pointer;
                   font-weight: 600;
                   color: #65676b;
                   font-size: 14px;
                 ">200</button>
                 <button id="amount-250" onclick="selectAmount(250)" style="
                   border: 2px solid #e4e6ea;
                   background: white;
                   border-radius: 6px;
                   padding: 10px;
                   cursor: pointer;
                   font-weight: 600;
                   color: #65676b;
                   font-size: 14px;
                 ">250</button>
                 <button id="amount-300" onclick="selectAmount(300)" style="
                   border: 2px solid #e4e6ea;
                   background: white;
                   border-radius: 6px;
                   padding: 10px;
                   cursor: pointer;
                   font-weight: 600;
                   color: #65676b;
                   font-size: 14px;
                 ">300</button>
                 <button id="amount-350" onclick="selectAmount(350)" style="
                   border: 2px solid #e4e6ea;
                   background: white;
                   border-radius: 6px;
                   padding: 10px;
                   cursor: pointer;
                   font-weight: 600;
                   color: #65676b;
                   font-size: 14px;
                 ">350</button>
                 <button id="amount-400" onclick="selectAmount(400)" style="
                   border: 2px solid #e4e6ea;
                   background: white;
                   border-radius: 6px;
                   padding: 10px;
                   cursor: pointer;
                   font-weight: 600;
                   color: #65676b;
                   font-size: 14px;
                 ">400</button>
                 <button id="amount-500" onclick="selectAmount(500)" style="
                   border: 2px solid #e4e6ea;
                   background: white;
                   border-radius: 6px;
                   padding: 10px;
                   cursor: pointer;
                   font-weight: 600;
                   color: #65676b;
                   font-size: 14px;
                 ">500</button>
                 <button id="amount-1000" onclick="selectAmount(1000)" style="
                   border: 2px solid #e4e6ea;
                   background: white;
                   border-radius: 6px;
                   padding: 10px;
                   cursor: pointer;
                   font-weight: 600;
                   color: #65676b;
                   font-size: 14px;
                 ">1,000</button>
                 <button id="amount-15000" onclick="selectAmount(15000)" style="
                   border: 2px solid #e4e6ea;
                   background: white;
                   border-radius: 6px;
                   padding: 10px;
                   cursor: pointer;
                   font-weight: 600;
                   color: #65676b;
                   font-size: 14px;
                 ">15,000</button>
              </div>
              
              <!-- Custom Amount Input -->
              <div style="
                border: 2px solid #e4e6ea;
                border-radius: 8px;
                padding: 12px;
                display: flex;
                align-items: center;
                gap: 10px;
              ">
                <span style="font-size: 18px; font-weight: 600; color: #2c3e50;">‡ß≥</span>
                <input type="number" id="customAmount" placeholder="0.00" style="
                  flex: 1;
                  border: none;
                  outline: none;
                  font-size: 16px;
                  font-weight: 600;
                  color: #2c3e50;
                " min="100" max="15000">
              </div>
            </div>
          </div>
          
          <div id="tabContent3" style="padding: 20px; display: none;">
            <!-- Instructions -->
            <div style="
              background: #e3f2fd;
              border: 1px solid #2196f3;
              border-radius: 8px;
              padding: 15px;
              margin-bottom: 20px;
            ">
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                <div style="
                  width: 24px;
                  height: 24px;
                  background: #2196f3;
                  border-radius: 50%;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  color: white;
                  font-weight: bold;
                  font-size: 12px;
                ">i</div>
                <h3 style="margin: 0; color: #1976d2; font-size: 16px;">‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂‡¶®‡¶æ</h3>
              </div>
              <div style="color: #1565c0; font-size: 14px; line-height: 1.6;">
                <p><strong>‡ßß/</strong>‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶§‡¶•‡ßç‡¶Ø"-‡¶è‡¶∞ ‡¶Ö‡¶ß‡ßÄ‡¶®‡ßá ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡ß©‡¶ü‡¶ø ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
                <p><strong>‡ß®/</strong>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶°‡¶ø‡¶™‡ßã‡¶ú‡¶ø‡¶ü ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶∏‡¶´‡¶≤ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶â‡¶ü ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞, ‡¶è‡¶Æ‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶Ü‡¶á‡¶°‡¶ø ‡¶∏‡¶π ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶¶‡¶ø‡¶®‡•§</p>
                <p><strong>‡ß©/</strong>‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶ø‡¶™‡ßã‡¶ú‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá ‡¶∏‡¶¨‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶°‡¶ø‡¶™‡ßã‡¶ú‡¶ø‡¶ü ‡¶™‡ßá‡¶á‡¶ú‡ßá ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
                <p><strong>‡ß™/</strong>‡¶°‡¶ø‡¶™‡ßã‡¶ú‡¶ø‡¶ü ‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶Ø‡¶º ‡¶Ü‡¶™‡¶®‡¶ø ‡ß®‡¶ü‡¶ø ‡¶°‡¶ø‡¶™‡ßã‡¶ú‡¶ø‡¶ü ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ü‡ßç‡¶∞‡¶æ‡¶á ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶Æ‡ßÅ‡¶ñ‡ßÄ‡¶® ‡¶π‡¶≤‡ßá ‡¶≤‡¶æ‡¶á‡¶≠‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶§‡¶æ ‡¶®‡¶ø‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§</p>

              </div>
            </div>
            
            <!-- Transaction Summary -->
            <div style="
              background: #f8f9fa;
              border: 1px solid #e4e6ea;
              border-radius: 8px;
              padding: 15px;
              margin-bottom: 20px;
            ">
              <h3 style="margin: 0 0 15px 0; color: #2c3e50; font-size: 16px;">‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</h3>
              <div id="transactionSummary" style="color: #65676b; font-size: 14px; line-height: 1.6;">
                <p><strong>‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø:</strong> <span id="summary-payment">‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂</span></p>
                <p><strong>‡¶°‡¶ø‡¶™‡ßã‡¶ú‡¶ø‡¶ü ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤:</strong> <span id="summary-channel">JP-‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶â‡¶ü</span></p>
                <p><strong>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£:</strong> <span id="summary-amount">‡ß≥0.00</span></p>
              </div>
            </div>
          </div>
          
          <!-- Navigation Buttons -->
          <div style="
            padding: 20px;
            border-top: 1px solid #e4e6ea;
            display: flex;
            gap: 10px;
            justify-content: space-between;
          ">
                         <button id="prevBtn" style="
               background: #95a5a6;
               color: white;
               border: none;
               padding: 12px 20px;
               border-radius: 8px;
               font-size: 14px;
               font-weight: 600;
               cursor: pointer;
               display: none;
             ">‚Üê ‡¶Ü‡¶ó‡ßá</button>
             <button id="nextBtn" style="
               background: #1877f2;
               color: white;
               border: none;
               padding: 12px 20px;
               border-radius: 8px;
               font-size: 14px;
               font-weight: 600;
               cursor: pointer;
             ">‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‚Üí</button>
             <button id="submitBtn" style="
               background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
               color: white;
               border: none;
               padding: 12px 20px;
               border-radius: 8px;
               font-size: 14px;
               font-weight: 600;
               cursor: pointer;
               display: none;
             ">‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Initialize variables
      window.currentDepositTab = 1;
      window.selectedPaymentMethod = 'bkash';
      window.selectedDepositChannel = 'jp';
      window.selectedAmountValue = 0;
      
      // Set up custom amount input and add all event listeners
      setTimeout(() => {
        const customAmountInput = document.getElementById('customAmount');
        if (customAmountInput) {
          customAmountInput.addEventListener('input', function() {
            const amount = parseFloat(this.value) || 0;
            window.selectedAmountValue = amount;
            console.log('Custom amount input changed to:', amount);
            
            // Remove selection from all amount buttons when typing
            const amountButtons = [100, 120, 150, 200, 250, 300, 350, 400, 500, 1000, 15000];
            amountButtons.forEach(amt => {
              const btn = document.getElementById('amount-' + amt);
              if (btn) {
                btn.style.border = '2px solid #e4e6ea';
                btn.style.background = '#fff';
                btn.style.color = '#65676b';
              }
            });
            
            // Update transaction summary immediately
            updateTransactionSummary();
          });
          
          // Also update on blur and change events
          customAmountInput.addEventListener('blur', function() {
            const amount = parseFloat(this.value) || 0;
            window.selectedAmountValue = amount;
            updateTransactionSummary();
          });
          
          customAmountInput.addEventListener('change', function() {
            const amount = parseFloat(this.value) || 0;
            window.selectedAmountValue = amount;
            updateTransactionSummary();
          });
        }
        
        // Add all event listeners with longer delay
        setTimeout(() => {
          addDepositModalEventListeners();
          
          // Set default selections
          console.log('Setting default selections...');
          selectPaymentMethod('bkash');
          selectCashout(); // Use the new function
          console.log('Default selections set');
        }, 200);
      }, 100);
    }
    
    function closeSimpleDepositModal() {
      const modal = document.getElementById('simpleDepositModal');
      if (modal) {
        modal.remove();
      }
    }
    
    function showDepositTabContent(tabNumber) {
      // Hide all tab contents
      document.getElementById('tabContent1').style.display = 'none';
      document.getElementById('tabContent2').style.display = 'none';
      document.getElementById('tabContent3').style.display = 'none';
      
      // Reset all tab buttons
      document.getElementById('tab1').style.background = '#e4e6ea';
      document.getElementById('tab1').style.color = '#65676b';
      document.getElementById('tab2').style.background = '#e4e6ea';
      document.getElementById('tab2').style.color = '#65676b';
      document.getElementById('tab3').style.background = '#e4e6ea';
      document.getElementById('tab3').style.color = '#65676b';
      
      // Show selected tab content
      document.getElementById('tabContent' + tabNumber).style.display = 'block';
      
      // Activate selected tab button
      document.getElementById('tab' + tabNumber).style.background = '#1877f2';
      document.getElementById('tab' + tabNumber).style.color = '#fff';
      
      // Update navigation buttons
      updateDepositNavigation(tabNumber);
      
      window.currentDepositTab = tabNumber;
      
      // If switching to submit tab, update transaction summary with current values
      if (tabNumber === 3) {
        // Get current custom amount value
        const customAmountInput = document.getElementById('customAmount');
        if (customAmountInput && customAmountInput.value) {
          const amount = parseFloat(customAmountInput.value);
          if (!isNaN(amount) && amount > 0) {
            window.selectedAmountValue = amount;
            console.log('Updated selectedAmountValue to:', amount);
          }
        }
        updateTransactionSummary();
      }
    }
    
    function updateDepositNavigation(tabNumber) {
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const submitBtn = document.getElementById('submitBtn');
      
      if (tabNumber === 1) {
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'block';
        submitBtn.style.display = 'none';
      } else if (tabNumber === 2) {
        prevBtn.style.display = 'block';
        nextBtn.style.display = 'block';
        submitBtn.style.display = 'none';
      } else if (tabNumber === 3) {
        prevBtn.style.display = 'block';
        nextBtn.style.display = 'none';
        submitBtn.style.display = 'block';
      }
    }
    
    function nextDepositTab() {
      if (window.currentDepositTab < 3) {
        // If moving from tab 2 to tab 3, update amount from custom input
        if (window.currentDepositTab === 2) {
          const customAmountInput = document.getElementById('customAmount');
          if (customAmountInput && customAmountInput.value) {
            const amount = parseFloat(customAmountInput.value);
            if (!isNaN(amount) && amount > 0) {
              window.selectedAmountValue = amount;
              console.log('Updated selectedAmountValue from nextDepositTab:', amount);
            }
          }
        }
        showDepositTabContent(window.currentDepositTab + 1);
      }
    }
    
    function previousDepositTab() {
      if (window.currentDepositTab > 1) {
        showDepositTabContent(window.currentDepositTab - 1);
      }
    }
    

    

    
    function updateCustomAmount(value) {
      const amount = parseFloat(value);
      window.selectedAmountValue = amount;
      console.log('Custom amount set to:', amount);
      
      // ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶∏‡¶æ‡¶Æ‡¶æ‡¶∞‡¶ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
      updateTransactionSummary();
    }
    
    function selectAmount(amount) {
      console.log('selectAmount called with:', amount);
      window.selectedAmountValue = amount;
      
      // Remove selection from all amount buttons (both types)
      const amountButtons = [100, 120, 150, 200, 250, 300, 350, 400, 500, 1000, 15000];
      
      // Reset buttons with id="amount-X"
      amountButtons.forEach(amt => {
        const btn = document.getElementById('amount-' + amt);
        if (btn) {
          btn.style.border = '2px solid #e4e6ea';
          btn.style.background = '#fff';
          btn.style.color = '#65676b';
        }
      });
      
      // Reset buttons with class="amount-btn"
      document.querySelectorAll('.amount-btn').forEach(btn => {
        btn.style.border = '2px solid #e4e6ea';
        btn.style.background = '#fff';
        btn.style.color = '#2c3e50';
      });
      
      // Add selection to clicked button (both types)
      const selectedBtnById = document.getElementById('amount-' + amount);
      if (selectedBtnById) {
        selectedBtnById.style.border = '3px solid #1877f2';
        selectedBtnById.style.background = '#1877f2';
        selectedBtnById.style.color = '#fff';
      }
      
      // Add selection to clicked button with class
      if (event && event.target && event.target.classList.contains('amount-btn')) {
        event.target.style.border = '2px solid #1877f2';
        event.target.style.background = '#f0f8ff';
        event.target.style.color = '#1877f2';
      }
      
      // Update custom amount input (all instances)
      const customInputs = document.querySelectorAll('#customAmount');
      console.log('Found', customInputs.length, 'customAmount inputs');
      
      if (customInputs.length > 0) {
        customInputs.forEach((input, index) => {
          input.value = amount;
          console.log('Set input', index, 'to', amount);
        });
        console.log('Input values set to:', amount, 'for', customInputs.length, 'inputs');
      } else {
        console.log('customAmount input not found!');
        
        // Try alternative selectors
        const altInputs = document.querySelectorAll('input[type="number"]');
        console.log('Found', altInputs.length, 'number inputs');
        altInputs.forEach((input, index) => {
          console.log('Input', index, 'id:', input.id, 'placeholder:', input.placeholder);
        });
      }
      
      console.log('Amount selected:', amount);
      updateTransactionSummary();
    }
    
    function updateTransactionSummary() {
      const paymentNames = {
        'bkash': '‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂',
        'nagad': '‡¶®‡¶ó‡¶¶',
        'rocket': '‡¶∞‡¶ï‡ßá‡¶ü',
        'upay': 'UPay',
        'bank': '‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï',
        'usdt': 'USDT'
      };
      
      const channelNames = {
        'jp': 'JP-‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶â‡¶ü',
        'ap': 'AP-‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶â‡¶ü',
        'ct': 'CT-‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶â‡¶ü',
        'sp': 'SP-‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶â‡¶ü',
        'send': '‡¶∏‡ßá‡¶®‡ßç‡¶° ‡¶Æ‡¶æ‡¶®‡¶ø',
        'payment': '‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü',
        'cashout': '‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶â‡¶ü'
      };
      
      // Get the correct channel name based on selection
      let channelDisplayName = channelNames[window.selectedDepositChannel] || '‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶â‡¶ü';
      if (window.selectedDepositChannel === 'send') {
        channelDisplayName = '‡¶∏‡ßá‡¶®‡ßç‡¶° ‡¶Æ‡¶æ‡¶®‡¶ø';
      } else if (window.selectedDepositChannel === 'cashout') {
        channelDisplayName = '‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶â‡¶ü';
      }
      
      // Get the current amount from custom input if available
      const customAmountInput = document.getElementById('customAmount');
      if (customAmountInput && customAmountInput.value) {
        const customAmount = parseFloat(customAmountInput.value);
        if (!isNaN(customAmount) && customAmount > 0) {
          window.selectedAmountValue = customAmount;
          console.log('Updated selectedAmountValue from custom input:', customAmount);
        }
      }
      
      // Update simple modal summary
      const summaryPayment = document.getElementById('summary-payment');
      const summaryChannel = document.getElementById('summary-channel');
      const summaryAmount = document.getElementById('summary-amount');
      
      if (summaryPayment) {
        summaryPayment.textContent = paymentNames[window.selectedPaymentMethod] || '‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂';
      }
      if (summaryChannel) {
        summaryChannel.textContent = channelDisplayName;
      }
      if (summaryAmount) {
        summaryAmount.textContent = '‡ß≥' + (window.selectedAmountValue || 0).toLocaleString();
      }
      
      // Update old modal summary
      const selectedPaymentMethodElement = document.getElementById('selectedPaymentMethod');
      const selectedDepositChannelElement = document.getElementById('selectedDepositChannel');
      const selectedAmountElement = document.getElementById('selectedAmount');
      
      if (selectedPaymentMethodElement) {
        selectedPaymentMethodElement.textContent = paymentNames[window.selectedPaymentMethod] || window.selectedPaymentMethod;
      }
      if (selectedDepositChannelElement) {
        selectedDepositChannelElement.textContent = channelDisplayName;
      }
      if (selectedAmountElement) {
        // ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø selectedAmountValue ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
        const amountToShow = window.selectedAmountValue || 0;
        selectedAmountElement.textContent = `‡ß≥${amountToShow.toLocaleString()}`;
        console.log('Amount shown in summary:', amountToShow);
      }
      
      // Force update all amount displays
      console.log('Final selectedAmountValue:', window.selectedAmountValue);
    }
    
    function submitDepositFinal() {
      // Get the current amount from custom input before submitting
      const customAmountInput = document.getElementById('customAmount');
      if (customAmountInput && customAmountInput.value) {
        const customAmount = parseFloat(customAmountInput.value);
        if (!isNaN(customAmount) && customAmount > 0) {
          window.selectedAmountValue = customAmount;
          console.log('Updated selectedAmountValue before submit:', customAmount);
        }
      }
      
      if (window.selectedAmountValue < 100 || window.selectedAmountValue > 15000) {
        alert('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡ß≥100 ‡¶•‡ßá‡¶ï‡ßá ‡ß≥15,000 ‡¶è‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶¨‡ßà‡¶ß ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®');
        return;
      }
      
      // Show payment details modal
      showPaymentDetailsModal();
    }
    
    function showPaymentDetailsModal() {
      // Close the current deposit modal
      closeSimpleDepositModal();
      
      // Create payment details modal
      const modal = document.createElement('div');
      modal.id = 'paymentDetailsModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
      `;
      
      // Set modal title based on selected channel
      const modalTitle = window.selectedDepositChannel === 'send' ? 'üì§ ‡¶∏‡ßá‡¶®‡ßç‡¶° ‡¶Æ‡¶æ‡¶®‡¶ø' : 'üí≥ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶â‡¶ü';
      
      modal.innerHTML = `
        <div style="
          background: white;
          border-radius: 16px;
          width: 95%;
          max-width: 500px;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3);
          overflow: hidden;
        ">
          <!-- Header -->
          <div style="
            background: linear-gradient(135deg, #e2136e 0%, #ff6b35 100%);
            padding: 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
          ">
            <h2 style="margin: 0; font-size: 20px; font-weight: 700;" id="modalTitle">${modalTitle}</h2>
            <button onclick="closePaymentDetailsModal()" style="
              background: none;
              border: none;
              color: white;
              font-size: 24px;
              cursor: pointer;
              padding: 0;
              width: 30px;
              height: 30px;
              display: flex;
              align-items: center;
              justify-content: center;
            ">‚úï</button>
          </div>
          
          <!-- Content -->
          <div style="padding: 20px;">
            <!-- Brand Logo -->
            <div style="text-align: center; margin-bottom: 20px;">
              <div style="
                display: inline-flex;
                align-items: center;
                gap: 10px;
                background: linear-gradient(135deg, #1877f2 0%, #42a5f5 100%);
                color: white;
                padding: 10px 20px;
                border-radius: 25px;
                font-weight: bold;
                font-size: 18px;
              ">
                <span style="font-size: 24px;">üí∞</span>
                <span>JUSTPAY</span>
              </div>
            </div>
            
            <!-- Time Limit -->
            <div style="
              background: #fff3cd;
              border: 1px solid #ffeaa7;
              border-radius: 8px;
              padding: 10px;
              text-align: center;
              margin-bottom: 20px;
              color: #856404;
              font-weight: 600;
            ">
              ‚è∞ ‡¶∏‡¶Æ‡¶Ø‡¶º‡¶∏‡ßÄ‡¶Æ‡¶æ: <span id="timerDisplay">15:00</span>
            </div>
            
            <!-- Deposit Amount -->
            <div style="margin-bottom: 20px;">
              <label style="
                display: block;
                font-weight: 600;
                color: #2c3e50;
                margin-bottom: 8px;
                font-size: 14px;
              ">‡¶°‡¶ø‡¶™‡ßã‡¶ú‡¶ø‡¶ü ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£:</label>
              <div style="
                display: flex;
                align-items: center;
                gap: 10px;
                background: #f8f9fa;
                border: 2px solid #e4e6ea;
                border-radius: 8px;
                padding: 12px;
              ">
                <input type="text" id="depositAmountDisplay" value="‡ß≥ ${window.selectedAmountValue || 0}" readonly style="
                  flex: 1;
                  border: none;
                  background: transparent;
                  font-size: 16px;
                  font-weight: 600;
                  color: #2c3e50;
                  outline: none;
                ">
                <button onclick="copyToClipboard('depositAmountDisplay')" style="
                  background: #1877f2;
                  color: white;
                  border: none;
                  padding: 8px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 14px;
                ">üìã</button>
              </div>
            </div>
            
            <!-- Payment Number -->
            <div style="margin-bottom: 20px;">
              <label style="
                display: block;
                font-weight: 600;
                color: #2c3e50;
                margin-bottom: 8px;
                font-size: 14px;
              ">${window.selectedPaymentMethod === 'bkash' ? '‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂' : '‡¶®‡¶ó‡¶¶'} ‡¶è‡¶ú‡ßá‡¶®‡ßç‡¶ü ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞:</label>
              <div style="
                display: flex;
                align-items: center;
                gap: 10px;
                background: #f8f9fa;
                border: 2px solid #e4e6ea;
                border-radius: 8px;
                padding: 12px;
              ">
                <input type="text" id="paymentNumber" value="01788458049" readonly style="
                  flex: 1;
                  border: none;
                  background: transparent;
                  font-size: 16px;
                  font-weight: 600;
                  color: #2c3e50;
                  outline: none;
                ">
                <button onclick="copyToClipboard('paymentNumber')" style="
                  background: #1877f2;
                  color: white;
                  border: none;
                  padding: 8px;
                  border-radius: 6px;
                  cursor: pointer;
                  font-size: 14px;
                ">üìã</button>
              </div>
              <div style="
                margin-top: 8px;
                font-size: 12px;
                color: #7f8c8d;
                display: flex;
                align-items: center;
                gap: 5px;
              ">
                <span>‡¶®‡ßã‡¶ü: ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶è‡¶ú‡ßá‡¶®‡ßç‡¶ü ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞‡¶ü‡¶ø ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</span>
                <button onclick="copyToClipboard('paymentNumber')" style="
                  background: none;
                  border: none;
                  color: #1877f2;
                  cursor: pointer;
                  font-size: 12px;
                ">üìã</button>
              </div>
            </div>
            

            
            <!-- Screenshot Upload -->
            <div style="margin-bottom: 20px;">
              <label style="
                display: block;
                font-weight: 600;
                color: #2c3e50;
                margin-bottom: 8px;
                font-size: 14px;
              ">‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡¶∂‡¶ü ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®:</label>
              <div class="screenshot-upload-area" style="
                border: 2px dashed #e4e6ea;
                border-radius: 8px;
                padding: 20px;
                text-align: center;
                background: #f8f9fa;
                cursor: pointer;
              " onclick="document.getElementById('screenshotInput').click()">
                <div style="font-size: 24px; margin-bottom: 8px;">üì∏</div>
                <div style="font-size: 14px; color: #65676b; margin-bottom: 4px;">‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡¶∂‡¶ü ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®</div>
                <div style="font-size: 12px; color: #7f8c8d;">PNG, JPG, JPEG (‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö 5MB)</div>
                <input type="file" id="screenshotInput" accept="image/*" style="display: none;" onchange="handleScreenshotUpload(event)">
              </div>
              <div id="screenshotPreview" style="display: none; margin-top: 10px;">
                <img id="screenshotImage" style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 2px solid #e4e6ea;">
                <button onclick="removeScreenshot()" style="
                  background: #e74c3c;
                  color: white;
                  border: none;
                  padding: 6px 12px;
                  border-radius: 6px;
                  font-size: 12px;
                  cursor: pointer;
                  margin-top: 8px;
                ">‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡¶∂‡¶ü ‡¶∏‡¶∞‡¶æ‡¶®</button>
              </div>
            </div>
            
            <!-- Transaction ID -->
            <div style="margin-bottom: 25px;">
              <label for="transactionId" style="
                display: block;
                font-weight: 600;
                color: #2c3e50;
                margin-bottom: 8px;
                font-size: 14px;
              ">‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶Ü‡¶á‡¶°‡¶ø:</label>
              <input type="text" id="transactionId" placeholder="‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¶‡¶ø‡¶®" style="
                width: 100%;
                padding: 12px;
                border: 2px solid #e4e6ea;
                border-radius: 8px;
                font-size: 14px;
                outline: none;
                box-sizing: border-box;
              ">
            </div>
            
            <!-- Submit Button -->
            <button onclick="submitPaymentDetails()" style="
              width: 100%;
              background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
              color: white;
              border: none;
              padding: 15px;
              border-radius: 8px;
              font-size: 16px;
              font-weight: 600;
              cursor: pointer;
              margin-bottom: 15px;
            ">‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            
            <!-- Instructions -->
            <div style="
              background: #e3f2fd;
              border: 1px solid #2196f3;
              border-radius: 8px;
              padding: 12px;
              font-size: 12px;
              color: #1565c0;
              line-height: 1.4;
            ">
              ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶è‡¶ú‡ßá‡¶®‡ßç‡¶ü ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡ßá ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶†‡¶ø‡¶ï ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§ ‡¶≠‡ßÅ‡¶≤ ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¶‡¶ø‡¶≤‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶°‡¶ø‡¶™‡ßã‡¶ú‡¶ø‡¶ü ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶¨‡¶ø‡¶≤‡¶Æ‡ßç‡¶¨‡¶ø‡¶§ ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Start timer
      startTimer();
      
      // Update transaction ID label and placeholder based on payment method
      updateTransactionIdField();
    }
    
    // Function to update transaction ID field based on payment method
    function updateTransactionIdField() {
      const transactionIdLabel = document.querySelector('label[for="transactionId"]');
      const transactionIdInput = document.getElementById('transactionId');
      
      if (transactionIdLabel && transactionIdInput) {
        const paymentMethod = window.selectedPaymentMethod;
        let labelText = '';
        let placeholderText = '';
        
        switch(paymentMethod) {
          case 'bkash':
            labelText = '‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂ ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶Ü‡¶á‡¶°‡¶ø:';
            placeholderText = '‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂ ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¶‡¶ø‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: TXN123456789)';
            break;
          case 'nagad':
            labelText = '‡¶®‡¶ó‡¶¶ ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶Ü‡¶á‡¶°‡¶ø:';
            placeholderText = '‡¶®‡¶ó‡¶¶ ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¶‡¶ø‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: TXN987654321)';
            break;
          case 'rocket':
            labelText = '‡¶∞‡¶ï‡ßá‡¶ü ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶Ü‡¶á‡¶°‡¶ø:';
            placeholderText = '‡¶∞‡¶ï‡ßá‡¶ü ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¶‡¶ø‡¶®';
            break;
          case 'upay':
            labelText = 'UPay ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶Ü‡¶á‡¶°‡¶ø:';
            placeholderText = 'UPay ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¶‡¶ø‡¶®';
            break;
          default:
            labelText = '‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶Ü‡¶á‡¶°‡¶ø:';
            placeholderText = '‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¶‡¶ø‡¶®';
        }
        
        transactionIdLabel.textContent = labelText;
        transactionIdInput.placeholder = placeholderText;
      }
    }
    
    // Timer function
    function startTimer() {
      let minutes = 15;
      let seconds = 0;
      
      const timerDisplay = document.getElementById('timerDisplay');
      if (!timerDisplay) return;
      
      // Clear any existing timer
      if (window.paymentTimer) {
        clearInterval(window.paymentTimer);
      }
      
      window.paymentTimer = setInterval(() => {
        if (seconds === 0) {
          if (minutes === 0) {
            clearInterval(window.paymentTimer);
            timerDisplay.textContent = '00:00';
            alert('‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶∂‡ßá‡¶∑ ‡¶π‡¶Ø‡¶º‡ßá ‡¶ó‡ßá‡¶õ‡ßá! ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
            closePaymentDetailsModal();
            return;
          }
          minutes--;
          seconds = 59;
        } else {
          seconds--;
        }
        
        const displayMinutes = minutes.toString().padStart(2, '0');
        const displaySeconds = seconds.toString().padStart(2, '0');
        timerDisplay.textContent = `${displayMinutes}:${displaySeconds}`;
      }, 1000);
    }
    
    // Screenshot upload functions
    function handleScreenshotUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // Check file size (5MB limit)
      if (file.size > 5 * 1024 * 1024) {
        alert('‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡¶æ‡¶á‡¶ú 5MB ‡¶è‡¶∞ ‡¶¨‡ßá‡¶∂‡¶ø ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá ‡¶®‡¶æ!');
        return;
      }
      
      // Check file type
      if (!file.type.startsWith('image/')) {
        alert('‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶á‡¶Æ‡ßá‡¶ú ‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá!');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const preview = document.getElementById('screenshotPreview');
        const image = document.getElementById('screenshotImage');
        
        image.src = e.target.result;
        preview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    }
    
    function removeScreenshot() {
      const preview = document.getElementById('screenshotPreview');
      const input = document.getElementById('screenshotInput');
      
      preview.style.display = 'none';
      input.value = '';
    }
    

    
    // Debug function to check current selections
    function debugSelections() {
      console.log('Current Payment Method:', window.selectedPaymentMethod);
      console.log('Current Deposit Channel:', window.selectedDepositChannel);
      console.log('Current Amount:', window.selectedAmountValue);
    }
    
    function closePaymentDetailsModal() {
      const modal = document.getElementById('paymentDetailsModal');
      if (modal) {
        modal.remove();
      }
      
      // Clear any existing timers
      if (window.paymentTimer) {
        clearInterval(window.paymentTimer);
        window.paymentTimer = null;
      }
    }
    
    function copyToClipboard(elementId) {
      const element = document.getElementById(elementId);
      if (element) {
        element.select();
        element.setSelectionRange(0, 99999); // For mobile devices
        document.execCommand('copy');
        
        // Show feedback
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = '‚úì';
        button.style.background = '#27ae60';
        
        setTimeout(() => {
          button.textContent = originalText;
          button.style.background = '#1877f2';
        }, 1000);
      }
    }
    
    function submitPaymentDetails() {
      const transactionId = document.getElementById('transactionId').value.trim();
      const screenshotInput = document.getElementById('screenshotInput');
      
      if (!transactionId) {
        alert('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶Ü‡¶á‡¶°‡¶ø ‡¶¶‡¶ø‡¶®');
        return;
      }
      
      // Basic validation for transaction ID format
      if (transactionId.length < 5) {
        alert('‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶Ü‡¶á‡¶°‡¶ø ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá ‡ß´ ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞‡ßá‡¶∞ ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá');
        return;
      }
      
      // Check if screenshot is uploaded (optional but recommended)
      if (!screenshotInput.files[0]) {
        const confirmSubmit = confirm('‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡¶∂‡¶ü ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?');
        if (!confirmSubmit) {
          return;
        }
      }
      
      // Process screenshot if uploaded
      let screenshotData = null;
      if (screenshotInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          // Compress the image before sending
          compressImage(e.target.result, 0.5, function(compressedData) {
            screenshotData = compressedData;
            submitDepositRequest(transactionId, screenshotData);
          });
        };
        reader.readAsDataURL(screenshotInput.files[0]);
      } else {
        submitDepositRequest(transactionId, null);
      }
    }
    
    // Compress image function
    function compressImage(base64String, quality, callback) {
      const img = new Image();
      img.onload = function() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // Set canvas size (reduce size for compression)
        const maxWidth = 800;
        const maxHeight = 600;
        let width = img.width;
        let height = img.height;
        
        if (width > height) {
          if (width > maxWidth) {
            height = Math.round((height * maxWidth) / width);
            width = maxWidth;
          }
        } else {
          if (height > maxHeight) {
            width = Math.round((width * maxHeight) / height);
            height = maxHeight;
          }
        }
        
        canvas.width = width;
        canvas.height = height;
        
        // Draw and compress
        ctx.drawImage(img, 0, 0, width, height);
        const compressedData = canvas.toDataURL('image/jpeg', quality);
        callback(compressedData);
      };
      img.src = base64String;
    }
    
    // Submit deposit request to admin panel
    async function submitDepositRequest(transactionId, screenshotData) {
      const currentUser = getCurrentUserName();
      const currentUserPhone = getCurrentUserPhone(); // Get user's phone number
      const currentUserProfileImage = localStorage.getItem('profileImage') || 'default-profile.png'; // Get user's profile image
      
      const depositRequest = {
        id: Date.now(),
        type: 'deposit',
        userName: currentUser,
        phone: currentUserPhone,
        profileImage: currentUserProfileImage, // Include profile image URL
        amount: window.selectedAmountValue,
        method: window.selectedPaymentMethod,
        channel: window.selectedDepositChannel,
        transactionId: transactionId,
        screenshot: screenshotData,
        status: 'pending',
        timestamp: new Date().toISOString()
      };
      
      // Save to localStorage
      const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
      transactions.push(depositRequest);
      localStorage.setItem('transactions', JSON.stringify(transactions));
      
      // Upload to server
      try {
        console.log('Submitting deposit request to server:', depositRequest);
        const response = await fetch('https://my-fb-server-2.onrender.com/submit-deposit', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(depositRequest)
        });
        
        if (response.ok) {
          const result = await response.json();
          console.log('Deposit request submitted successfully:', result);
        } else {
          const errorText = await response.text();
          console.error('Failed to submit deposit request:', response.status, errorText);
        }
      } catch (error) {
        console.error('Error submitting deposit request:', error);
      }
      
      // Show success message
      const paymentNames = {
        'bkash': '‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂',
        'nagad': '‡¶®‡¶ó‡¶¶',
        'rocket': '‡¶∞‡¶ï‡ßá‡¶ü',
        'upay': 'UPay'
      };
      
      const channelNames = {
        'cashout': '‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶â‡¶ü',
        'send': '‡¶∏‡ßá‡¶®‡ßç‡¶° ‡¶Æ‡¶æ‡¶®‡¶ø'
      };
      
      const channelDisplayName = window.selectedDepositChannel === 'send' ? '‡¶∏‡ßá‡¶®‡ßç‡¶° ‡¶Æ‡¶æ‡¶®‡¶ø' : '‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶â‡¶ü';
      
      const message = `‡¶°‡¶ø‡¶™‡ßã‡¶ú‡¶ø‡¶ü ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶ú‡¶Æ‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!\n\n‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø: ${paymentNames[window.selectedPaymentMethod]}\n‡¶°‡¶ø‡¶™‡ßã‡¶ú‡¶ø‡¶ü ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤: ${channelDisplayName}\n‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£: ‡ß≥${window.selectedAmountValue.toLocaleString()}\n${paymentNames[window.selectedPaymentMethod]} ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶Ü‡¶á‡¶°‡¶ø: ${transactionId}\n‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡¶∂‡¶ü: ${screenshotData ? '‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá' : '‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡¶®‡¶ø'}\n\n‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‡¶¶‡ßç‡¶¨‡¶æ‡¶∞‡¶æ ‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá‡•§`;
      
      alert(message);
      closePaymentDetailsModal();
    }
      
      const paymentNames = {
        'bkash': '‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂',
        'nagad': '‡¶®‡¶ó‡¶¶',
        'rocket': '‡¶∞‡¶ï‡ßá‡¶ü',
        'upay': 'UPay',
        'bank': '‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï',
        'usdt': 'USDT'
      };
      
      const channelNames = {
        'jp': 'JP-‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶â‡¶ü',
        'ap': 'AP-‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶â‡¶ü',
        'ct': 'CT-‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶â‡¶ü',
        'sp': 'SP-‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶â‡¶ü',
        'cashout': '‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶â‡¶ü',
        'send': '‡¶∏‡ßá‡¶®‡ßç‡¶° ‡¶Æ‡¶æ‡¶®‡¶ø',
        'payment': '‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü'
      };
      

    
    // Add event listeners after modal is created
    function addDepositModalEventListeners() {
      console.log('Adding event listeners...');
      
      // Add click event listeners for all payment method buttons
      const paymentMethods = ['bkash', 'nagad', 'rocket', 'upay', 'bank', 'usdt'];
      paymentMethods.forEach(method => {
        const btn = document.getElementById('payment-' + method);
        if (btn) {
          console.log('Adding listener for payment method:', method);
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Payment method clicked:', method);
            selectPaymentMethod(method);
          });
        } else {
          console.log('Button not found for payment method:', method);
        }
      });
      
      // Add click event listeners for all deposit channel buttons
      const channels = ['jp', 'ap', 'ct', 'sp', 'send', 'payment', 'cashout'];
      channels.forEach(channel => {
        const btn = document.getElementById('channel-' + channel);
        if (btn) {
          console.log('Adding listener for channel:', channel);
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Channel clicked:', channel);
            selectDepositChannel(channel);
          });
        } else {
          console.log('Button not found for channel:', channel);
        }
      });
      
      // Add click event listeners for all amount buttons
      const amounts = [100, 120, 150, 200, 250, 300, 350, 400, 500, 1000, 15000];
      amounts.forEach(amount => {
        const btn = document.getElementById('amount-' + amount);
        if (btn) {
          console.log('Adding listener for amount:', amount);
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Amount clicked:', amount);
            selectAmount(amount);
          });
        } else {
          console.log('Button not found for amount:', amount);
        }
      });
      
      // Add click event listeners for tab buttons
      const tabs = [1, 2, 3];
      tabs.forEach(tab => {
        const btn = document.getElementById('tab' + tab);
        if (btn) {
          console.log('Adding listener for tab:', tab);
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Tab clicked:', tab);
            showDepositTabContent(tab);
          });
        } else {
          console.log('Button not found for tab:', tab);
        }
      });
      
      // Add click event listeners for navigation buttons
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const submitBtn = document.getElementById('submitBtn');
      
      if (prevBtn) {
        prevBtn.addEventListener('click', function(e) {
          e.preventDefault();
          previousDepositTab();
        });
      }
      
      if (nextBtn) {
        nextBtn.addEventListener('click', function(e) {
          e.preventDefault();
          nextDepositTab();
        });
      }
      
      if (submitBtn) {
        submitBtn.addEventListener('click', function(e) {
          e.preventDefault();
          // Update transaction summary before submitting
          updateTransactionSummary();
          submitDepositFinal();
        });
      }
    }
    
    function showDepositTab(tabNumber) {
      // Hide all tab contents
      document.getElementById('depositTabContent1').style.display = 'none';
      document.getElementById('depositTabContent2').style.display = 'none';
      document.getElementById('depositTabContent3').style.display = 'none';
      
      // Remove active class from all tabs
      document.getElementById('depositTab1').style.background = '#e4e6ea';
      document.getElementById('depositTab1').style.color = '#65676b';
      document.getElementById('depositTab2').style.background = '#e4e6ea';
      document.getElementById('depositTab2').style.color = '#65676b';
      document.getElementById('depositTab3').style.background = '#e4e6ea';
      document.getElementById('depositTab3').style.color = '#65676b';
      
      // Show selected tab content and activate tab
      if (tabNumber === 1) {
        document.getElementById('depositTabContent1').style.display = 'block';
        document.getElementById('depositTab1').style.background = '#1877f2';
        document.getElementById('depositTab1').style.color = '#fff';
      } else if (tabNumber === 2) {
        document.getElementById('depositTabContent2').style.display = 'block';
        document.getElementById('depositTab2').style.background = '#1877f2';
        document.getElementById('depositTab2').style.color = '#fff';
      } else if (tabNumber === 3) {
        document.getElementById('depositTabContent3').style.display = 'block';
        document.getElementById('depositTab3').style.background = '#1877f2';
        document.getElementById('depositTab3').style.color = '#fff';
        
        // ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡ßÅ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        const customInput = document.getElementById('customAmount');
        console.log('Checking custom input:', customInput);
        if (customInput) {
          console.log('Custom input value:', customInput.value);
          if (customInput.value && parseFloat(customInput.value) > 0) {
            const amount = parseFloat(customInput.value);
            window.selectedAmountValue = amount;
            console.log('Updated selectedAmountValue to:', amount);
          }
        }
        
        updateTransactionSummary();
      }
    }
    
    // Initialize deposit modal with default selections
    function initializeDepositModal() {
      // Set default payment method
      selectPaymentMethod('bkash');
      
      // Set default deposit channel
      selectDepositChannel('jp');
      
      // Update transaction summary
      updateTransactionSummary();
    }
    
    // Initialize old deposit modal with default selections
    function initializeOldDepositModal() {
      // Set default payment method
      selectPaymentMethod('bkash');
      
      // Set default deposit channel
      selectDepositChannel('jp');
      
      // Update transaction summary
      updateTransactionSummary();
    }
    
    function selectPaymentMethod(method) {
      window.selectedPaymentMethod = method;

      // ‡¶∂‡ßÅ‡¶ß‡ßÅ simple modal-‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø (bkash, nagad)
      const paymentMethods = ['bkash', 'nagad'];
      paymentMethods.forEach(pm => {
        const btn = document.getElementById('payment-' + pm);
        if (btn) {
          btn.classList.remove('selected');
          btn.style.border = '2px solid #e4e6ea';
          btn.style.background = '#fff';
          btn.style.color = (pm === 'bkash') ? '#e2136e' : '#ff6b35';
          const divs = btn.querySelectorAll('div');
          if (divs[0]) divs[0].style.color = (pm === 'bkash') ? '#e2136e' : '#ff6b35';
          if (divs[1]) divs[1].style.color = '#65676b';
        }
      });

      // ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶° ‡¶¨‡¶æ‡¶ü‡¶® ‡¶¨‡ßç‡¶≤‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®
      const selectedBtn = document.getElementById('payment-' + method);
      if (selectedBtn) {
        selectedBtn.classList.add('selected');
        selectedBtn.style.border = '3px solid #1877f2';
        selectedBtn.style.background = '#1877f2';
        selectedBtn.style.color = '#fff';
        const divs = selectedBtn.querySelectorAll('div');
        if (divs[0]) divs[0].style.color = '#fff';
        if (divs[1]) divs[1].style.color = '#fff';
      }

      updateTransactionSummary();
      
      // Update transaction ID field if payment details modal is open
      if (document.getElementById('paymentDetailsModal')) {
        updateTransactionIdField();
      }
    }
    
    function selectCashout() {
      console.log('selectCashout called');
      
      // Reset send money button
      const sendBtn = document.getElementById('channel-send');
      if (sendBtn) {
        sendBtn.classList.remove('selected');
        sendBtn.style.border = '2px solid #e4e6ea';
        sendBtn.style.background = '#fff';
        sendBtn.style.color = '#65676b';
        
        // Reset send spans
        const sendSpans = sendBtn.querySelectorAll('span');
        sendSpans.forEach(span => {
          if (span.textContent === 'üì§') {
            span.style.color = '#1877f2';
          } else if (span.textContent === '‚úì') {
            span.remove();
          } else {
            span.style.color = '#65676b';
          }
        });
      }
      
      // Select cashout button
      const cashoutBtn = document.getElementById('channel-cashout');
      if (cashoutBtn) {
        cashoutBtn.classList.add('selected');
        cashoutBtn.style.border = '3px solid #1877f2';
        cashoutBtn.style.background = '#1877f2';
        cashoutBtn.style.color = '#fff';
        
        // Make all spans white
        const cashoutSpans = cashoutBtn.querySelectorAll('span');
        cashoutSpans.forEach(span => {
          if (span.textContent === 'üí∞') {
            span.style.color = '#fff';
          } else if (span.textContent !== '‚úì') {
            span.style.color = '#fff';
          }
        });
        
        // Add checkmark
        const checkmark = document.createElement('span');
        checkmark.style.cssText = 'position: absolute; bottom: 2px; right: 2px; font-size: 10px; color: #fff;';
        checkmark.textContent = '‚úì';
        cashoutBtn.appendChild(checkmark);
      }
      
      window.selectedDepositChannel = 'cashout';
      updateTransactionSummary();
      
      // Update transaction summary to show correct channel name
      const summaryChannel = document.getElementById('summary-channel');
      if (summaryChannel) {
        summaryChannel.textContent = '‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶â‡¶ü';
      }
    }
    
    function selectSendMoney() {
      console.log('selectSendMoney called');
      
      // Reset cashout button
      const cashoutBtn = document.getElementById('channel-cashout');
      if (cashoutBtn) {
        cashoutBtn.classList.remove('selected');
        cashoutBtn.style.border = '2px solid #e4e6ea';
        cashoutBtn.style.background = '#fff';
        cashoutBtn.style.color = '#65676b';
        
        // Reset cashout spans
        const cashoutSpans = cashoutBtn.querySelectorAll('span');
        cashoutSpans.forEach(span => {
          if (span.textContent === 'üí∞') {
            span.style.color = '#27ae60';
          } else if (span.textContent === '‚úì') {
            span.remove();
          } else {
            span.style.color = '#65676b';
          }
        });
      }
      
      // Select send money button
      const sendBtn = document.getElementById('channel-send');
      if (sendBtn) {
        sendBtn.classList.add('selected');
        sendBtn.style.border = '3px solid #1877f2';
        sendBtn.style.background = '#1877f2';
        sendBtn.style.color = '#fff';
        sendBtn.style.setProperty('background', '#1877f2', 'important');
        sendBtn.style.setProperty('border', '3px solid #1877f2', 'important');
        sendBtn.style.setProperty('color', '#fff', 'important');
        
        // Make all spans white
        const sendSpans = sendBtn.querySelectorAll('span');
        sendSpans.forEach(span => {
          if (span.textContent === 'üì§') {
            span.style.color = '#fff';
            span.style.setProperty('color', '#fff', 'important');
          } else if (span.textContent !== '‚úì') {
            span.style.color = '#fff';
            span.style.setProperty('color', '#fff', 'important');
          }
        });
        
        // Add checkmark
        const checkmark = document.createElement('span');
        checkmark.style.cssText = 'position: absolute; bottom: 2px; right: 2px; font-size: 10px; color: #fff;';
        checkmark.textContent = '‚úì';
        sendBtn.appendChild(checkmark);
      }
      
      window.selectedDepositChannel = 'send';
      updateTransactionSummary();
      
      // Update transaction summary to show correct channel name
      const summaryChannel = document.getElementById('summary-channel');
      if (summaryChannel) {
        summaryChannel.textContent = '‡¶∏‡ßá‡¶®‡ßç‡¶° ‡¶Æ‡¶æ‡¶®‡¶ø';
      }
    }
    
    function selectDepositChannel(channel) {
      console.log('selectDepositChannel called with:', channel);
      window.selectedDepositChannel = channel;
      
      console.log('Looking for buttons with channels:', ['cashout', 'send']);
      
      // ‡¶∂‡ßÅ‡¶ß‡ßÅ simple modal-‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø (cashout, send)
      const channels = ['cashout', 'send'];
      channels.forEach(ch => {
        const btn = document.getElementById('channel-' + ch);
        console.log('Found button for channel', ch, ':', btn);
        if (btn) {
          btn.classList.remove('selected');
          btn.style.border = '2px solid #e4e6ea';
          btn.style.background = '#fff';
          btn.style.color = '#65676b';
          
          // ‡¶∏‡¶¨ span ‡¶è‡¶∞ ‡¶ï‡¶æ‡¶≤‡¶æ‡¶∞ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü
          const spans = btn.querySelectorAll('span');
          spans.forEach(span => {
            if (span.textContent === 'üí∞') {
              span.style.color = '#27ae60';
            } else if (span.textContent === 'üì§') {
              span.style.color = '#1877f2';
            } else if (span.textContent === '‚úì') {
              span.remove();
            } else {
              span.style.color = '#65676b';
            }
          });
        }
      });
      
      // ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶° ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶¨‡¶æ‡¶ü‡¶® ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü
      const selectedBtn = document.getElementById('channel-' + channel);
      console.log('Selected button for channel', channel, ':', selectedBtn);
      if (selectedBtn) {
        console.log('Applying styles to selected button');
        selectedBtn.classList.add('selected');
        selectedBtn.style.border = '3px solid #1877f2';
        selectedBtn.style.background = '#1877f2';
        selectedBtn.style.color = '#fff';
        
        // ‡¶∏‡¶¨ span ‡¶è‡¶∞ ‡¶ï‡¶æ‡¶≤‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶¶‡¶æ ‡¶ï‡¶∞‡ßá ‡¶¶‡¶æ‡¶ì
        const spans = selectedBtn.querySelectorAll('span');
        spans.forEach(span => {
          if (span.textContent === 'üí∞' || span.textContent === 'üì§') {
            span.style.color = '#fff';
          } else if (span.textContent !== '‚úì') {
            span.style.color = '#fff';
          }
        });
        
        // ‡¶ü‡¶ø‡¶ï ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
        const checkmark = document.createElement('span');
        checkmark.style.cssText = 'position: absolute; bottom: 2px; right: 2px; font-size: 10px; color: #fff;';
        checkmark.textContent = '‚úì';
        selectedBtn.appendChild(checkmark);
        
        console.log(channel + ' ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!');
      }
      
      updateTransactionSummary();
    }
    

    
    function updateTransactionDetails() {
      const methodNames = {
        'bkash': '‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂',
        'nagad': '‡¶®‡¶ó‡¶¶',
        'rocket': '‡¶∞‡¶ï‡ßá‡¶ü',
        'upay': 'UPay',
        'bank': '‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï',
        'usdt_trc20': 'USDT TRC20'
      };
      
      const channelNames = {
        'jp': 'JP-‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶â‡¶ü',
        'ap': 'AP-‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶â‡¶ü',
        'ct': 'CT-‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶â‡¶ü',
        'sp': 'SP-‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶â‡¶ü',
        'send': '‡¶∏‡ßá‡¶®‡ßç‡¶° ‡¶Æ‡¶æ‡¶®‡¶ø',
        'payment': '‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü'
      };
      
      const selectedPaymentMethodElement = document.getElementById('selectedPaymentMethod');
      const selectedDepositChannelElement = document.getElementById('selectedDepositChannel');
      const selectedAmountElement = document.getElementById('selectedAmount');
      
      if (selectedPaymentMethodElement) {
        selectedPaymentMethodElement.textContent = methodNames[window.selectedPaymentMethod] || window.selectedPaymentMethod;
      }
      if (selectedDepositChannelElement) {
        selectedDepositChannelElement.textContent = channelNames[window.selectedDepositChannel] || '‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶â‡¶ü';
      }
      if (selectedAmountElement) {
        // ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø selectedAmountValue ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
        const amountToShow = window.selectedAmountValue || 0;
        selectedAmountElement.textContent = `‡ß≥${amountToShow.toLocaleString()}`;
        console.log('Amount shown in details:', amountToShow);
      }
    }
    
    function resetDepositSelections() {
      window.selectedPaymentMethod = 'bkash';
      window.selectedDepositChannel = 'jp';
      window.selectedAmountValue = 0;
      document.getElementById('customAmount').value = '';
      
      // Reset payment method selection
      selectPaymentMethod('bkash');
      
      // Reset deposit channel selection
      selectDepositChannel('jp');
      
      // Reset amount buttons
      document.querySelectorAll('.amount-btn').forEach(btn => {
        btn.style.border = '2px solid #e4e6ea';
        btn.style.background = '#fff';
        btn.style.color = '#2c3e50';
      });
      
      // Reset amount buttons with id
      const amountButtons = [100, 120, 150, 200, 250, 300, 350, 400, 500, 1000, 15000];
      amountButtons.forEach(amt => {
        const btn = document.getElementById('amount-' + amt);
        if (btn) {
          btn.style.border = '2px solid #e4e6ea';
          btn.style.background = '#fff';
          btn.style.color = '#65676b';
        }
      });
    }
    
    function closeDepositModal() {
      document.getElementById('depositModal').style.display = 'none';
    }
    
    // Global variables
    window.selectedWithdrawMethod = 'bkash';
    window.selectedWithdrawAmount = 0;

    // Open withdraw modal
    function openWithdrawModal() {
      // Force withdraw modal to work regardless of current tab
      const modal = document.getElementById('withdrawModal');
      
      if (modal) {
        // Ensure modal is completely independent of any tab
        modal.style.display = 'block';
        modal.style.zIndex = '9999999';
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100vw';
        modal.style.height = '100vh';
        modal.style.background = 'rgba(0,0,0,0.8)';
        
        // Force modal to be on top of everything
        document.body.appendChild(modal);
        
        // Show first tab
        showWithdrawTab(1);
        
        // Load user balance
        loadUserBalanceForWithdraw();
        
        console.log('Withdraw modal opened successfully - independent of any tab');
        
      } else {
        console.error('Withdraw modal not found!');
        alert('‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶Æ‡ßã‡¶°‡¶æ‡¶≤ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø!');
      }
    }

    // Close withdraw modal
    function closeWithdrawModal() {
      const modal = document.getElementById('withdrawModal');
      if (modal) {
        modal.style.display = 'none';
        modal.style.zIndex = '9999999';
      }
      
      document.getElementById('withdrawCustomAmount').value = '';
      document.getElementById('withdrawAccount').value = '';
      // Reset selections
      window.selectedWithdrawMethod = 'bkash';
      window.selectedWithdrawAmount = 0;
      resetWithdrawSelections();
    }
    
    async function processDeposit() {
      const amount = window.selectedAmountValue || parseFloat(document.getElementById('customAmount').value);
      const method = window.selectedPaymentMethod;
      const channel = window.selectedDepositChannel;
      
      if (!amount || amount < 100 || amount > 15000) {
        alert('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡ß≥100 ‡¶•‡ßá‡¶ï‡ßá ‡ß≥15,000 ‡¶è‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶¨‡ßà‡¶ß ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡¶æ‡¶®');
        return;
      }
      
      const currentUser = getCurrentUserName();
      const deposit = {
        id: Date.now(),
        type: 'deposit',
        amount: amount,
        method: method,
        channel: channel,
        status: 'pending',
        timestamp: new Date().toISOString(),
        userName: currentUser
      };
      
      // Add to local storage
      const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
      transactions.push(deposit);
      localStorage.setItem('transactions', JSON.stringify(transactions));
      
      // Upload to server
      try {
        const response = await fetch(`${BASE_URL}/upload-transaction`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(deposit)
        });
        
        if (response.ok) {
          console.log('Transaction uploaded successfully');
        }
      } catch (error) {
        console.error('Error uploading transaction:', error);
      }
      
      closeDepositModal();
      alert('‡¶°‡¶ø‡¶™‡ßã‡¶ú‡¶ø‡¶ü ‡¶Ö‡¶®‡ßÅ‡¶∞‡ßã‡¶ß ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶ú‡¶Æ‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! ‡¶è‡¶ü‡¶ø ‡ß®‡ß™ ‡¶ò‡¶®‡ßç‡¶ü‡¶æ‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá‡•§');
    }
    
    // Show withdraw tab
    function showWithdrawTab(tabNumber) {
      console.log('showWithdrawTab called with tabNumber:', tabNumber);
      
      // Hide all tab contents
      const tabContents = ['withdrawTabContent1', 'withdrawTabContent2', 'withdrawTabContent3'];
      tabContents.forEach(contentId => {
        const content = document.getElementById(contentId);
        if (content) {
          content.style.display = 'none';
        } else {
          console.error('Tab content not found:', contentId);
        }
      });
      
      // Reset all tab buttons
      const tabButtons = ['withdrawTab1', 'withdrawTab2', 'withdrawTab3'];
      tabButtons.forEach(btnId => {
        const btn = document.getElementById(btnId);
        if (btn) {
          btn.style.background = '#e4e6ea';
          btn.style.color = '#65676b';
        } else {
          console.error('Tab button not found:', btnId);
        }
      });
      
      // Show selected tab content
      const selectedContent = document.getElementById('withdrawTabContent' + tabNumber);
      if (selectedContent) {
        selectedContent.style.display = 'block';
        console.log('Showing tab content:', 'withdrawTabContent' + tabNumber);
      } else {
        console.error('Selected tab content not found:', 'withdrawTabContent' + tabNumber);
      }
      
      // Activate selected tab button
      const selectedButton = document.getElementById('withdrawTab' + tabNumber);
      if (selectedButton) {
        selectedButton.style.background = '#1877f2';
        selectedButton.style.color = '#fff';
        console.log('Activated tab button:', 'withdrawTab' + tabNumber);
      } else {
        console.error('Selected tab button not found:', 'withdrawTab' + tabNumber);
      }
      
      // If switching to submit tab, update summary
      if (tabNumber === 3) {
        updateWithdrawSummary();
      }
    }

    // Select withdraw method
    function selectWithdrawMethod(method) {
      window.selectedWithdrawMethod = method;
      
      // Reset all method buttons
      const methods = ['bkash', 'nagad', 'rocket', 'upay'];
      methods.forEach(m => {
        const btn = document.getElementById('withdraw-' + m);
        if (btn) {
          btn.style.border = '2px solid #e4e6ea';
          btn.style.background = '#fff';
        }
      });
      
      // Select clicked button
      const selectedBtn = document.getElementById('withdraw-' + method);
      if (selectedBtn) {
        selectedBtn.style.border = '3px solid #1877f2';
        selectedBtn.style.background = '#f0f8ff';
      }
    }

    // Select withdraw amount
    function selectWithdrawAmount(amount) {
      window.selectedWithdrawAmount = amount;
      
      // Reset all amount buttons
      const amounts = [100, 200, 500, 1000, 2000, 5000];
      amounts.forEach(a => {
        const btn = document.getElementById('withdraw-amount-' + a);
        if (btn) {
          btn.style.border = '2px solid #e4e6ea';
          btn.style.background = '#fff';
          btn.style.color = '#65676b';
        }
      });
      
      // Select clicked button
      const selectedBtn = document.getElementById('withdraw-amount-' + amount);
      if (selectedBtn) {
        selectedBtn.style.border = '3px solid #1877f2';
        selectedBtn.style.background = '#1877f2';
        selectedBtn.style.color = '#fff';
      }
      
      // Update custom amount input
      document.getElementById('withdrawCustomAmount').value = amount;
      
      // Update summary
      updateWithdrawSummary();
    }

    // Update withdraw summary
    function updateWithdrawSummary() {
      const amount = window.selectedWithdrawAmount || parseFloat(document.getElementById('withdrawCustomAmount').value) || 0;
      const method = window.selectedWithdrawMethod;
      
      const methodNames = {
        'bkash': '‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂',
        'nagad': '‡¶®‡¶ó‡¶¶',
        'rocket': '‡¶∞‡¶ï‡ßá‡¶ü',
        'upay': 'UPay'
      };
      
      const commission = amount * 0.02; // 2% commission
      const finalAmount = amount - commission;
      
      document.getElementById('withdrawSummaryMethod').textContent = methodNames[method] || method;
      document.getElementById('withdrawSummaryAmount').textContent = '‡ß≥' + amount.toLocaleString();
      document.getElementById('withdrawSummaryCommission').textContent = '-‡ß≥' + commission.toLocaleString();
      document.getElementById('withdrawSummaryFinal').textContent = '‡ß≥' + finalAmount.toLocaleString();
    }

    // Load user balance for withdraw
    async function loadUserBalanceForWithdraw() {
      try {
        const currentUser = getCurrentUserName();
        const response = await fetch(`https://my-fb-server-2.onrender.com/user/balance/${currentUser}`);
        
        if (response.ok) {
          const data = await response.json();
          const balance = data.balance || 0;
          
          // Update max amount display if exists
          const maxAmountElement = document.getElementById('maxWithdrawAmount');
          if (maxAmountElement) {
            maxAmountElement.textContent = '‡ß≥' + balance.toLocaleString();
          }
        }
      } catch (error) {
        console.error('Error loading balance for withdraw:', error);
      }
    }

    // Reset withdraw selections
    function resetWithdrawSelections() {
      // Reset method buttons
      const methods = ['bkash', 'nagad', 'rocket', 'upay'];
      methods.forEach(m => {
        const btn = document.getElementById('withdraw-' + m);
        if (btn) {
          btn.style.border = '2px solid #e4e6ea';
          btn.style.background = '#fff';
        }
      });
      
      // Reset amount buttons
      const amounts = [100, 200, 500, 1000, 2000, 5000];
      amounts.forEach(a => {
        const btn = document.getElementById('withdraw-amount-' + a);
        if (btn) {
          btn.style.border = '2px solid #e4e6ea';
          btn.style.background = '#fff';
          btn.style.color = '#65676b';
        }
      });
      
      // Select default method
      selectWithdrawMethod('bkash');
    }

    // Process withdraw
    async function processWithdraw() {
      const amount = window.selectedWithdrawAmount || parseFloat(document.getElementById('withdrawCustomAmount').value);
      const method = window.selectedWithdrawMethod;
      const account = document.getElementById('withdrawAccount').value;
      
      if (!amount || amount <= 0) {
        alert('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶¨‡ßà‡¶ß ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶Æ‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¶‡¶ø‡¶®');
        return;
      }
      
      if (!account.trim()) {
        alert('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶®');
        return;
      }
      
      // Validate mobile number format
      const mobileRegex = /^01[3-9]\d{8}$/;
      if (!mobileRegex.test(account)) {
        alert('‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶® (01XXXXXXXXX)');
        return;
      }
      
      // Check if user has sufficient balance
      try {
        const currentUser = getCurrentUserName();
        const response = await fetch(`https://my-fb-server-2.onrender.com/user/balance/${currentUser}`);
        
        if (response.ok) {
          const data = await response.json();
          const currentBalance = data.balance || 0;
          
          if (amount > currentBalance) {
            alert(`‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶Ö‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§‡•§ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: ‡ß≥${currentBalance.toLocaleString()}`);
            return;
          }
        }
      } catch (error) {
        console.error('Error checking balance:', error);
        alert('‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
        return;
      }
      
      const currentUser = getCurrentUserName();
      const commission = amount * 0.02; // 2% commission
      const finalAmount = amount - commission;
      
      const withdraw = {
        id: Date.now(),
        type: 'withdraw',
        amount: amount,
        method: method,
        account: account,
        commission: commission,
        finalAmount: finalAmount,
        status: 'pending',
        timestamp: new Date().toISOString(),
        userName: currentUser
      };
      
      // Add to local storage
      const transactions = JSON.parse(localStorage.getItem('transactions') || '[]');
      transactions.push(withdraw);
      localStorage.setItem('transactions', JSON.stringify(transactions));
      
      // Upload to server
      try {
        const response = await fetch(`${BASE_URL}/submit-withdraw`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(withdraw)
        });
        
        if (response.ok) {
          console.log('Withdraw request uploaded successfully');
        }
      } catch (error) {
        console.error('Error uploading withdraw request:', error);
      }
      
      // Update user balance
      try {
        const balanceResponse = await fetch(`https://my-fb-server-2.onrender.com/user/balance/${currentUser}/subtract`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ amount: amount })
        });
        
        if (balanceResponse.ok) {
          console.log('Balance updated successfully');
        }
      } catch (error) {
        console.error('Error updating balance:', error);
      }
      
      closeWithdrawModal();
      alert(`‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶∞‡¶ø‡¶ï‡ßã‡¶Ø‡¶º‡ßá‡¶∏‡ßç‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! ‡ß®‡ß™ ‡¶ò‡¶®‡ßç‡¶ü‡¶æ‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶¨‡ßá‡•§\n\n‡¶Ö‡ßç‡¶Ø‡¶æ‡¶Æ‡¶æ‡¶â‡¶®‡ßç‡¶ü: ‡ß≥${amount.toLocaleString()}\n‡¶ï‡¶Æ‡¶ø‡¶∂‡¶®: ‡ß≥${commission.toLocaleString()}\n‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶Æ‡¶æ‡¶â‡¶®‡ßç‡¶ü: ‡ß≥${finalAmount.toLocaleString()}`);
    }
    
    // Custom amount input event listener
    document.addEventListener('DOMContentLoaded', function() {
      // Withdraw custom amount listener
      const withdrawCustomAmountInput = document.getElementById('withdrawCustomAmount');
      if (withdrawCustomAmountInput) {
        withdrawCustomAmountInput.addEventListener('input', function() {
          if (this.value) {
            window.selectedWithdrawAmount = 0; // Reset preset amount
            // Reset all amount buttons
            ['100', '200', '500', '1000', '2000', '5000'].forEach(amt => {
              const button = document.getElementById('withdraw-amount-' + amt);
              if (button) {
                button.style.border = '2px solid #e4e6ea';
                button.style.background = '#fff';
                button.style.color = '#65676b';
              }
            });
            // Update summary when custom amount changes
            updateWithdrawSummary();
          }
        });
      }
      
      const customAmountInput = document.getElementById('customAmount');
      if (customAmountInput) {
        customAmountInput.addEventListener('input', function() {
          const amount = parseFloat(this.value) || 0;
          window.selectedAmountValue = amount;
          
          // Remove selection from all amount buttons when typing
          document.querySelectorAll('.amount-btn').forEach(btn => {
            btn.style.border = '2px solid #e4e6ea';
            btn.style.background = '#fff';
            btn.style.color = '#2c3e50';
          });
          
          // Update transaction summary
          updateTransactionSummary();
        });
        
        // Also update on blur and change events
        customAmountInput.addEventListener('blur', function() {
          const amount = parseFloat(this.value) || 0;
          window.selectedAmountValue = amount;
          updateTransactionSummary();
        });
        
        customAmountInput.addEventListener('change', function() {
          const amount = parseFloat(this.value) || 0;
          window.selectedAmountValue = amount;
          updateTransactionSummary();
        });
      }
    });
  </script>
  
  <!-- Deposit Modal -->
  <div id="depositModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:1000;backdrop-filter:blur(5px);">
    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border-radius:16px;padding:0;width:95%;max-width:450px;box-shadow:0 20px 60px rgba(0,0,0,0.3);overflow:hidden;">
      
      <!-- Header -->
      <div style="background:linear-gradient(135deg, #1877f2 0%, #42a5f5 100%);padding:20px;color:#fff;">
        <div style="display:flex;align-items:center;justify-content:space-between;">
          <h2 style="margin:0;font-size:20px;font-weight:700;">üí∞ ‡¶°‡¶ø‡¶™‡ßã‡¶ú‡¶ø‡¶ü</h2>
          <button onclick="closeDepositModal()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#fff;">√ó</button>
        </div>
      </div>
      
      <!-- Navigation Tabs -->
      <div style="display:flex;background:#f8f9fa;border-bottom:1px solid #e4e6ea;">
        <button id="depositTab1" onclick="showDepositTab(1)" style="flex:1;background:#1877f2;color:#fff;border:none;padding:15px;font-size:16px;font-weight:600;cursor:pointer;">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø</button>
        <button id="depositTab2" onclick="showDepositTab(2)" style="flex:1;background:#e4e6ea;color:#65676b;border:none;padding:15px;font-size:16px;font-weight:600;cursor:pointer;">‡¶è‡¶Æ‡¶æ‡¶â‡¶®‡ßç‡¶ü</button>
        <button id="depositTab3" onclick="showDepositTab(3)" style="flex:1;background:#e4e6ea;color:#65676b;border:none;padding:15px;font-size:16px;font-weight:600;cursor:pointer;">‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü</button>
      </div>
      
      <!-- Tab Content -->
      <div style="padding:20px;max-height:500px;overflow-y:auto;">
        
        <!-- Tab 1: Payment Method -->
        <div id="depositTabContent1" style="display:block;">
          <!-- Promotion Selection -->
          <div style="background:#fff3cd;border:1px solid #ffeaa7;border-radius:8px;padding:15px;margin-bottom:20px;">
            <div style="display:flex;align-items:center;justify-content:space-between;">
              <div style="display:flex;align-items:center;gap:8px;">
                <span style="font-size:18px;">‚≠ê</span>
                <span style="font-weight:600;color:#856404;">‡¶™‡ßç‡¶∞‡¶ö‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</span>
              </div>
              <div style="display:flex;align-items:center;gap:8px;">
                <span style="font-weight:600;color:#856404;">‡¶®‡¶∞‡¶Æ‡¶æ‡¶≤ ‡¶°‡¶ø‡¶™‡ßã‡¶ú‡¶ø‡¶ü</span>
                <span style="font-size:12px;">‚ñº</span>
              </div>
            </div>
          </div>
          
          <!-- Payment Methods -->
          <div style="margin-bottom:20px;">
            <div style="font-size:16px;font-weight:600;color:#2c3e50;margin-bottom:15px;">| ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø</div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;">
              <div onclick="selectPaymentMethod('bkash')" id="payment-bkash" class="payment-option" style="border:3px solid #1877f2;background:#1877f2;border-radius:8px;padding:15px;text-align:center;cursor:pointer;position:relative;">
                <div style="font-size:24px;margin-bottom:5px;color:#fff;">üíñ</div>
                <div style="font-size:12px;font-weight:600;color:#fff;">‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂</div>
                <div style="position:absolute;bottom:5px;right:5px;color:#fff;">‚úì</div>
              </div>
              <div onclick="selectPaymentMethod('nagad')" id="payment-nagad" class="payment-option" style="border:2px solid #e4e6ea;background:#fff;border-radius:8px;padding:15px;text-align:center;cursor:pointer;">
                <div style="font-size:24px;margin-bottom:5px;">üü†</div>
                <div style="font-size:12px;font-weight:600;color:#65676b;">‡¶®‡¶ó‡¶¶</div>
              </div>
              <div onclick="selectPaymentMethod('rocket')" id="payment-rocket" class="payment-option" style="border:2px solid #e4e6ea;background:#fff;border-radius:8px;padding:15px;text-align:center;cursor:pointer;">
                <div style="font-size:24px;margin-bottom:5px;">üü£</div>
                <div style="font-size:12px;font-weight:600;color:#65676b;">‡¶∞‡¶ï‡ßá‡¶ü</div>
              </div>
              <div onclick="selectPaymentMethod('upay')" id="payment-upay" class="payment-option" style="border:2px solid #e4e6ea;background:#fff;border-radius:8px;padding:15px;text-align:center;cursor:pointer;">
                <div style="font-size:24px;margin-bottom:5px;">üü°</div>
                <div style="font-size:12px;font-weight:600;color:#65676b;">UPay</div>
              </div>
              <div onclick="selectPaymentMethod('bank')" id="payment-bank" class="payment-option" style="border:2px solid #e4e6ea;background:#fff;border-radius:8px;padding:15px;text-align:center;cursor:pointer;">
                <div style="font-size:24px;margin-bottom:5px;">üè¶</div>
                <div style="font-size:12px;font-weight:600;color:#65676b;">‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï</div>
              </div>
              <div onclick="selectPaymentMethod('usdt_trc20')" id="payment-usdt_trc20" class="payment-option" style="border:2px solid #e4e6ea;background:#fff;border-radius:8px;padding:15px;text-align:center;cursor:pointer;">
                <div style="font-size:24px;margin-bottom:5px;">üî∫</div>
                <div style="font-size:12px;font-weight:600;color:#65676b;">USDT TRC20</div>
              </div>
            </div>
          </div>
          
          <div style="display:flex;gap:10px;">
            <button onclick="closeDepositModal()" style="flex:1;background:#95a5a6;color:#fff;border:none;padding:12px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
            <button onclick="showDepositTab(2)" style="flex:1;background:linear-gradient(135deg, #1877f2 0%, #42a5f5 100%);color:#fff;border:none;padding:12px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;">‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ</button>
          </div>
        </div>
        
        <!-- Tab 2: Amount -->
        <div id="depositTabContent2" style="display:none;">
          <!-- Deposit Channel -->
          <div style="margin-bottom:20px;">
            <div style="font-size:16px;font-weight:600;color:#2c3e50;margin-bottom:15px;">| ‡¶°‡¶ø‡¶™‡ßã‡¶ú‡¶ø‡¶ü ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</div>
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;">
              <div onclick="selectDepositChannel('jp')" id="channel-jp" class="channel-option" style="border:3px solid #1877f2;background:#1877f2;border-radius:8px;padding:15px;text-align:center;cursor:pointer;position:relative;">
                <div style="display:flex;align-items:center;justify-content:center;gap:5px;margin-bottom:5px;">
                  <span style="color:#fff;">üëç</span>
                  <span style="font-weight:600;color:#fff;">JP-‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶â‡¶ü</span>
                </div>
                <div style="position:absolute;bottom:5px;right:5px;color:#fff;">‚úì</div>
              </div>
              <div onclick="selectDepositChannel('ap')" id="channel-ap" class="channel-option" style="border:2px solid #e4e6ea;background:#fff;border-radius:8px;padding:15px;text-align:center;cursor:pointer;">
                <div style="font-weight:600;color:#65676b;">AP-‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶â‡¶ü</div>
              </div>
              <div onclick="selectDepositChannel('ct')" id="channel-ct" class="channel-option" style="border:2px solid #e4e6ea;background:#fff;border-radius:8px;padding:15px;text-align:center;cursor:pointer;">
                <div style="font-weight:600;color:#65676b;">CT-‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶â‡¶ü</div>
              </div>
              <div onclick="selectDepositChannel('sp')" id="channel-sp" class="channel-option" style="border:2px solid #e4e6ea;background:#fff;border-radius:8px;padding:15px;text-align:center;cursor:pointer;">
                <div style="font-weight:600;color:#65676b;">SP-‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶â‡¶ü</div>
              </div>
              <div onclick="selectDepositChannel('send')" id="channel-send" class="channel-option" style="border:2px solid #e4e6ea;background:#fff;border-radius:8px;padding:15px;text-align:center;cursor:pointer;">
                <div style="font-weight:600;color:#65676b;">‡¶∏‡ßá‡¶®‡ßç‡¶° ‡¶Æ‡¶æ‡¶®‡¶ø</div>
              </div>
              <div onclick="selectDepositChannel('payment')" id="channel-payment" class="channel-option" style="border:2px solid #e4e6ea;background:#fff;border-radius:8px;padding:15px;text-align:center;cursor:pointer;">
                <div style="font-weight:600;color:#65676b;">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü</div>
              </div>
            </div>
          </div>
          
          <!-- Amount Selection -->
          <div style="margin-bottom:20px;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:15px;">
              <div style="font-size:16px;font-weight:600;color:#2c3e50;">| ‡¶è‡¶Æ‡¶æ‡¶â‡¶®‡ßç‡¶ü</div>
              <div style="font-size:14px;color:#7f8c8d;">‡ß≥ 100.00 - ‡ß≥ 15,000.00</div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:15px;">
              <button onclick="selectAmount(100)" class="amount-btn" style="border:2px solid #e4e6ea;background:#fff;border-radius:8px;padding:10px;font-size:14px;font-weight:600;cursor:pointer;">100</button>
              <button onclick="selectAmount(15000)" class="amount-btn" style="border:2px solid #e4e6ea;background:#fff;border-radius:8px;padding:10px;font-size:14px;font-weight:600;cursor:pointer;">15,000</button>
            </div>
            <div style="border:2px solid #e4e6ea;border-radius:8px;padding:15px;background:#f8f9fa;">
              <div style="display:flex;align-items:center;gap:10px;">
                <span style="font-size:18px;font-weight:700;color:#2c3e50;">‡ß≥</span>
                <input type="number" id="customAmount" placeholder="0.00" style="flex:1;border:none;background:transparent;font-size:16px;font-weight:600;color:#2c3e50;outline:none;" min="100" max="15000" oninput="updateCustomAmount(this.value)" onblur="updateCustomAmount(this.value)" onchange="updateCustomAmount(this.value)">
              </div>
            </div>
          </div>
          
          <div style="display:flex;gap:10px;">
            <button onclick="showDepositTab(1)" style="flex:1;background:#95a5a6;color:#fff;border:none;padding:12px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;">‡¶™‡¶ø‡¶õ‡¶®‡ßá</button>
            <button onclick="showDepositTab(3)" style="flex:1;background:linear-gradient(135deg, #1877f2 0%, #42a5f5 100%);color:#fff;border:none;padding:12px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;">‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ</button>
          </div>
        </div>
        
        <!-- Tab 3: Submit -->
        <div id="depositTabContent3" style="display:none;">
          <!-- Instructions -->
          <div style="background:#e3f2fd;border:1px solid #2196f3;border-radius:8px;padding:15px;margin-bottom:20px;">
            <div style="display:flex;align-items:flex-start;gap:10px;">
              <div style="background:#2196f3;color:#fff;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0;margin-top:2px;">i</div>
              <div style="font-size:14px;color:#1565c0;line-height:1.5;">
                <div style="font-weight:600;margin-bottom:10px;">‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂‡¶®‡¶æ:</div>
                <div style="margin-bottom:8px;">‡ßß/‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶§‡¶•‡ßç‡¶Ø"-‡¶è‡¶∞ ‡¶Ö‡¶ß‡ßÄ‡¶®‡ßá ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá ‡¶∏‡¶∞‡ßç‡¶¨‡ßã‡¶ö‡ßç‡¶ö ‡ß©‡¶ü‡¶ø ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶æ‡¶á ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</div>
                <div style="margin-bottom:8px;">‡ß®/‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶°‡¶ø‡¶™‡ßã‡¶ú‡¶ø‡¶ü ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶∏‡¶´‡¶≤ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶â‡¶ü ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞, ‡¶è‡¶Æ‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶Ü‡¶á‡¶°‡¶ø ‡¶∏‡¶π ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶¶‡¶ø‡¶®‡•§</div>
                <div style="margin-bottom:8px;">‡ß©/‡¶Ø‡ßá‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶ø‡¶™‡ßã‡¶ú‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá ‡¶∏‡¶¨‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶°‡¶ø‡¶™‡ßã‡¶ú‡¶ø‡¶ü ‡¶™‡ßá‡¶á‡¶ú‡ßá ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</div>
                <div style="margin-bottom:8px;">‡ß™/‡¶°‡¶ø‡¶™‡ßã‡¶ú‡¶ø‡¶ü ‡¶™‡ßá‡¶®‡ßç‡¶°‡¶ø‡¶Ç ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶Ø‡¶º ‡¶Ü‡¶™‡¶®‡¶ø ‡ß®‡¶ü‡¶ø ‡¶°‡¶ø‡¶™‡ßã‡¶ú‡¶ø‡¶ü ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ü‡ßç‡¶∞‡¶æ‡¶á ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§</div>

              </div>
            </div>
          </div>
          
          <!-- Transaction Details -->
          <div style="background:#f8f9fa;border-radius:8px;padding:15px;margin-bottom:20px;">
            <div style="font-size:16px;font-weight:600;color:#2c3e50;margin-bottom:15px;">‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</div>
            <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
              <span style="color:#7f8c8d;">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø:</span>
              <span id="selectedPaymentMethod" style="font-weight:600;color:#2c3e50;">‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
              <span style="color:#7f8c8d;">‡¶°‡¶ø‡¶™‡ßã‡¶ú‡¶ø‡¶ü ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤:</span>
              <span id="selectedDepositChannel" style="font-weight:600;color:#2c3e50;">JP-‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ü‡¶â‡¶ü</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
              <span style="color:#7f8c8d;">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£:</span>
              <span id="selectedAmount" style="font-weight:600;color:#2c3e50;">‡ß≥0.00</span>
            </div>
          </div>
          
          <div style="display:flex;gap:10px;">
            <button onclick="showDepositTab(2)" style="flex:1;background:#95a5a6;color:#fff;border:none;padding:12px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;">‡¶™‡¶ø‡¶õ‡¶®‡ßá</button>
            <button onclick="processDeposit()" style="flex:1;background:linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);color:#fff;border:none;padding:12px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;">‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü</button>
          </div>
        </div>
        
      </div>
    </div>
  </div>
  
<!-- Withdraw Modal -->
<div id="withdrawModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.8);z-index:9999999;backdrop-filter:blur(5px);pointer-events:auto;overflow:hidden;">
  <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border-radius:16px;padding:0;width:95%;max-width:450px;box-shadow:0 20px 60px rgba(0,0,0,0.3);overflow:hidden;">
    
    <!-- Header -->
    <div style="background:linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);padding:20px;color:#fff;">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div style="display:flex;align-items:center;gap:10px;">
          <span style="font-size:24px;">üí∏</span>
          <h2 style="margin:0;font-size:20px;font-weight:700;">‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞</h2>
        </div>
        <button onclick="closeWithdrawModal()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#fff;">√ó</button>
      </div>
    </div>
    
    <!-- Content -->
    <div style="padding:25px;">
      
      <!-- Tab Navigation -->
      <div style="display:flex;gap:8px;margin-bottom:25px;">
        <button id="withdrawTab1" onclick="showWithdrawTab(1)" style="flex:1;background:#1877f2;color:#fff;border:none;padding:12px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø</button>
        <button id="withdrawTab2" onclick="showWithdrawTab(2)" style="flex:1;background:#e4e6ea;color:#65676b;border:none;padding:12px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;">‡¶è‡¶Æ‡¶æ‡¶â‡¶®‡ßç‡¶ü</button>
        <button id="withdrawTab3" onclick="showWithdrawTab(3)" style="flex:1;background:#e4e6ea;color:#65676b;border:none;padding:12px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;">‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü</button>
      </div>
      
      <!-- Tab 1: Payment Method -->
      <div id="withdrawTabContent1" style="display:block;">
        <div style="margin-bottom:25px;">
          <h3 style="color:#2c3e50;font-size:16px;margin:0 0 15px 0;">| ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø</h3>
          
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;">
            <button id="withdraw-bkash" onclick="selectWithdrawMethod('bkash')" style="border:2px solid #e4e6ea;background:#fff;border-radius:12px;padding:15px;cursor:pointer;text-align:center;transition:all 0.3s ease;">
              <div style="color:#e2136e;font-size:18px;font-weight:700;margin-bottom:5px;">bKash</div>
              <div style="font-weight:600;color:#2c3e50;font-size:14px;">‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂</div>
            </button>
            
            <button id="withdraw-nagad" onclick="selectWithdrawMethod('nagad')" style="border:2px solid #e4e6ea;background:#fff;border-radius:12px;padding:15px;cursor:pointer;text-align:center;transition:all 0.3s ease;">
              <div style="color:#f7941d;font-size:18px;font-weight:700;margin-bottom:5px;">Nagad</div>
              <div style="font-weight:600;color:#2c3e50;font-size:14px;">‡¶®‡¶ó‡¶¶</div>
            </button>
            
            <button id="withdraw-rocket" onclick="selectWithdrawMethod('rocket')" style="border:2px solid #e4e6ea;background:#fff;border-radius:12px;padding:15px;cursor:pointer;text-align:center;transition:all 0.3s ease;">
              <div style="color:#f7941d;font-size:18px;font-weight:700;margin-bottom:5px;">Rocket</div>
              <div style="font-weight:600;color:#2c3e50;font-size:14px;">‡¶∞‡¶ï‡ßá‡¶ü</div>
            </button>
            
            <button id="withdraw-upay" onclick="selectWithdrawMethod('upay')" style="border:2px solid #e4e6ea;background:#fff;border-radius:12px;padding:15px;cursor:pointer;text-align:center;transition:all 0.3s ease;">
              <div style="color:#0066cc;font-size:18px;font-weight:700;margin-bottom:5px;">UPay</div>
              <div style="font-weight:600;color:#2c3e50;font-size:14px;">UPay</div>
            </button>
          </div>
        </div>
        
        <div style="display:flex;gap:10px;">
          <button onclick="closeWithdrawModal()" style="flex:1;background:#95a5a6;color:#fff;border:none;padding:12px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
          <button onclick="showWithdrawTab(2)" style="flex:1;background:linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);color:#fff;border:none;padding:12px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;">‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‚Üí</button>
        </div>
      </div>
      
      <!-- Tab 2: Amount -->
      <div id="withdrawTabContent2" style="display:none;">
        <div style="margin-bottom:25px;">
          <h3 style="color:#2c3e50;font-size:16px;margin:0 0 15px 0;">| ‡¶è‡¶Æ‡¶æ‡¶â‡¶®‡ßç‡¶ü</h3>
          
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px;">
            <button id="withdraw-amount-100" onclick="selectWithdrawAmount(100)" style="border:2px solid #e4e6ea;background:#fff;border-radius:8px;padding:12px;cursor:pointer;text-align:center;font-weight:600;color:#65676b;font-size:14px;">100</button>
            <button id="withdraw-amount-200" onclick="selectWithdrawAmount(200)" style="border:2px solid #e4e6ea;background:#fff;border-radius:8px;padding:12px;cursor:pointer;text-align:center;font-weight:600;color:#65676b;font-size:14px;">200</button>
            <button id="withdraw-amount-500" onclick="selectWithdrawAmount(500)" style="border:2px solid #e4e6ea;background:#fff;border-radius:8px;padding:12px;cursor:pointer;text-align:center;font-weight:600;color:#65676b;font-size:14px;">500</button>
            <button id="withdraw-amount-1000" onclick="selectWithdrawAmount(1000)" style="border:2px solid #e4e6ea;background:#fff;border-radius:8px;padding:12px;cursor:pointer;text-align:center;font-weight:600;color:#65676b;font-size:14px;">1,000</button>
            <button id="withdraw-amount-2000" onclick="selectWithdrawAmount(2000)" style="border:2px solid #e4e6ea;background:#fff;border-radius:8px;padding:12px;cursor:pointer;text-align:center;font-weight:600;color:#65676b;font-size:14px;">2,000</button>
            <button id="withdraw-amount-5000" onclick="selectWithdrawAmount(5000)" style="border:2px solid #e4e6ea;background:#fff;border-radius:8px;padding:12px;cursor:pointer;text-align:center;font-weight:600;color:#65676b;font-size:14px;">5,000</button>
          </div>
          
          <div style="margin-bottom:20px;">
            <label style="display:block;font-size:16px;font-weight:600;color:#2c3e50;margin-bottom:8px;">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶è‡¶Æ‡¶æ‡¶â‡¶®‡ßç‡¶ü</label>
            <input type="number" id="withdrawCustomAmount" placeholder="‡¶è‡¶Æ‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®" style="width:100%;padding:12px;border:2px solid #e4e6ea;border-radius:8px;font-size:16px;box-sizing:border-box;font-weight:600;color:#2c3e50;" min="100" max="15000">
          </div>
        </div>
        
        <div style="display:flex;gap:10px;">
          <button onclick="showWithdrawTab(1)" style="flex:1;background:#95a5a6;color:#fff;border:none;padding:12px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;">‡¶™‡¶ø‡¶õ‡¶®‡ßá</button>
          <button onclick="showWithdrawTab(3)" style="flex:1;background:linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);color:#fff;border:none;padding:12px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;">‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‚Üí</button>
        </div>
      </div>
      
      <!-- Tab 3: Submit -->
      <div id="withdrawTabContent3" style="display:none;">
        <div style="margin-bottom:25px;">
          <h3 style="color:#2c3e50;font-size:16px;margin:0 0 15px 0;">| ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü</h3>
          
          <div style="margin-bottom:20px;">
            <label style="display:block;font-size:16px;font-weight:600;color:#2c3e50;margin-bottom:8px;">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞</label>
            <input type="text" id="withdrawAccount" placeholder="01XXXXXXXXX" style="width:100%;padding:12px;border:2px solid #e4e6ea;border-radius:8px;font-size:16px;box-sizing:border-box;">
          </div>
          
          <div style="background:#f8f9fa;padding:20px;border-radius:12px;margin-bottom:20px;">
            <h4 style="margin:0 0 15px 0;color:#2c3e50;">‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶®‡ßá‡¶∞ ‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂</h4>
            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
              <span>‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø:</span>
              <span id="withdrawSummaryMethod">‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
              <span>‡¶è‡¶Æ‡¶æ‡¶â‡¶®‡ßç‡¶ü:</span>
              <span id="withdrawSummaryAmount">‡ß≥0.00</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
              <span>‡¶ï‡¶Æ‡¶ø‡¶∂‡¶® (‡ß®%):</span>
              <span id="withdrawSummaryCommission">-‡ß≥0.00</span>
            </div>
            <hr style="margin:10px 0;">
            <div style="display:flex;justify-content:space-between;font-weight:600;">
              <span>‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶Æ‡¶æ‡¶â‡¶®‡ßç‡¶ü:</span>
              <span id="withdrawSummaryFinal">‡ß≥0.00</span>
            </div>
          </div>
        </div>
        
        <div style="display:flex;gap:10px;">
          <button onclick="showWithdrawTab(2)" style="flex:1;background:#95a5a6;color:#fff;border:none;padding:12px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;">‡¶™‡¶ø‡¶õ‡¶®‡ßá</button>
          <button onclick="processWithdraw()" style="flex:1;background:linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);color:#fff;border:none;padding:12px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;">‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü</button>
        </div>
      </div>
      
    </div>
  </div>
</div>

<script>
// File Payment Functions

// DXF Download Function with Payment
async function downloadDXFFile(url, filename, price = 0, uploader = null) {
  const currentUser = localStorage.getItem('profileName') || 'User Name';
  
  // If no price, download directly
  if (!price || price <= 0) {
    const link = document.createElement('a');
    link.href = url;
    link.download = filename + '.dxf';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    return;
  }
  
  // Check if user is trying to download their own file
  if (uploader === currentUser) {
    const link = document.createElement('a');
    link.href = url;
    link.download = filename + '.dxf';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    return;
  }
  
  // Show payment confirmation
  const confirmPayment = confirm(`‡¶è‡¶á DXF ‡¶´‡¶æ‡¶á‡¶≤ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ${price} ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡•§\n\n‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ï‡¶æ‡¶ü‡¶æ ‡¶π‡¶¨‡ßá ‡¶è‡¶¨‡¶Ç ‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶≤‡ßã‡¶°‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶ï‡¶æ‡¶õ‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá‡•§\n\n‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`);
  
  if (!confirmPayment) {
    return;
  }
  
      try {
      // Process payment
      const paymentResult = await processFilePayment(currentUser, uploader, price, 'DXF', filename, url);
      
             if (paymentResult.success) {
         // Extract filename from URL for secure download
         const urlParts = url.split('/');
         const serverFilename = urlParts[urlParts.length - 1];
         
         // Create secure download URL with payment verification
         const downloadUrl = `${BASE_URL}/download/${serverFilename}?buyer=${encodeURIComponent(currentUser)}&seller=${encodeURIComponent(uploader)}&amount=${price}&fileType=DXF`;
         
         // Download the file using secure endpoint
         try {
           const link = document.createElement('a');
           link.href = downloadUrl;
           link.download = filename + '.dxf';
           link.style.display = 'none';
           document.body.appendChild(link);
           link.click();
           document.body.removeChild(link);
           
           // Also try opening in new tab as fallback
           setTimeout(() => {
             window.open(downloadUrl, '_blank');
           }, 100);
         } catch (downloadError) {
           console.error('Download error:', downloadError);
           // Fallback: open in new tab
           window.open(downloadUrl, '_blank');
         }
      
      // Show success message
      alert(`‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!\n\n${price} ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ï‡¶æ‡¶ü‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá ‡¶è‡¶¨‡¶Ç ${uploader} ‡¶è‡¶∞ ‡¶ï‡¶æ‡¶õ‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§\n‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: ‡ß≥${paymentResult.newBalance.toLocaleString()}`);
      
      // Refresh user balance
      if (typeof updateUserBalance === 'function') {
        updateUserBalance();
      }
    } else {
      alert(`‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ${paymentResult.error}`);
    }
  } catch (error) {
    console.error('Payment error:', error);
    alert('‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶Ø‡¶º ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
  }
}

  // 3D Download Function with Payment
  async function download3DFile(url, filename, price = 0, uploader = null) {
    const currentUser = localStorage.getItem('profileName') || 'User Name';
    
    // If no price, download directly
    if (!price || price <= 0) {
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      return;
    }
    
    // Check if user is trying to download their own file
    if (uploader === currentUser) {
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      return;
    }
    
    // Show payment confirmation
    const confirmPayment = confirm(`‡¶è‡¶á 3D ‡¶´‡¶æ‡¶á‡¶≤ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ${price} ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡•§\n\n‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ï‡¶æ‡¶ü‡¶æ ‡¶π‡¶¨‡ßá ‡¶è‡¶¨‡¶Ç ‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶≤‡ßã‡¶°‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶ï‡¶æ‡¶õ‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá‡•§\n\n‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`);
    
    if (!confirmPayment) {
      return;
    }
    
    try {
      // Process payment
      const paymentResult = await processFilePayment(currentUser, uploader, price, '3D', filename, url);
      
      if (paymentResult.success) {
        // Extract filename from URL for secure download
        const urlParts = url.split('/');
        const serverFilename = urlParts[urlParts.length - 1];
        
        // Create secure download URL with payment verification
        const downloadUrl = `${BASE_URL}/download/${serverFilename}?buyer=${encodeURIComponent(currentUser)}&seller=${encodeURIComponent(uploader)}&amount=${price}&fileType=3D`;
        
        // Download the file using secure endpoint
        try {
          const link = document.createElement('a');
          link.href = downloadUrl;
          link.download = filename;
          link.style.display = 'none';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          // Also try opening in new tab as fallback
          setTimeout(() => {
            window.open(downloadUrl, '_blank');
          }, 100);
        } catch (downloadError) {
          console.error('Download error:', downloadError);
          // Fallback: open in new tab
          window.open(downloadUrl, '_blank');
        }
      
      // Show success message
      alert(`‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!\n\n${price} ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ï‡¶æ‡¶ü‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá ‡¶è‡¶¨‡¶Ç ${uploader} ‡¶è‡¶∞ ‡¶ï‡¶æ‡¶õ‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§\n‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: ‡ß≥${paymentResult.newBalance.toLocaleString()}`);
      
      // Refresh user balance
      if (typeof updateUserBalance === 'function') {
        updateUserBalance();
      }
    } else {
      alert(`‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ${paymentResult.error}`);
    }
  } catch (error) {
    console.error('Payment error:', error);
    alert('‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶Ø‡¶º ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
  }
}

// JD Download Function with Payment
async function downloadJDFile(url, filename, price = 0, uploader = null) {
  const currentUser = localStorage.getItem('profileName') || 'User Name';
  
  // If no price, download directly
  if (!price || price <= 0) {
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    return;
  }
  
  // Check if user is trying to download their own file
  if (uploader === currentUser) {
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    return;
  }
  
  // Show payment confirmation
  const confirmPayment = confirm(`‡¶è‡¶á JD ‡¶´‡¶æ‡¶á‡¶≤ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ${price} ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡•§\n\n‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ï‡¶æ‡¶ü‡¶æ ‡¶π‡¶¨‡ßá ‡¶è‡¶¨‡¶Ç ‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶≤‡ßã‡¶°‡¶ï‡¶æ‡¶∞‡ßÄ‡¶∞ ‡¶ï‡¶æ‡¶õ‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá‡•§\n\n‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?`);
  
  if (!confirmPayment) {
    return;
  }
  
      try {
      // Process payment
      const paymentResult = await processFilePayment(currentUser, uploader, price, 'JD', filename, url);
      
      if (paymentResult.success) {
        // Extract filename from URL for secure download
        const urlParts = url.split('/');
        const serverFilename = urlParts[urlParts.length - 1];
        
        // Create secure download URL with payment verification
        const downloadUrl = `${BASE_URL}/download/${serverFilename}?buyer=${encodeURIComponent(currentUser)}&seller=${encodeURIComponent(uploader)}&amount=${price}&fileType=JD`;
        
        // Download the file using secure endpoint
        try {
          const link = document.createElement('a');
          link.href = downloadUrl;
          link.download = filename;
          link.style.display = 'none';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          // Also try opening in new tab as fallback
          setTimeout(() => {
            window.open(downloadUrl, '_blank');
          }, 100);
        } catch (downloadError) {
          console.error('Download error:', downloadError);
          // Fallback: open in new tab
          window.open(downloadUrl, '_blank');
        }
      
      // Show success message
      alert(`‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!\n\n${price} ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ï‡¶æ‡¶ü‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá ‡¶è‡¶¨‡¶Ç ${uploader} ‡¶è‡¶∞ ‡¶ï‡¶æ‡¶õ‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§\n‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: ‡ß≥${paymentResult.newBalance.toLocaleString()}`);
      
      // Refresh user balance
      if (typeof updateUserBalance === 'function') {
        updateUserBalance();
      }
    } else {
      alert(`‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá: ${paymentResult.error}`);
    }
  } catch (error) {
    console.error('Payment error:', error);
    alert('‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶Ø‡¶º ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
  }
}

  // TD Download Function (alias for 3D)
  async function downloadTDFile(url, filename, price = 0, uploader = null) {
    return download3DFile(url, filename, price, uploader);
  }

  // Process file payment
  async function processFilePayment(buyer, seller, amount, fileType, filename, fileUrl) {
    try {
      console.log('Payment request data:', { buyer, seller, amount, fileType, filename, fileUrl });
      console.log('BASE_URL:', BASE_URL);
      
      const requestBody = {
        buyer: buyer,
        seller: seller,
        amount: parseFloat(amount),
        fileType: fileType,
        filename: filename,
        url: fileUrl,
        timestamp: Date.now()
      };
      
      console.log('Request body:', requestBody);
      
      const response = await fetch(`${BASE_URL}/file-payment`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestBody)
      });
      
      console.log('Response status:', response.status);
      console.log('Response ok:', response.ok);
    
      if (!response.ok) {
        const errorData = await response.json();
        console.error('Server error response:', errorData);
        return { success: false, error: errorData.error || 'Payment failed' };
      }
    
          const result = await response.json();
      console.log('Payment response:', result);
      return { success: true, newBalance: result.buyerBalance, fileUrl: result.fileUrl };
  } catch (error) {
    console.error('Payment processing error:', error);
    console.error('Error details:', error.message);
    return { success: false, error: 'Network error: ' + error.message };
  }
}
</script>

</body>
</html>